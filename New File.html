<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yourtube - Complete App</title>
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- CORE CSS --- */
        :root {
            --primary: #3ea6ff; 
            --primary-dark: #065fd4;
            --secondary: #eef4ff;
            --accent-red: #ff4e45;
            --accent-green: #00c851;
            --accent-purple: #a855f7;
            --accent-yellow: #ffbb33;
            --accent-orange: #ff8800;
            --white: #ffffff; 
            --black: #0f0f0f; 
            --text-main: #222222;
            --text-light: #606060;
            --border: #e0e0e0;
            --sidebar-w: 250px; 
            --header-h: 64px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.1);
            --bg-body: #f9f9f9;
            --bg-nav: rgba(255,255,255,0.95);
            --bg-studio: #f4f6f8;
            --card-gradient: linear-gradient(135deg, #ffffff, #fff176);
            --card-border-hover: rgba(255, 235, 59, 0.5);
        }

        /* --- NEW: Disable click/tap highlights (Accessibility Friendly) --- */
        * {
            -webkit-tap-highlight-color: transparent; /* Removes tap highlight on iOS/Android */
        }
        /* Removes the focus outline ONLY when an element is focused via mouse click */
        *:focus:not(:focus-visible) {
            outline: none;
        }

        /* --- DARK THEME VARIABLES --- */
        body.dark-mode {
            --primary: #3ea6ff;
            --primary-dark: #6ab5ff;
            --secondary: #262626;
            --white: #1f1f1f;
            --black: #ffffff;
            --text-main: #f1f1f1;
            --text-light: #aaaaaa;
            --border: #333333;
            --bg-body: #0f0f0f;
            --bg-nav: rgba(20,20,20,0.95);
            --bg-studio: #121212;
            --card-gradient: linear-gradient(135deg, #1e1e1e, #4a3b00); 
            --card-border-hover: rgba(255, 215, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
        
        /* FIX: Hide body until fully loaded to prevent flash */
        body.body-loading {
            opacity: 0;
        }
        body { 
            background: var(--bg-body); 
            color: var(--text-main); 
            overflow-x: hidden; 
            transition: background 0.3s, color 0.3s, opacity 0.2s ease-in; /* Added opacity transition */
        }
        button { cursor: pointer; border: none; background: none; font-family: inherit; transition: 0.25s ease; }
        a { text-decoration: none; color: inherit; cursor: pointer; }
        img { object-fit: cover; display: block; }
        
        /* --- NEW: Disable Unwanted Selection & Dragging --- */
        body {
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE10+/Edge */
            user-select: none;         /* Standard */
        }

        /* Re-enable selection for text content that users might want to copy */
        h1, h3, p, .desc-box, .comment-text, .ms-text, input, textarea, #w-chn-name, #sr-query-display {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* Prevent dragging images, which can look messy */
        img {
            -webkit-user-drag: none;
            user-drag: none;
        }
        
        /* SCROLLBAR - Updated to hide horizontal lines */
        ::-webkit-scrollbar { 
            width: 8px;   /* Vertical Width */
            height: 0px;  /* Horizontal Height - Set to 0 to hide the line */
            background: transparent;
        }

        /* Show vertical scrollbar only */
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 5px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--primary-dark); }

        /* Force hide scrollbars on all horizontal scrolling containers */
        .category-bar, 
        .sub-scroll-container, 
        .shorts-filter-bar, 
        .ph-scroll-box, 
        .shorts-scroll-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        .category-bar::-webkit-scrollbar, 
        .sub-scroll-container::-webkit-scrollbar, 
        .shorts-filter-bar::-webkit-scrollbar, 
        .ph-scroll-box::-webkit-scrollbar, 
        .shorts-scroll-container::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }

        /* --- NAVBAR --- */
        nav {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-h);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; background: var(--bg-nav); 
            backdrop-filter: blur(8px);
            z-index: 1000; box-shadow: var(--shadow-sm);
            border-bottom: 1px solid transparent;
        }
        body.dark-mode nav { border-bottom: 1px solid var(--border); }

        .nav-left { display: flex; align-items: center; gap: 16px; }
        .logo { display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 22px; letter-spacing: -0.5px; cursor: pointer; color: var(--black); }
        .logo span.material-symbols-rounded { font-size: 34px; background: linear-gradient(45deg, var(--primary-dark), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .nav-middle { flex: 1; max-width: 650px; margin: 0 20px; display: flex; justify-content: center; }
        .search-container { display: flex; width: 100%; max-width: 600px; height: 44px; border-radius: 50px; border: 1px solid var(--border); overflow: hidden; background: var(--white); box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); transition: 0.3s; }
        .search-container:focus-within { box-shadow: 0 2px 8px rgba(62, 166, 255, 0.2); border-color: var(--primary); }
        .search-container input { flex: 1; padding: 0 20px; border: none; outline: none; font-size: 15px; color: var(--text-main); background: transparent; }
        
        .search-btn { 
            width: 64px; background: var(--primary); border-left: 1px solid var(--primary); 
            display: flex; align-items: center; justify-content: center; color: #ffffff; 
        }
        .search-btn:hover { background: var(--primary-dark); color: #ffffff; }

        .nav-right { display: flex; align-items: center; gap: 12px; }
        .icon-btn { width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; border-radius: 50%; color: var(--text-main); transition: 0.2s; position: relative; }
        .icon-btn:hover { background: var(--secondary); color: var(--primary-dark); }
        .icon-btn .material-symbols-rounded { font-size: 26px; }
        
        .notif-badge { position: absolute; top: 6px; right: 6px; width: 10px; height: 10px; background: var(--accent-red); border-radius: 50%; display: none; border: 2px solid white; }
        /* FIX: Prevents navbar "jump" on load by reserving space for the auth button */
        #auth-section {
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-left { display: flex; align-items: center; gap: 16px; }
        /* Notification Dropdown */
        .notif-dropdown {
            position: absolute; top: 60px; right: 70px; width: 340px; background: var(--white);
            border-radius: 16px; box-shadow: var(--shadow-md);
            display: none; flex-direction: column; max-height: 400px; overflow-y: auto; z-index: 2000;
            animation: fadeIn 0.2s ease; border: 1px solid var(--border);
        }
        .notif-item { display: flex; gap: 12px; padding: 14px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .notif-item:hover { background: var(--secondary); }
        .notif-item img { width: 64px; height: 36px; border-radius: 6px; object-fit: cover; }

        .auth-btn { padding: 8px 18px; border: 1px solid var(--border); border-radius: 30px; color: var(--primary-dark); font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px; background: var(--white); transition: 0.2s; }
        .auth-btn:hover { background: var(--secondary); border-color: var(--primary); }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 15px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; top: var(--header-h); left: 0; bottom: 0;
            width: var(--sidebar-w); background: var(--white);
            overflow-y: auto; z-index: 900; padding: 16px 12px;
            transform: translateX(0); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 1px solid transparent;
        }
        .sidebar:hover { border-right: 1px solid var(--border); }
        .sidebar.closed { transform: translateX(-100%); }
        
        .menu-item { display: flex; align-items: center; gap: 20px; padding: 12px 16px; border-radius: 12px; cursor: pointer; margin-bottom: 4px; color: var(--text-main); font-weight: 500; font-size: 15px; }
        .menu-item:hover { background: var(--secondary); }
        .menu-item.active { background: var(--secondary); color: var(--primary-dark); font-weight: 600; }
        
        .menu-item .material-symbols-rounded { font-size: 26px; transition: 0.2s; }
        .menu-item:hover .material-symbols-rounded { transform: scale(1.1); }
        
        /* Sidebar Colors */
        .icon-home { color: var(--accent-red); }
        .icon-studio { color: var(--accent-yellow); }
        .icon-history { color: var(--accent-purple); }
        .icon-liked { color: var(--primary); }
        .icon-logout { color: var(--text-light); }

        .sub-header { margin: 24px 16px 12px; font-size: 15px; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        
        .sub-list-item { display: flex; align-items: center; gap: 14px; padding: 10px 16px; cursor: pointer; border-radius: 12px; transition: 0.2s; }
        .sub-list-item:hover { background: var(--secondary); }
        .sub-list-item img { width: 28px; height: 28px; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- MAIN CONTENT & CATEGORIES --- */
        .main-container {
            margin-top: var(--header-h); margin-left: var(--sidebar-w);
            padding: 30px; transition: margin-left 0.3s ease; min-height: 100vh;
        }
        .main-container.full { margin-left: 0; }
        
        /* CATEGORY BUBBLES */
        .category-bar {
            display: flex; gap: 12px; overflow-x: auto; padding-bottom: 12px; margin-bottom: 24px;
            scrollbar-width: none;
        }
        .category-bar::-webkit-scrollbar { display: none; }
        
        .cat-pill {
            white-space: nowrap; padding: 8px 20px; border-radius: 20px; 
            font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.3s;
            color: white; border: none; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .cat-pill:hover { transform: translateY(-2px); opacity: 0.9; }
        .cat-pill.active { transform: scale(1.05); box-shadow: 0 6px 15px rgba(0,0,0,0.2); border: 2px solid white; }

        .page-title { margin-bottom: 24px; font-size: 24px; font-weight: 700; display: none; color: var(--black); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; row-gap: 40px; }
        
        /* CARD */
        .card { 
            cursor: pointer; display: flex; flex-direction: column; gap: 12px; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background: var(--card-gradient);
            padding: 10px; border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid transparent;
        }
        .card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
            border-color: var(--card-border-hover);
        }
        .thumb-box { 
            position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 12px; 
            overflow: hidden; background: #eee; 
        }
        .thumb-box img { width: 100%; height: 100%; transition: 0.5s; }
        .card:hover .thumb-box img { transform: scale(1.05); }
        .dur-badge { 
            position: absolute; bottom: 8px; right: 8px; 
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6)); 
            backdrop-filter: blur(4px); color: white; padding: 4px 8px; 
            border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
        }
        
        .meta-flex { display: flex; gap: 14px; align-items: flex-start; padding: 4px; }
        .chn-avatar { width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.15); border: 2px solid white; }
        .meta-text h3 { font-size: 16px; font-weight: 600; line-height: 1.4; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color: var(--text-main); }
        .meta-text p { font-size: 13px; color: var(--text-light); margin-bottom: 2px; font-weight: 500; }

        /* --- WATCH PAGE (FULLSCREEN MOBILE STYLE) --- */
        .overlay-screen {
            position: fixed; 
            top: var(--header-h); 
            left: 0; width: 100%; 
            height: calc(100vh - var(--header-h));
            background: var(--bg-body); z-index: 1100; overflow-y: auto; display: none;
        }

        @media (max-width: 768px) {
            .overlay-screen#watch-view {
                top: 0 !important;
                height: 100vh !important;
                z-index: 3000 !important;
            }
            .watch-content { padding: 0 !important; }
        }

        .watch-content { max-width: 1100px; margin: 0 auto; padding: 30px; }

        /* --- CUSTOM VIDEO PLAYER (V2) --- */
        .player-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            position: relative;
            overflow: hidden;
            z-index: 10;
        }
        video#main-player {
            width: 100%;
            height: 100%;
            display: block;
        }
        /* Rule to help the browser render the video correctly in fullscreen */
        video:fullscreen {
            object-fit: contain;
        }
        .controls-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: linear-gradient(0deg, rgba(0,0,0,0.8), transparent);
            opacity: 1; /* Start visible */
            transition: opacity 0.3s;
            z-index: 21; /* Above video */
        }
        /* NEW: Class to hide controls on inactivity */
        .controls-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .progress-container {
            width: 100%;
            height: 8px;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
        }
        .progress-bar-bg {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            position: absolute;
            transition: height 0.2s ease;
            pointer-events: none;
        }
        .progress-container:hover .progress-bar-bg { height: 6px; }
        
        .progress-bar-filled {
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
            position: absolute;
            pointer-events: none;
            /* MODIFIED: Added a smooth, linear transition for the width property */
            transition: height 0.2s ease, width 0.1s linear;
        }

        /* NEW: This rule disables the smooth transition ONLY when the user is dragging the bar,
           making it feel responsive and snappy. */
        .player-container.scrubbing .progress-bar-filled {
            transition: height 0.2s ease; /* Keep height transition, but remove width transition */
        }
        
        .progress-container:hover .progress-bar-filled { height: 6px; }

        .progress-bar-filled::after {
            content: '';
            position: absolute;
            right: 0; 
            top: 50%;
            width: 15px;
            height: 15px;
            background-color: var(--primary);
            border-radius: 50%;
            transform: translate(50%, -50%);
            box-shadow: 0 0 8px rgba(62, 166, 255, 0.5);
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        
        .progress-container:hover .progress-bar-filled::after {
            opacity: 1;
            transform: translate(50%, -50%) scale(1.1);
        }
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        .controls-left, .controls-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .player-btn {
            background: none;
            border: none;
            color: white;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .volume-container { display: flex; align-items: center; gap: 8px; }
        input[type="range"].volume-slider {
            -webkit-appearance: none;
            width: 70px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            outline: none;
            transition: 0.2s;
        }
        input[type="range"].volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--primary);
            cursor: pointer;
            border-radius: 50%;
        }
        .time-display { font-size: 13px; font-weight: 500; min-width: 90px; }
        .float-back-btn {
            position: absolute; top: 10px; left: 10px;
            width: 36px; height: 36px;
            background: rgba(0,0,0,0.6); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; cursor: pointer; z-index: 22;
            backdrop-filter: blur(4px);
            /* NEW: Add smooth transition for the opacity */
            transition: opacity 0.3s ease;
        }

        /* --- NEW: Double-Tap Seek Animation Styles --- */
        .seek-layer {
            position: absolute; top: 0; bottom: 0; width: 40%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; z-index: 20; opacity: 0; pointer-events: none;
            background: rgba(255, 255, 255, 0.1);
            transition: opacity 0.2s;
        }
        .seek-layer.left { left: 0; border-top-right-radius: 50% 100%; border-bottom-right-radius: 50% 100%; }
        .seek-layer.right { right: 0; border-top-left-radius: 50% 100%; border-bottom-left-radius: 50% 100%; }
        
        .seek-layer.active { opacity: 1; animation: ripple-fade 0.6s linear; }
        
        .seek-icon-group { display: flex; align-items: center; margin-bottom: 4px; }
        .seek-icon-group .material-symbols-rounded { font-size: 32px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .seek-text { font-size: 14px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        @keyframes ripple-fade {
            0% { background: rgba(255, 255, 255, 0.05); }
            50% { background: rgba(255, 255, 255, 0.2); }
            100% { background: rgba(255, 255, 255, 0); }
        }

        /* --- NEW: 2x Speed Overlay --- */
        .speed-overlay {
            position: absolute; top: 20px; left: 0; right: 0; margin: auto;
            width: fit-content; padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7); border-radius: 20px;
            color: white; font-weight: 600; font-size: 14px;
            display: flex; align-items: center; gap: 8px;
            opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 25;
            backdrop-filter: blur(4px);
        }
        .speed-overlay.visible { opacity: 1; }
/* --- NEW: Mobile Top-Right Settings Button --- */
        .mobile-settings-btn {
            position: absolute;
            top: 10px;
            right: 10px; /* Stays at Top Right */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            display: none; /* HIDDEN BY DEFAULT (Desktop) */
            align-items: center;
            justify-content: center;
            z-index: 25; /* Above video, below Settings Menu (z:100) */
            backdrop-filter: blur(4px);
            border: none;
            transition: opacity 0.3s; 
        }

        /* Desktop Settings Button (Bottom Bar) */
        .desktop-settings-btn {
            display: flex; /* Visible by default on Desktop */
        }
        
        /* Hide when controls are hidden */
        .mobile-settings-btn.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Responsive Logic: Swap buttons on Mobile */
        @media (max-width: 768px) {
            .mobile-settings-btn { display: flex !important; }
            .desktop-settings-btn { display: none !important; }
        }
        .settings-menu {
            position: absolute;
            bottom: 60px; /* Anchored above the control bar */
            right: 12px;  /* Anchored to the right side */
            width: 300px; /* Fixed width for desktop feel */
            max-height: 480px;
            background: rgba(28, 28, 28, 0.95); /* Deep dark background */
            border-radius: 12px;
            color: #eee;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95); /* Slight zoom effect */
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
            backdrop-filter: blur(4px);
            overflow: hidden; /* Hide scrollbars for slick look */
            font-family: "Roboto", "Arial", sans-serif;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .settings-menu.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }

        /* Views (Main vs Submenus) */
        .sm-view {
            display: none;
            flex-direction: column;
            padding: 8px 0;
            width: 100%;
        }
        .sm-view.active { display: flex; animation: slideIn 0.2s ease; }

        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Header for Submenus */
        .sm-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 4px;
            cursor: pointer;
            color: #fff;
            font-size: 15px;
            font-weight: 500;
        }
        .sm-header:hover { background: rgba(255,255,255,0.1); }
        .sm-header .material-symbols-rounded { font-size: 20px; margin-right: 10px; }

        /* Menu Items */
        .sm-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.15s;
            color: #eee;
        }
        .sm-item:hover { background: rgba(255,255,255,0.1); }
        
        /* Left side of item (Icon + Text) */
        .sm-left { display: flex; align-items: center; gap: 12px; font-weight: 400; }
        .sm-left .material-symbols-rounded { font-size: 22px; color: #fff; }

        /* Right side of item (Value + Arrow) */
        .sm-right { display: flex; align-items: center; gap: 6px; font-size: 13px; color: #aaa; }
        .sm-right .material-symbols-rounded { font-size: 18px; }

        /* Toggle Switch (iOS/YT Style) */
        .toggle-switch {
            width: 40px;
            height: 24px;
            background: #555;
            border-radius: 12px;
            position: relative;
            transition: background 0.2s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        /* Active State */
        .toggle-switch.on { background: #3ea6ff; } /* YT Blue */
        .toggle-switch.on::after { transform: translateX(16px); }

        /* Checkmark for selected sub-items */
        .sm-check { opacity: 0; width: 20px; margin-right: 10px; color: #3ea6ff; font-size: 18px; }
        .sm-item.selected .sm-check { opacity: 1; }

        /* Update the controls overlay to be FIXED when the PARENT container is fullscreen */
.player-container:fullscreen .controls-overlay,
.player-container:-webkit-full-screen .controls-overlay {
    position: absolute; /* Relative to the fullscreen container */
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
}

/* Update the controls overlay to be FIXED when the PARENT container is fullscreen */
.player-container:fullscreen .controls-overlay,
.player-container:-webkit-full-screen .controls-overlay {
    position: absolute; /* Relative to the fullscreen container */
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
}

/* Ensure the player container takes up the whole screen when requested */
.player-container:fullscreen, 
.player-container:-webkit-full-screen {
    width: 100vw !important;
    height: 100vh !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    z-index: 99999 !important;
    background: #000;
}
/* --- NEW: Double-Tap Seek Animation Styles --- */
        /* Seek animation styles removed */
/* --- NEW: Mobile Settings Bottom Sheet --- */
        #mobile-settings-sheet-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5000; /* High z-index to cover everything */
            display: none; /* Hidden by default */
            pointer-events: none;
        }

        #mobile-settings-sheet-container.active {
            display: block;
            pointer-events: all;
        }
        
        /* The dark overlay behind the sheet */
        .ms-overlay {
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #mobile-settings-sheet-container.active .ms-overlay {
            opacity: 1;
        }
        
        /* The sheet itself that slides up */
        .ms-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-nav); /* Use nav background for consistency */
            backdrop-filter: blur(10px);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }
/* --- FIX: Mobile Settings Readability --- */
        
        /* Force the mobile sheet to use theme text colors instead of hardcoded white */
        .ms-sheet .sm-item, 
        .ms-sheet .sm-header {
            color: var(--text-main) !important;
        }

        /* Force icons inside the mobile sheet to match theme color */
        .ms-sheet .material-symbols-rounded {
            color: var(--text-main) !important;
        }

        /* Fix the "Right side" text (e.g. "Normal >") to use theme light color */
        .ms-sheet .sm-right {
            color: var(--text-light) !important;
        }

        /* Ensure hover/active states use theme variables */
        .ms-sheet .sm-item:hover, 
        .ms-sheet .sm-header:hover {
            background: var(--secondary) !important;
        }

        /* Keep the checkmark blue */
        .ms-sheet .sm-check {
            color: var(--primary) !important;
        }
        
        /* Ensure the border lines (if any) match the theme */
        .ms-sheet .sm-header,
        .ms-sheet .sm-item {
            border-bottom-color: var(--border);
        }
        #mobile-settings-sheet-container.active .ms-sheet {
            transform: translateY(0);
        }
        /* NEW: Central Play/Pause Indicator */
        .play-pause-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 80px;
            height: 80px;
            background: rgba(0,0,0,0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 21;
        }
        .play-pause-indicator.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .play-pause-indicator .material-symbols-rounded { font-size: 48px; }

        iframe { width: 100%; height: 100%; border: none; }
        
        .vid-info h1 { font-size: 22px; margin: 16px 0 10px; font-weight: 700; color: var(--black); }
        .actions-bar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px; }
        .chn-actions { display: flex; align-items: center; gap: 14px; }
        
        .sub-btn { background: var(--black); color: var(--bg-body); padding: 0 24px; height: 44px; border-radius: 30px; font-weight: 600; font-size: 14px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .sub-btn:hover { opacity: 0.9; transform: scale(1.03); }
        .sub-btn.subscribed { background: var(--secondary); color: var(--primary-dark); box-shadow: none; border: 1px solid rgba(0,0,0,0.05); }
        
        .btn-pill { display: flex; align-items: center; gap: 8px; background: var(--secondary); height: 44px; padding: 0 20px; border-radius: 22px; font-size: 14px; font-weight: 600; transition: 0.2s; color: var(--text-main); }
        .btn-pill:hover { background: var(--border); }
        .btn-pill .material-symbols-rounded { font-size: 22px; }
        
        .btn-like .material-symbols-rounded { color: var(--primary); }
        .btn-dislike .material-symbols-rounded { color: var(--accent-red); }
        .btn-share .material-symbols-rounded { color: var(--accent-orange); }
        .btn-pill.active { background: linear-gradient(135deg, var(--secondary), #d0e0ff); color: var(--primary-dark); border: 1px solid rgba(62,166,255,0.2); }
.btn-pill.active { background: linear-gradient(135deg, var(--secondary), #d0e_0ff); color: var(--primary-dark); border: 1px solid rgba(62,166,255,0.2); }



NEW: Fix for native iframe fullscreen being trapped by parent elements */
        iframe:fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 99999 !important;
            border: none !important;
        }

        /* NEW: Styles for channel name and its container */
        .chn-actions > div {
            flex-shrink: 1; /* Allow the container to shrink */
            min-width: 0;   /* CRITICAL: Allows shrinking below content size */
            margin-right: 12px; /* Add some space between name and subscribe button */
        }
        #w-chn-name {
            white-space: nowrap;      /* Prevent text from wrapping */
            overflow: hidden;         /* Hide the overflowing text */
            text-overflow: ellipsis;  /* Add "..." at the end */
        }

        .desc-box { background: var(--secondary); padding: 20px; border-radius: 16px; margin-top: 24px; font-size: 14px; white-space: pre-wrap; cursor:pointer; color: var(--text-main); border: 1px solid var(--border); }
/* Ensure nothing traps the video when it goes fullscreen */
        .player-wrapper iframe:fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
        }

        /* Comments */
        .comments-section { margin-top: 30px; max-width: 1100px; }
        .comment-input-area { display: flex; gap: 16px; margin-bottom: 30px; align-items: flex-start; }
        .comment-input-area input { width: 100%; border: none; border-bottom: 1px solid #ddd; outline: none; padding: 8px 0; font-size: 15px; transition: 0.3s; background: transparent; color: var(--text-main); }
        /* NEW: Fix for comment input area overflow */
        .comment-input-area > div {
            flex: 1; /* Take up remaining space */
            min-width: 0; /* CRITICAL: Allows the container to shrink below its content's default minimum size */
        }
        .comment-item { display: flex; gap: 16px; margin-bottom: 24px; }
        .comment-meta { display: flex; gap: 8px; font-size: 13px; margin-bottom: 4px; align-items: center; }
        .comment-author { font-weight: 600; font-size: 14px; color: var(--black); }
        .comment-text { font-size: 14px; line-height: 1.5; color: var(--text-main); }

        /* --- STUDIO & ANALYTICS --- */
        .studio-layout { display: flex; height: 100%; background: var(--bg-studio); }
        .studio-nav { width: 250px; border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; gap: 12px; background: var(--white); }
        .studio-main { flex: 1; padding: 40px; overflow-y: auto; }
        
        .st-card { background: var(--white); border: none; border-radius: 16px; padding: 28px; margin-bottom: 24px; box-shadow: var(--shadow-sm); }
        .st-stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; margin-bottom: 30px; }
        
        .stat-box { 
            padding: 24px; border-radius: 16px; text-align: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: 0.2s; border: none; color: white; 
        }
        .stat-box:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .stat-box h2 { color: white; font-size: 36px; font-weight: 700; margin-bottom: 5px; }
        .stat-box p { color: rgba(255,255,255,0.9); font-weight: 500; }
        
        .stat-box:nth-child(1) { background: linear-gradient(135deg, #3ea6ff, #065fd4); }
        .stat-box:nth-child(2) { background: linear-gradient(135deg, #ff8800, #ff4e45); }
        .stat-box:nth-child(3) { background: linear-gradient(135deg, #00c851, #007e33); }

        .video-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 10px; }
        .video-table th { text-align: left; color: var(--text-light); font-size: 12px; font-weight: 600; padding: 10px 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        .video-table td { padding: 14px 15px; background: var(--secondary); vertical-align: middle; font-size: 14px; border-top: 1px solid var(--bg-studio); border-bottom: 1px solid var(--bg-studio); color: var(--text-main); }
        .video-table tr td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; border-left: 1px solid var(--bg-studio); }
        .video-table tr td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; border-right: 1px solid var(--bg-studio); }
        .video-table tr:hover td { background: var(--bg-studio); }
        
        .action-icon { padding: 8px; border-radius: 50%; transition: 0.2s; background: var(--white); margin-right: 4px; }
        .action-icon:hover { transform: scale(1.1); }
        .action-icon.view { color: var(--accent-green); }
        .action-icon.view:hover { background: #e8f5e9; }
        .action-icon.edit { color: var(--accent-purple); }
        .action-icon.edit:hover { background: #f3e5f5; }
        .action-icon.delete { color: var(--accent-red); }
        .action-icon.delete:hover { background: #ffebee; }

        /* Modal */
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--white); width: 90%; max-width: 500px; padding: 32px; border-radius: 20px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: scaleUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes scaleUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .inp-group { margin-bottom: 18px; }
        .inp-group label { display: block; font-size: 13px; color: var(--text-light); margin-bottom: 6px; font-weight: 600; }
        .inp-group input, .inp-group textarea, .inp-group select { width: 100%; padding: 12px 14px; border: 1px solid var(--border); border-radius: 8px; outline: none; font-size: 14px; background: var(--secondary); color: var(--text-main); transition: 0.2s; }
        .inp-group input:focus, .inp-group textarea:focus, .inp-group select:focus { border-color: var(--primary); background: var(--white); box-shadow: 0 0 0 3px rgba(62, 166, 255, 0.15); }
        
        .btn-primary { width: 100%; background: linear-gradient(90deg, var(--primary-dark), var(--primary)); color: white; padding: 12px; border-radius: 8px; font-weight: 600; text-transform: uppercase; font-size: 14px; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(6, 95, 212, 0.3); transition: 0.3s; }
        .btn-primary:hover { box-shadow: 0 6px 16px rgba(6, 95, 212, 0.4); transform: translateY(-1px); }

        .google-btn {
            width: 100%; margin-top: 12px; padding: 12px; border-radius: 8px;
            background: var(--white); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; gap: 10px;
            font-weight: 600; color: var(--text-light); font-size: 14px; cursor: pointer; transition: 0.2s;
        }
        .google-btn:hover { background: var(--secondary); border-color: var(--border); }
        .google-icon { width: 20px; height: 20px; }

        /* NEW: Progress Bar Styles */
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: var(--secondary);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            border-radius: 4px;
            transition: width 0.3s ease-in-out;
        }
        
        /* Analytics Charts */
        .chart-wrapper { position: relative; height: 280px; width: 100%; margin-bottom: 30px; padding: 15px; background: var(--white); border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
        .green-bar-chart { border-bottom: none; }

        @keyframes fadeIn { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
        
        /* --- DESKTOP SEARCH SUGGESTIONS DROPUP --- */
        #desktop-suggestions {
            position: absolute;
            top: var(--header-h); /* Place it below the navbar */
            left: 0;
            right: 0;
            margin: auto; /* Required for max-width to center it */
            max-width: 650px; /* Matches nav-middle width constraint */
            background: var(--white);
            border-radius: 0 0 16px 16px;
            box-shadow: var(--shadow-md);
            z-index: 990; /* Below Navbar (1000) */
            display: none; /* Hidden by default */
            border: 1px solid var(--border);
            border-top: none;
            overflow: hidden;
        }

        .ds-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            gap: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .ds-item:hover {
            background: var(--secondary);
        }

        .ds-icon {
            color: var(--text-light);
            font-size: 24px;
        }
        
        .ds-text {
            font-size: 15px;
            color: var(--text-main);
            font-weight: 500;
        }

        /* --- MOBILE OVERLAY (for sidebar) --- */
        .mobile-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 899; /* Below sidebar */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .mobile-overlay.show {
            opacity: 1;
            visibility: visible;
        }


        /* --- SKELETON LOADING --- */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: #e0e0e0;
            background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }
        body.dark-mode .skeleton {
            background: #2a2a2a;
            background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%);
        }
        .sk-card { display: flex; flex-direction: column; gap: 12px; }
        .sk-thumb { width: 100%; aspect-ratio: 16/9; border-radius: 12px; }
        .sk-meta { display: flex; gap: 14px; }
        .sk-avatar { width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; }
        .sk-text { flex: 1; display: flex; flex-direction: column; gap: 8px; padding-top: 4px; }
        .sk-line { height: 16px; border-radius: 4px; width: 90%; }
        .sk-line-sm { height: 14px; border-radius: 4px; width: 60%; }

        /* --- MOBILE RESPONSIVE --- */
        .mobile-search-trigger { display: none; }
        .bottom-nav { display: none; }

        @media (max-width: 768px) {
            .hide-on-mobile { display: none !important; }
            body.sidebar-open { overflow: hidden; }

            /* --- BOTTOM NAVIGATION --- */
            .bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%;
                height: 58px; background: var(--bg-nav); border-top: 1px solid var(--border);
                z-index: 4001; /* Increased to appear ON TOP of the Shorts viewer (z-index: 4000) */
                justify-content: space-around; align-items: center;
                padding-bottom: env(safe-area-inset-bottom); backdrop-filter: blur(10px);
            }
            
            .b-nav-item {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                flex: 1; height: 100%; cursor: pointer; color: var(--text-main); gap: 4px;
            }
            .b-nav-item span.material-symbols-rounded { font-size: 24px; }
            .b-nav-item span:not(.material-symbols-rounded) { font-size: 10px; }
            
            .b-nav-item.active { color: var(--text-main); }
            .b-nav-item.active span.material-symbols-rounded { font-variation-settings: 'FILL' 1; }

            .b-nav-add { font-size: 38px !important; font-weight: 300; color: var(--text-main); }
            
            .b-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
            .b-avatar-placeholder { width: 24px; height: 24px; border-radius: 50%; background: var(--secondary); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700;}

            /* --- LAYOUT & SIZING --- */
            .sidebar { display: none !important; } /* Permanently hide sidebar on mobile, overriding any 'mobile-open' classes */
            
            .main-container { margin-left: 0; padding: 16px; padding-bottom: 80px; } /* Add padding for bottom nav */
            .grid { grid-template-columns: 1fr; gap: 16px; row-gap: 30px; }
            
            /* --- NAVBAR --- */
            nav { padding: 0 12px; }
            @media (max-width: 768px) {
            .hide-on-mobile { display: none !important; }
            body.sidebar-open { overflow: hidden; }

            /* --- BOTTOM NAVIGATION --- */
            .bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%;
                height: 58px; background: var(--bg-nav); border-top: 1px solid var(--border);
                z-index: 4001; /* Increased to appear ON TOP of the Shorts viewer (z-index: 4000) */
                justify-content: space-around; align-items: center;
                padding-bottom: env(safe-area-inset-bottom); backdrop-filter: blur(10px);
            }
            
            .b-nav-item {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                flex: 1; height: 100%; cursor: pointer; color: var(--text-main); gap: 4px;
            }
            .b-nav-item span.material-symbols-rounded { font-size: 24px; }
            .b-nav-item span:not(.material-symbols-rounded) { font-size: 10px; }
            
            .b-nav-item.active { color: var(--text-main); }
            .b-nav-item.active span.material-symbols-rounded { font-variation-settings: 'FILL' 1; }

            .b-nav-add { font-size: 38px !important; font-weight: 300; color: var(--text-main); }
            
            .b-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
            .b-avatar-placeholder { width: 24px; height: 24px; border-radius: 50%; background: var(--secondary); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700;}

            /* --- LAYOUT & SIZING --- */
            .sidebar { display: none !important; } /* Permanently hide sidebar on mobile, overriding any 'mobile-open' classes */
            
            .main-container { margin-left: 0; padding: 16px; padding-bottom: 80px; } /* Add padding for bottom nav */
            .grid { grid-template-columns: 1fr; gap: 16px; row-gap: 30px; }
            
            /* --- NAVBAR --- */
            nav { padding: 0 12px; }
            /* REMOVED: .logo span:not(.material-symbols-rounded) { display: none; } */ 
            
            .nav-middle { display: none; }
            /* --- FIXED MOBILE SEARCH BAR --- */
            .nav-middle.show-search { 
                display: flex; 
                position: fixed; 
                top: 0; 
                left: 0; 
                right: 0; /* Ensure it stretches edge-to-edge */
                width: 100vw; /* Force full viewport width */
                height: var(--header-h); 
                background: var(--bg-body); 
                z-index: 1001; 
                padding: 0 8px; /* Small padding from edges */
                margin: 0 !important; /* CRITICAL: Removes the 20px desktop margin */
                align-items: center; 
                box-sizing: border-box; /* Ensures padding doesn't add to width */
                transform: translateY(-100%); 
                animation: slideDown 0.3s forwards cubic-bezier(0.2, 0.8, 0.2, 1);
            }

            @keyframes slideDown {
                from { transform: translateY(-100%); opacity: 0.8; }
                to { transform: translateY(0); opacity: 1; }
            }

            #back-search {
                margin-right: 8px;
                flex-shrink: 0; /* Don't let the back button shrink */
            }

            /* Container takes remaining space but can shrink */
            .nav-middle.show-search .search-container {
                display: flex;
                flex: 1;           /* Grow to fill space */
                width: auto !important; /* Override global fixed width */
                min-width: 0;      /* CRITICAL: Allows container to shrink if screen is tiny */
                margin: 0;         
                background: var(--secondary); 
                box-shadow: none;
                border: 1px solid var(--border);
            }

            /* Adjust input text to fit better */
            .nav-middle.show-search .search-container input {
                font-size: 14px;
                padding: 0 12px;
                min-width: 0; /* Allows text field to shrink */
            }

            /* Make the search button smaller on mobile (64px -> 44px) */
            .nav-middle.show-search .search-btn {
                width: 44px; 
            }
            .mobile-search-trigger { display: flex; }

            /* --- Optimize Sign In Button for Mobile --- */
            .auth-btn {
                width: 40px;              /* Make it a fixed size like other icon buttons */
                height: 40px;
                border-radius: 50%;       /* Make it a circle */
                padding: 0;               /* Remove padding, as size is now fixed */
                font-size: 0;             /* This trick hides the "Sign in" text node */
                gap: 0;                   /* No gap needed for a single icon */
                justify-content: center;  /* Ensure icon is perfectly centered */
                border-color: transparent;/* Hide the border to match other icon buttons */
            }

            .auth-btn:hover {
                border-color: var(--border); /* Show border on hover for feedback */
            }

            .auth-btn .material-symbols-rounded {
                font-size: 26px;          /* Restore the icon's size */
            }

            /* --- WATCH PAGE --- */
            /* Remove horizontal padding from the main container on mobile */
            .watch-content { padding: 16px 0; } 
            
            /* The player container is now naturally edge-to-edge */
            .player-container {
                /* Remove rounded corners and shadow for a seamless edge-to-edge look */
                border-radius: 0;
                box-shadow: none;
                margin-bottom: 0; /* Let the details container handle spacing */
            }
            .player-wrapper {
                border-radius: 0;
            }

            /* NEW: Add padding back to the text content below the video */
            .video-details-container {
                padding: 16px;
            }
            .vid-info h1 { font-size: 18px; line-height: 1.4; }
            .actions-bar { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 20px;
            }
            .chn-actions { width: 100%; justify-content: space-between; } /* Make subscribe button go to the right */
            .btn-pill { height: 40px; padding: 0 16px; font-size: 13px; }

            /* --- STUDIO --- */
            .studio-layout { flex-direction: column; }
            .studio-nav { width: 100%; border-right: none; border-bottom: 1px solid var(--border); padding: 16px; }
            .studio-main { padding: 24px 16px; }
            .st-card { padding: 20px; }
            .st-stat-grid { grid-template-columns: 1fr; } /* Force single column */
            .stat-box h2 { font-size: 28px; }
            .video-table td, .video-table th { font-size: 13px; padding: 10px 8px; }
            
            /* --- MODALS --- */
            .modal-box { padding: 24px; width: 95%; }
            #analytics-modal .modal-box { padding: 16px; }
            #modal-title, #auth-heading, #modal-heading { font-size: 20px; }
        }
            
            .nav-middle { display: none; }
            /* --- FIXED MOBILE SEARCH BAR --- */
            .nav-middle.show-search { 
                display: flex; 
                position: fixed; 
                top: 0; 
                left: 0; 
                right: 0; /* Ensure it stretches edge-to-edge */
                width: 100vw; /* Force full viewport width */
                height: var(--header-h); 
                background: var(--bg-body); 
                z-index: 1001; 
                padding: 0 8px; /* Small padding from edges */
                margin: 0 !important; /* CRITICAL: Removes the 20px desktop margin */
                align-items: center; 
                box-sizing: border-box; /* Ensures padding doesn't add to width */
                transform: translateY(-100%); 
                animation: slideDown 0.3s forwards cubic-bezier(0.2, 0.8, 0.2, 1);
            }

            @keyframes slideDown {
                from { transform: translateY(-100%); opacity: 0.8; }
                to { transform: translateY(0); opacity: 1; }
            }

            #back-search {
                margin-right: 8px;
                flex-shrink: 0; /* Don't let the back button shrink */
            }

            /* Container takes remaining space but can shrink */
            .nav-middle.show-search .search-container {
                display: flex;
                flex: 1;           /* Grow to fill space */
                width: auto !important; /* Override global fixed width */
                min-width: 0;      /* CRITICAL: Allows container to shrink if screen is tiny */
                margin: 0;         
                background: var(--secondary); 
                box-shadow: none;
                border: 1px solid var(--border);
            }

            /* Adjust input text to fit better */
            .nav-middle.show-search .search-container input {
                font-size: 14px;
                padding: 0 12px;
                min-width: 0; /* Allows text field to shrink */
            }

            /* Make the search button smaller on mobile (64px -> 44px) */
            .nav-middle.show-search .search-btn {
                width: 44px; 
            }
            .mobile-search-trigger { display: flex; }

            /* --- Optimize Sign In Button for Mobile --- */
            .auth-btn {
                width: 40px;              /* Make it a fixed size like other icon buttons */
                height: 40px;
                border-radius: 50%;       /* Make it a circle */
                padding: 0;               /* Remove padding, as size is now fixed */
                font-size: 0;             /* This trick hides the "Sign in" text node */
                gap: 0;                   /* No gap needed for a single icon */
                justify-content: center;  /* Ensure icon is perfectly centered */
                border-color: transparent;/* Hide the border to match other icon buttons */
            }

            .auth-btn:hover {
                border-color: var(--border); /* Show border on hover for feedback */
            }

            .auth-btn .material-symbols-rounded {
                font-size: 26px;          /* Restore the icon's size */
            }

            /* --- WATCH PAGE --- */
            /* Remove horizontal padding from the main container on mobile */
            .watch-content { padding: 16px 0; } 
            
            /* The player container is now naturally edge-to-edge */
            .player-container {
                /* Remove rounded corners and shadow for a seamless edge-to-edge look */
                border-radius: 0;
                box-shadow: none;
                margin-bottom: 0; /* Let the details container handle spacing */
            }
            .player-wrapper {
                border-radius: 0;
            }

            /* NEW: Add padding back to the text content below the video */
            .video-details-container {
                padding: 16px;
            }
            .vid-info h1 { font-size: 18px; line-height: 1.4; }
            .actions-bar { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 20px;
            }
            .chn-actions { width: 100%; justify-content: space-between; } /* Make subscribe button go to the right */
            .btn-pill { height: 40px; padding: 0 16px; font-size: 13px; }

            /* --- STUDIO --- */
            .studio-layout { flex-direction: column; }
            .studio-nav { width: 100%; border-right: none; border-bottom: 1px solid var(--border); padding: 16px; }
            .studio-main { padding: 24px 16px; }
            .st-card { padding: 20px; }
            .st-stat-grid { grid-template-columns: 1fr; } /* Force single column */
            .stat-box h2 { font-size: 28px; }
            .video-table td, .video-table th { font-size: 13px; padding: 10px 8px; }
            
            /* --- MODALS --- */
            .modal-box { padding: 24px; width: 95%; }
            #analytics-modal .modal-box { padding: 16px; }
            #modal-title, #auth-heading, #modal-heading { font-size: 20px; }
        }
/* --- FULL SCREEN MOBILE SEARCH --- */
.mobile-search-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-body); z-index: 2000;
    display: flex; flex-direction: column;
    transform: translateX(100%); /* Hidden by default (slide right) */
    transition: transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.mobile-search-overlay.active { transform: translateX(0); }



.ms-content { flex: 1; overflow-y: auto; padding-top: 8px; }

/* List Items (History & Suggestions) */
.ms-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 16px; height: 52px; cursor: pointer;
}
.ms-item:active { background: var(--secondary); }

.ms-item-left { display: flex; align-items: center; gap: 16px; flex: 1; overflow: hidden; }
.ms-icon { color: var(--text-light); font-size: 24px; }
.ms-text { 
    font-size: 16px; font-weight: 500; color: var(--text-main);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.ms-delete {
    padding: 8px; color: var(--text-light); font-size: 14px;
}
.ms-delete:hover { color: var(--accent-red); }

/* Suggestion arrow icon */
.ms-arrow { transform: rotate(-45deg); color: var(--text-light); }
/* --- SEARCH RESULTS SCREEN & FILTERS --- */
        
        /* NEW: Force this overlay to cover the main Navbar */
        #search-results-view {
            top: 0 !important;       /* Move to very top */
            height: 100% !important; /* Full height */
            z-index: 2001 !important;/* Higher than Navbar (1000) */
            background: var(--bg-body);
        }

        .sr-header {
            position: sticky; top: 0; left: 0; width: 100%; height: var(--header-h);
            background: var(--bg-nav); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 6px; 
            padding: 0 8px; z-index: 1005; backdrop-filter: blur(8px);
        }

        /* Pill Container */
        .sr-search-pill {
            flex: 1; /* Takes up remaining space */
            background: #f2f2f2; /* Light grey default */
            height: 36px;
            border-radius: 18px;
            display: flex; align-items: center; justify-content: space-between;
            padding-left: 16px; padding-right: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            min-width: 0; /* Important for flex shrinking */
        }
        body.dark-mode .sr-search-pill { background: #272727; } /* Dark mode pill */
        .sr-search-pill:active { opacity: 0.8; }

        /* Text inside Pill */
        #sr-query-display { 
            font-weight: 500; font-size: 15px; color: var(--text-main); 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            margin-right: 8px; flex: 1;
        }

        /* Small X button inside pill */
        .icon-btn-small {
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; color: var(--text-light); transition: 0.2s; flex-shrink: 0;
        }
        
        /* Mic Button Styling */
        .mic-btn {
            background: #f2f2f2; 
            width: 40px; height: 40px; flex-shrink: 0;
        }
        body.dark-mode .mic-btn { background: #272727; }

        .filter-dropdown {
            position: absolute; top: 45px; right: 0;
            background: var(--white); border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 220px; display: none; flex-direction: column;
            overflow: hidden; border: 1px solid var(--border);
            animation: fadeIn 0.2s ease;
        }
        .filter-item {
            padding: 14px 16px; font-size: 14px; color: var(--text-main);
            cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--border);
        }
        .filter-item:last-child { border-bottom: none; }
        .filter-item:hover { background: var(--secondary); }

/* --- SHORTS SHELF (HOME & SEARCH) --- */
.shorts-shelf {
    grid-column: 1 / -1; /* Span full grid width */
    margin-bottom: 30px;
}
.shorts-shelf-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--black);
}
.shorts-shelf-title .material-symbols-rounded {
    font-size: 28px;
    color: var(--accent-red);
}

/* Mobile-first: 2-column grid layout */
.shorts-scroll-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* Creates two equal columns */
    gap: 12px;
}

/* Desktop: Expand to a responsive, multi-column grid */
@media (min-width: 769px) {
    .shorts-scroll-container {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
    }
}

.short-card {
    aspect-ratio: 9/16;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    transition: transform 0.2s ease;
}
.short-card:hover { transform: scale(1.03); }
.short-card img { width: 100%; height: 100%; object-fit: cover; }
.short-card-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 12px;
    background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
    color: white;
}
.short-card-title {
    font-size: 14px;
    font-weight: 600;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.short-card-views {
    font-size: 12px;
    font-weight: 500;
    margin-top: 4px;
    opacity: 0.9;
}

/* --- SHORTS VIEWER --- */
#shorts-container {
    width: 100%;
    height: 100%;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    scrollbar-width: none;
    background-color: #000;
}
#shorts-container::-webkit-scrollbar { display: none; }

.short-slide {
    width: 100%;
    height: 100vh; /* CRITICAL FIX: Make each slide exactly the viewport height */
    scroll-snap-align: start;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Update video to cover screen and add Loader styles */
.short-slide video {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Stretches thumbnail to full screen */
    z-index: 1;
    background: #000;
}

/* Hide default mobile play button */
video::-webkit-media-controls { display:none !important; }
video::-webkit-media-controls-start-playback-button { display: none !important; -webkit-appearance: none; }

/* Loading Spinner */
.short-loader {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    z-index: 2;
    display: none;
}
@keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

.short-ui-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    top: 0;
    color: white;
    pointer-events: none;
    z-index: 5;
    /* Apply safe area insets AND padding for the fixed header */
    padding-top: calc(env(safe-area-inset-top) + 110px); /* Pushes UI down */
    padding-bottom: env(safe-area-inset-bottom);
    box-sizing: border-box; /* Ensures padding is contained */
}

/* NEW: Top Header (Screenshot Replica) */
.shorts-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    pointer-events: all;
    background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, transparent 100%);
}
.shorts-header-left, .shorts-header-right {
    display: flex;
    align-items: center;
    gap: 4px;
}
.shorts-header h2 {
    font-size: 18px;
    font-weight: 600;
    margin-left: 8px;
}

/* NEW: Filter Pills Bar */
.shorts-filter-bar {
    position: absolute;
    top: 56px; /* Below the header */
    left: 0;
    right: 0;
    display: flex;
    gap: 8px;
    padding: 0 12px;
    overflow-x: auto;
    scrollbar-width: none;
    pointer-events: all;
}
.shorts-filter-bar::-webkit-scrollbar { display: none; }

.sf-pill {
    white-space: nowrap;
    padding: 8px 14px;
    border-radius: 20px;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
}
.sf-pill .material-symbols-rounded { font-size: 20px; }


/* Right-side Action buttons */
.short-ui-right {
    position: absolute;
    bottom: calc(58px + 20px); /* Space for bottom nav */
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
    pointer-events: all;
}

/* NEW: Sound thumbnail */
.short-sound-thumb {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid white;
    margin-top: 10px;
    animation: spin 8s linear infinite;
}
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }


/* Bottom Info Section */
.short-ui-bottom {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 16px;
    background: linear-gradient(0deg, rgba(0,0,0,0.6) 0%, transparent 100%);
    pointer-events: all;
    padding-bottom: calc(58px + 10px); /* Space for bottom nav */
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-start; /* ADD THIS LINE TO FIX THE ISSUE */
}

/* NEW: Comment Bubble Placeholder */
.short-comment-bubble {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    border-radius: 20px;
    padding: 6px 10px;
    max-width: 80%;
    align-self: flex-start; /* Important */
    font-size: 13px;
}
.short-comment-bubble img {
    width: 20px;
    height: 20px;
    border-radius: 50%;
}
.short-comment-bubble span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}


/* Container: Takes up space but stops before hitting the right-side icons */
.short-chn-info {
    display: flex;
    align-items: center;
    gap: 8px; /* Reduced gap slightly to fit more text */
    width: auto;
    /* This ensures we use ALL available space minus the 60px needed for the right-side icons */
    max-width: calc(100% - 60px); 
}

.short-chn-info img { 
    width: 36px; 
    height: 36px; 
    border-radius: 50%;
    flex-shrink: 0; /* Avatar never shrinks */
}

/* Name: Takes up remaining space, cuts off only if absolutely necessary */
.short-chn-name { 
    font-weight: 600; 
    font-size: 15px; 
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* Shows "..." at the end */
    flex: 0 1 auto; /* Allows growing to fit text, but shrinking if space runs out */
}

/* Button: Stays visible, never shrinks */
.short-chn-info .sub-btn {
    flex-shrink: 0; 
    margin-left: 2px; /* Small buffer */
}
.short-chn-info img { 
    width: 36px; 
    height: 36px; 
    border-radius: 50%;
    flex-shrink: 0; /* Never squash the avatar */
}

/* 2. Name: Truncate with (...) if too long */
.short-chn-name { 
    font-weight: 600; 
    font-size: 15px; 
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* Adds the "..." */
    flex-shrink: 1; /* Allows the name to shrink */
    min-width: 0;   /* Required for flexbox truncation to work */
}

/* 3. Button: Never shrink, stay visible */
.short-chn-info .sub-btn {
    flex-shrink: 0; 
}

.short-chn-info img { 
    width: 36px; 
    height: 36px; 
    border-radius: 50%; 
}

/* Name: Remove 'flex: 1', add 'flex: initial' so it doesn't push the button */
.short-chn-name { 
    font-weight: 600; 
    font-size: 15px; 
    flex: initial; /* CRITICAL FIX: Stops the name from pushing the button away */
    max-width: 200px; /* Optional: limits name length so it doesn't cover the screen */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.short-chn-info .sub-btn {
    height: 36px;
    padding: 0 18px;
    font-size: 14px;
    flex-shrink: 0;
    background: white; /* Force white for visibility */
    color: black;      /* Force black for visibility */
}
.short-chn-info .sub-btn.subscribed {
    background: rgba(255,255,255,0.2);
    color: white;
}

.short-title {
    font-weight: 400;
    line-height: 1.4;
    font-size: 14px;
}

.short-play-pause-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    pointer-events: none;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.2s ease-in-out, transform 0.2s ease;
}
.short-play-pause-indicator.visible {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.1);
}
.short-play-pause-indicator .material-symbols-rounded {
    font-size: 48px;
    font-variation-settings: 'FILL' 1;
}

.short-action-pill {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    background: transparent;
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    cursor: pointer;
    transition: transform 0.2s;
}
.short-action-pill:active { transform: scale(0.9); }
.short-action-pill .material-symbols-rounded { font-size: 30px; }
.short-action-pill span:not(.material-symbols-rounded) { font-size: 13px; font-weight: 500; }

.short-action-pill.active .material-symbols-rounded {
    color: var(--primary);
    font-variation-settings: 'FILL' 1;
}
/* --- NEW SUBSCRIPTION HEADER STYLES (SCREENSHOT REPLICA) --- */
.sub-header-wrapper {
    grid-column: 1 / -1; /* Spans full width of the grid */
    width: 100%;
    /* Mobile: Negative margin to touch screen edges ignoring padding */
    margin-left: -16px; 
    width: calc(100% + 32px);
    padding: 0 16px; 
    /* margin-bottom: 12px; <-- THIS LINE WAS REMOVED TO FIX THE GAP */
    background: var(--bg-body);
}

@media (min-width: 769px) {
    .sub-header-wrapper {
        margin-left: 0;
        width: 100%;
        padding: 0;
    }
}

.sub-scroll-container {
    display: flex;
    align-items: center;
    gap: 12px;
    overflow-x: auto;
    /* --- FIX: padding-bottom changed to 0 --- */
    padding-bottom: 0px; 
    scrollbar-width: none;
}
.sub-scroll-container::-webkit-scrollbar { display: none; }

.sub-avatar-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    min-width: 64px;
    max-width: 64px;
    position: relative;
}

.sub-img-box {
    position: relative;
    width: 56px;
    height: 56px;
    margin-bottom: 6px;
}

.sub-img-actual {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    display: block;
    /* Optional: Border if image is white */
    border: 1px solid rgba(0,0,0,0.05); 
}

/* The Blue Notification Dot (Exact Match) */
.sub-notif-dot {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 14px;
    height: 14px;
    background-color: #3ea6ff; /* Official Blue */
    border: 2px solid var(--bg-body); /* Cutout effect */
    border-radius: 50%;
    z-index: 2;
}

.sub-name-label {
    font-size: 12px;
    color: var(--text-main);
    text-align: center;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 400;
}

/* The "All" link at the end */
.sub-all-link {
    color: #3ea6ff;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    margin-left: 8px;
    white-space: nowrap;
    padding: 8px;
}
    /* --- PERSONAL CONTENT HUB (YOU TAB) --- */
        .ph-header {
            position: sticky; top: 0; left: 0; width: 100%; height: 64px;
            background: var(--bg-nav); 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; z-index: 1005; 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
        }
        
        .ph-user-info {
            flex: 1; display: flex; flex-direction: column; 
            margin-left: 12px; justify-content: center;
        }
        .ph-name { font-size: 16px; font-weight: 600; color: var(--text-main); line-height: 1.2; }
        .ph-handle { font-size: 12px; color: var(--text-light); }

        .ph-actions { display: flex; gap: 8px; }
        
        .ph-content { padding: 0 0 80px 0; overflow-y: auto; height: calc(100vh - 64px); }

        .ph-section { margin-bottom: 24px; padding-top: 20px; border-bottom: 1px solid var(--bg-studio); padding-bottom: 10px; }
        .ph-section-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 16px 12px 16px;
        }
        .ph-title { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .ph-view-all { 
            font-size: 14px; color: var(--primary); font-weight: 600; 
            border: 1px solid var(--border); padding: 4px 12px; border-radius: 18px;
        }

        .ph-scroll-box {
            display: flex; gap: 12px; overflow-x: auto; padding: 0 16px 16px 16px;
            scrollbar-width: none;
        }
        .ph-scroll-box::-webkit-scrollbar { display: none; }

        .ph-vid-card {
            min-width: 160px; max-width: 160px; display: flex; flex-direction: column; gap: 8px; cursor: pointer;
        }
        .ph-vid-thumb-box {
            width: 160px; height: 90px; border-radius: 8px; background: #000;
            display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
        }
        .ph-vid-title {
            font-size: 13px; font-weight: 500; color: var(--text-main);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;
        }
        .ph-vid-meta { font-size: 11px; color: var(--text-light); }

        .ph-menu-list { padding: 0 16px; }
        .ph-menu-item {
            display: flex; align-items: center; gap: 16px;
            padding: 14px 0; border-bottom: 1px solid var(--border);
            cursor: pointer; color: var(--text-main); font-size: 16px;
        }
        .ph-menu-item:last-child { border-bottom: none; }
        .ph-menu-icon { color: var(--text-main); font-size: 24px; }

    /* --- MOBILE NOTIFICATIONS UI --- */
.mn-section-title {
    padding: 16px 16px 8px 16px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-light);
}

.mn-item {
    display: flex;
    padding: 12px 16px;
    gap: 12px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
}
.mn-item:active { background: var(--secondary); }

.mn-dot {
    position: absolute;
    left: 4px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 4px;
    background-color: #3ea6ff;
    border-radius: 50%;
}

.mn-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    margin-left: 8px; /* Space for dot */
}

.mn-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
}

.mn-text {
    font-size: 14px;
    color: var(--text-main);
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.mn-time { font-size: 12px; color: var(--text-light); }

.mn-thumb {
    width: 86px;
    height: 48px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
    background: #ccc;
}

.mn-menu {
    width: 24px;
    display: flex;
    justify-content: center;
    color: var(--text-main);
    opacity: 0.7;
}
/* --- FORCE HIDE HEADER ON HISTORY SCREEN --- */
body.history-mode nav { 
    display: none !important; 
}
body.history-mode .main-container { 
    margin-top: 0 !important; 
    padding-top: 10px !important;
}
body.history-mode #category-bar {
    display: none !important;
}
/* --- NEW STYLES FOR "YOU" SCREEN HEADER --- */
.ph-profile-block {
    padding: 16px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}
.ph-large-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin-bottom: 4px;
}
.ph-main-name {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-main);
}
.ph-handle-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-light);
}
.ph-view-channel-link {
    color: var(--primary);
    cursor: pointer;
    font-weight: 500;
}
.ph-actions-row {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    width: 100%;
    padding: 0 16px 16px 16px;
    justify-content: center;
}
.ph-action-pill {
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--secondary);
    color: var(--text-main);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
}

/* --- GUARANTEED FIX for Incognito using an IMG tag --- */
.ph-action-icon-img {
    width: 20px;
    height: 20px;
    /* This makes the black icon visible in light mode */
    filter: invert(0);
}

/* This rule automatically flips the black icon to white in dark mode */
body.dark-mode .ph-action-icon-img {
    filter: invert(1);
}
/* --- NEW: SUBSCRIPTION PAGE FILTER PILLS --- */
.sub-filter-bar {
    grid-column: 1 / -1; /* Span full grid width */
    display: flex;
    gap: 8px;
    overflow-x: auto;
    /* --- FIX: Top padding changed to 4px to reduce the gap --- */
    padding: 4px 0 16px 0;
    margin-bottom: 12px;
}
.sub-filter-pill {
    white-space: nowrap;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    /* Enhanced Animation */
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    flex-shrink: 0;
    background: var(--secondary);
    color: var(--text-main);
    border: 1px solid var(--border);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Added subtle shadow */
}

/* Added hover animation */
.sub-filter-pill:hover {
    transform: translateY(-2px);
    opacity: 0.9;
}

/* Enhanced active state to match cat-pill style */
.sub-filter-pill.active {
    background: var(--text-main);
    color: var(--bg-body);
    border-color: var(--text-main);
    transform: scale(1.05);
    box-shadow: 0 6px 15px rgba(0,0,0,0.2); 
    border: 2px solid var(--text-main);
}
/* --- NEW: Download Progress Circle Styles --- */
#download-canvas {
    display: none; /* Hidden by default */
    transform: rotate(-90deg); /* Start progress from the top */
}

/* Ensure the icon fits nicely within the button */
#download-btn-watch .material-symbols-rounded {
    font-size: 22px;
}
    </style>
</head>
<body class="body-loading">
    <div class="mobile-overlay" id="mobile-overlay" onclick="toggleSidebar()"></div>

    <!-- NAVBAR -->
    <nav>
        <div class="nav-left">
            <button class="icon-btn hide-on-mobile" onclick="toggleSidebar()"><span class="material-symbols-rounded">menu</span></button>
            <div class="logo" onclick="goHome()">
                <span class="material-symbols-rounded">play_circle</span>
                <span>Yourtube</span>
            </div>
        </div>

<div class="nav-middle" id="nav-search-bar">
            <button class="icon-btn" onclick="toggleMobileSearch()" style="margin-right:10px; display:none;" id="back-search"><span class="material-symbols-rounded">arrow_back</span></button>
            <div class="search-container">
                <!-- Removed inline event handlers; managed via JS DOMContentLoaded -->
                <input type="text" id="search-input" placeholder="Search"> 
                <div class="search-btn" onclick="handleSearch({key:'Enter'})"><span class="material-symbols-rounded">search</span></div>
            </div>
        </div>

        <div class="nav-right">
            <button class="icon-btn mobile-search-trigger" onclick="openMobileSearch()"><span class="material-symbols-rounded">search</span></button>
            <button class="icon-btn hide-on-mobile" onclick="handleUploadClick()"><span class="material-symbols-rounded" style="color: var(--accent-red);">video_call</span></button>
            
            <div style="position: relative;">
                <button class="icon-btn" onclick="toggleNotif()"><span class="material-symbols-rounded" style="color: var(--accent-yellow);">notifications</span></button>
                <div class="notif-badge" id="notif-badge"></div>
                <div class="notif-dropdown" id="notif-dropdown">
                    <h4 style="padding:16px; font-size:15px; font-weight:600; border-bottom:1px solid var(--border);">Recent Uploads</h4>
                    <div id="notif-list"></div>
                </div>
            </div>

            <div id="auth-section">
                <button class="auth-btn" onclick="openAuth()"><span class="material-symbols-rounded">account_circle</span> Sign in</button>
            </div>
        </div>
    </nav>

    <!-- BOTTOM NAVIGATION (MOBILE ONLY) -->
    <div class="bottom-nav">
        <div class="b-nav-item active" onclick="goHome(); updateBottomNav(this);">
            <span class="material-symbols-rounded">home</span>
            <span>Home</span>
        </div>
        <div class="b-nav-item" onclick="openShortsFeed(); updateBottomNav(this);">
            <span class="material-symbols-rounded">slow_motion_video</span>
            <span>Shorts</span>
        </div>
        <div class="b-nav-item" onclick="handleUploadClick()">
            <span class="material-symbols-rounded b-nav-add">add_circle</span>
        </div>
        <div class="b-nav-item" onclick="openSubscriptionsPage(); updateBottomNav(this);">
            <span class="material-symbols-rounded">subscriptions</span>
            <span>Subscriptions</span>
        </div>
        <div class="b-nav-item" onclick="openProfileHub(); updateBottomNav(this);" id="btn-nav-you">
            <span class="material-symbols-rounded" id="b-nav-icon">account_circle</span>
            <span>You</span>
        </div>
    </div>
<!-- BOTTOM NAVIGATION (MOBILE ONLY) -->
    <div class="bottom-nav">
        <div class="b-nav-item active" onclick="goHome(); updateBottomNav(this);">
            <span class="material-symbols-rounded">home</span>
            <span>Home</span>
        </div>
        <div class="b-nav-item" onclick="openShortsFeed(); updateBottomNav(this);">
            <span class="material-symbols-rounded">slow_motion_video</span>
            <span>Shorts</span>
        </div>
        <div class="b-nav-item" onclick="handleUploadClick()">
            <span class="material-symbols-rounded b-nav-add">add_circle</span>
        </div>
        <div class="b-nav-item" onclick="openSubscriptionsPage(); updateBottomNav(this);">
            <span class="material-symbols-rounded">subscriptions</span>
            <span>Subscriptions</span>
        </div>
        <div class="b-nav-item" onclick="openProfileHub(); updateBottomNav(this);" id="btn-nav-you">
            <span class="material-symbols-rounded" id="b-nav-icon">account_circle</span>
            <span>You</span>
        </div>
    </div>
<!-- DESKTOP SEARCH SUGGESTIONS -->
    <div id="desktop-suggestions">
        <!-- Content injected by JS -->
    </div>
    
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="menu-item active" onclick="goHome()" id="btn-home">
            <span class="material-symbols-rounded icon-home">home</span> <span>Home</span>
        </div>
        <div class="menu-item" onclick="openStudio()" id="btn-studio">
            <span class="material-symbols-rounded icon-studio">bar_chart</span> <span>Studio</span>
        </div>
        <div class="menu-item" onclick="openShortsFeed()" id="btn-shorts">
            <span class="material-symbols-rounded">slow_motion_video</span> <span>Shorts</span>
        </div>
        <div class="menu-item" onclick="openHistory()" id="btn-history">
            <span class="material-symbols-rounded icon-history">history</span> <span>History</span>
        </div>
        <div class="menu-item" onclick="openLikedVideos()" id="btn-liked">
            <span class="material-symbols-rounded icon-liked">thumb_up</span> <span>Liked Videos</span>
        </div>
        
        <hr style="border:0; border-top:1px solid var(--border); margin:12px 0;">
        <h3 class="sub-header">Subscriptions</h3>
        <div id="sub-list-container">
            <div style="padding: 0 12px; font-size: 13px; color: var(--text-light);">Sign in to see subscriptions</div>
        </div>
        
        <div id="logout-btn" style="display:none; margin-top:20px;">
             <div class="menu-item" onclick="handleLogout()">
                <span class="material-symbols-rounded icon-logout">logout</span> <span>Sign Out</span>
            </div>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="main-container" id="main-content">
        <!-- Colorful Bubble Categories -->
        <div class="category-bar" id="category-bar">
            <!-- Populated by JS -->
        </div>

        <h2 id="page-heading" class="page-title">Home</h2>
        <div class="grid" id="video-grid">
            <!-- Skeleton Loader (8 items) -->
            <!-- This will be overwritten by JS once data loads -->
            <div class="sk-card">
                <div class="skeleton sk-thumb"></div>
                <div class="sk-meta">
                    <div class="skeleton sk-avatar"></div>
                    <div class="sk-text"><div class="skeleton sk-line"></div><div class="skeleton sk-line-sm"></div></div>
                </div>
            </div>
            <div class="sk-card">
                <div class="skeleton sk-thumb"></div>
                <div class="sk-meta">
                    <div class="skeleton sk-avatar"></div>
                    <div class="sk-text"><div class="skeleton sk-line"></div><div class="skeleton sk-line-sm"></div></div>
                </div>
            </div>
            <div class="sk-card">
                <div class="skeleton sk-thumb"></div>
                <div class="sk-meta">
                    <div class="skeleton sk-avatar"></div>
                    <div class="sk-text"><div class="skeleton sk-line"></div><div class="skeleton sk-line-sm"></div></div>
                </div>
            </div>
            <div class="sk-card">
                <div class="skeleton sk-thumb"></div>
                <div class="sk-meta">
                    <div class="skeleton sk-avatar"></div>
                    <div class="sk-text"><div class="skeleton sk-line"></div><div class="skeleton sk-line-sm"></div></div>
                </div>
            </div>
            <div class="sk-card">
                <div class="skeleton sk-thumb"></div>
                <div class="sk-meta">
                    <div class="skeleton sk-avatar"></div>
                    <div class="sk-text"><div class="skeleton sk-line"></div><div class="skeleton sk-line-sm"></div></div>
                </div>
            </div>
            <div class="sk-card">
                <div class="skeleton sk-thumb"></div>
                <div class="sk-meta">
                    <div class="skeleton sk-avatar"></div>
                    <div class="sk-text"><div class="skeleton sk-line"></div><div class="skeleton sk-line-sm"></div></div>
                </div>
            </div>
            <div class="sk-card">
                <div class="skeleton sk-thumb"></div>
                <div class="sk-meta">
                    <div class="skeleton sk-avatar"></div>
                    <div class="sk-text"><div class="skeleton sk-line"></div><div class="skeleton sk-line-sm"></div></div>
                </div>
            </div>
            <div class="sk-card">
                <div class="skeleton sk-thumb"></div>
                <div class="sk-meta">
                    <div class="skeleton sk-avatar"></div>
                    <div class="sk-text"><div class="skeleton sk-line"></div><div class="skeleton sk-line-sm"></div></div>
                </div>
            </div>
        </div>
    </div>
<!-- SEARCH RESULTS OVERLAY -->
    <div class="overlay-screen" id="search-results-view">
        <!-- Sticky Header with Pill UI -->
        <div class="sr-header">
            <!-- Back Button -->
            <button class="icon-btn" onclick="closeSearchResults()">
                <span class="material-symbols-rounded">arrow_back</span>
            </button>
            
            <!-- Search Pill Container -->
            <div class="sr-search-pill" onclick="closeSearchResults(); openMobileSearch();">
                <span id="sr-query-display">Search Term</span>
                <button class="icon-btn-small" onclick="event.stopPropagation(); closeSearchResults(); openMobileSearch();">
                    <span class="material-symbols-rounded" style="font-size: 20px;">close</span>
                </button>
            </div>

            <!-- Mic Button -->
            <button class="icon-btn mic-btn">
                <span class="material-symbols-rounded">mic</span>
            </button>
            
            <!-- 3 Dots Menu Wrapper -->
            <div style="position:relative;">
                <button class="icon-btn" onclick="toggleFilterMenu()">
                    <span class="material-symbols-rounded">more_vert</span>
                </button>
                <!-- Filter Dropdown -->
                <div class="filter-dropdown" id="filter-dropdown">
                    <div class="filter-item" onclick="sortResults('newest')">Upload Date (Newest)</div>
                    <div class="filter-item" onclick="sortResults('oldest')">Upload Date (Oldest)</div>
                    <div class="filter-item" onclick="sortResults('views')">View Count</div>
                </div>
            </div>
        </div>
    
        <!-- Results Grid -->
        <div class="main-container full" style="margin-top:0; padding: 20px;">
            <div class="grid" id="search-results-grid">
                <!-- Javascript will put cards here -->
            </div>
        </div>
    </div>
    <!-- WATCH OVERLAY -->
    <div class="overlay-screen" id="watch-view">
        <div class="watch-content">
            <!-- NEW: Main Grid Layout for Player + Sidebar -->
            <div class="watch-layout-grid">

                <!-- Column 1: Player and Details -->
                <div class="watch-main-col">
                    <div class="player-container" id="player-container">
                        <!-- Top Left Back Button -->
                        <div class="float-back-btn" onclick="closeWatch()">
                            <span class="material-symbols-rounded">keyboard_arrow_down</span>
                        </div>

                        <!-- MOBILE ONLY: Top Right Settings Button (Floating) -->
                        <button class="mobile-settings-btn" id="mobile-settings-btn" onclick="event.stopPropagation(); toggleSettings()">
                            <span class="material-symbols-rounded">settings</span>
                        </button>

                        <video id="main-player" playsinline></video>
                        
                        <!-- NEW: 2x Speed Indicator -->
                        <div class="speed-overlay" id="speed-overlay">
                            <span class="material-symbols-rounded">speed</span> 2x Speed
                        </div>

                        <!-- NEW: Double-Tap Seek Overlays -->
                        <div class="seek-layer left" id="seek-overlay-left">
                            <div class="seek-icon-group">
                                <span class="material-symbols-rounded" style="font-size: 50px;">fast_rewind</span>
                            </div>
                            <div class="seek-text">10 seconds</div>
                        </div>
                        <div class="seek-layer right" id="seek-overlay-right">
                            <div class="seek-icon-group">
                                <span class="material-symbols-rounded" style="font-size: 50px;">fast_forward</span>
                            </div>
                            <div class="seek-text">10 seconds</div>
                        </div>

                        <!-- NEW: Desktop Settings Menu -->
                        <div class="settings-menu" id="settings-menu" onclick="event.stopPropagation()">
                            
                            <!-- 1. Main Menu -->
                            <div class="sm-view active" id="sm-main">
                                <!-- Ambient Mode (Toggle) -->
                                <div class="sm-item" onclick="toggleSwitch('ambient-toggle')">
                                    <div class="sm-left">
                                        <span class="material-symbols-rounded">blur_on</span> Ambient mode
                                    </div>
                                    <div class="toggle-switch" id="ambient-toggle"></div>
                                </div>

                                <!-- Annotations (Toggle) -->
                                <div class="sm-item" onclick="toggleSwitch('annot-toggle')">
                                    <div class="sm-left">
                                        <span class="material-symbols-rounded">subtitles_off</span> Annotations
                                    </div>
                                    <div class="toggle-switch" id="annot-toggle"></div>
                                </div>

                                <!-- Subtitles -->
                                <div class="sm-item" onclick="openSubMenu('subs')">
                                    <div class="sm-left">
                                        <span class="material-symbols-rounded">closed_caption</span> Subtitles/CC
                                    </div>
                                    <div class="sm-right">Off <span class="material-symbols-rounded">chevron_right</span></div>
                                </div>

                                <!-- Sleep Timer -->
                                <div class="sm-item" onclick="openSubMenu('sleep')">
                                    <div class="sm-left">
                                        <span class="material-symbols-rounded">bedtime</span> Sleep timer
                                    </div>
                                    <div class="sm-right">Off <span class="material-symbols-rounded">chevron_right</span></div>
                                </div>

                                <!-- Playback Speed -->
                                <div class="sm-item" onclick="openSubMenu('speed')">
                                    <div class="sm-left">
                                        <span class="material-symbols-rounded">slow_motion_video</span> Playback speed
                                    </div>
                                    <div class="sm-right"><span id="set-speed-val">Normal</span> <span class="material-symbols-rounded">chevron_right</span></div>
                                </div>

                                <!-- Quality -->
                                <div class="sm-item" onclick="openSubMenu('quality')">
                                    <div class="sm-left">
                                        <span class="material-symbols-rounded">tune</span> Quality
                                    </div>
                                    <div class="sm-right"><span id="set-quality-val">Auto (1080p)</span> <span class="material-symbols-rounded">chevron_right</span></div>
                                </div>
                            </div>

                            <!-- 2. Playback Speed Submenu -->
                            <div class="sm-view" id="sm-speed">
                                <div class="sm-header" onclick="backToMainSettings()">
                                    <span class="material-symbols-rounded">arrow_back</span> Playback speed
                                </div>
                                <div class="sm-item" onclick="changeSpeed(0.25)">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 0.25</div>
                                </div>
                                <div class="sm-item" onclick="changeSpeed(0.5)">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 0.5</div>
                                </div>
                                <div class="sm-item" onclick="changeSpeed(0.75)">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 0.75</div>
                                </div>
                                <div class="sm-item selected" onclick="changeSpeed(1.0)" id="speed-1.0">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> Normal</div>
                                </div>
                                <div class="sm-item" onclick="changeSpeed(1.25)">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 1.25</div>
                                </div>
                                <div class="sm-item" onclick="changeSpeed(1.5)">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 1.5</div>
                                </div>
                                <div class="sm-item" onclick="changeSpeed(2.0)">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 2.0</div>
                                </div>
                            </div>

                            <!-- 3. Quality Submenu -->
                            <div class="sm-view" id="sm-quality">
                                <div class="sm-header" onclick="backToMainSettings()">
                                    <span class="material-symbols-rounded">arrow_back</span> Quality
                                </div>
                                <div class="sm-item selected" onclick="changeQuality('Auto (1080p)')">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> Auto (1080p)</div>
                                </div>
                                <div class="sm-item" onclick="changeQuality('1080p')">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 1080p</div>
                                </div>
                                <div class="sm-item" onclick="changeQuality('720p')">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 720p</div>
                                </div>
                                <div class="sm-item" onclick="changeQuality('480p')">
                                    <div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 480p</div>
                                </div>
                            </div>

                            <!-- 4. Sleep Timer Submenu (Visual Only) -->
                            <div class="sm-view" id="sm-sleep">
                                <div class="sm-header" onclick="backToMainSettings()">
                                    <span class="material-symbols-rounded">arrow_back</span> Sleep Timer
                                </div>
                                <div class="sm-item selected"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> Off</div></div>
                                <div class="sm-item"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 10 minutes</div></div>
                                <div class="sm-item"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 15 minutes</div></div>
                                <div class="sm-item"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 30 minutes</div></div>
                            </div>

                            <!-- 5. Subtitles Submenu (Visual Only) -->
                            <div class="sm-view" id="sm-subs">
                                <div class="sm-header" onclick="backToMainSettings()">
                                    <span class="material-symbols-rounded">arrow_back</span> Subtitles
                                </div>
                                <div class="sm-item selected"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> Off</div></div>
                                <div class="sm-item"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> English</div></div>
                                <div class="sm-item"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> Hindi</div></div>
                            </div>
                        </div>
                        
                        <!-- NEW: Central Indicator -->
                        <div class="play-pause-indicator" id="play-pause-indicator">
                            <span class="material-symbols-rounded"></span>
                        </div>

                        <div class="controls-overlay" id="controls-overlay">
                            
                            <div class="progress-container" id="progress-container">
                                <div class="progress-bar-bg"></div>
                                <div class="progress-bar-filled" id="progress-bar-filled"></div>
                            </div>
                            <div class="controls-row">
                                <div class="controls-left">
                                    <button class="player-btn" onclick="event.stopPropagation(); togglePlay()" id="play-pause-btn"><span class="material-symbols-rounded">play_arrow</span></button>
                                    <div class="volume-container">
                                        <button class="player-btn" onclick="event.stopPropagation(); toggleMute()" id="mute-btn"><span class="material-symbols-rounded">volume_up</span></button>
                                        <input type="range" class="volume-slider" id="volume-slider" min="0" max="1" step="0.01" value="1" onclick="event.stopPropagation();">
                                    </div>
                                    <div class="time-display" id="time-display">00:00 / 00:00</div>
                                </div>
                                <div class="controls-right">
                                    <!-- DESKTOP ONLY: Settings Button (Bottom Right) -->
                                    <button class="player-btn desktop-settings-btn" onclick="event.stopPropagation(); toggleSettings()">
                                        <span class="material-symbols-rounded">settings</span>
                                    </button>
                                    
                                    <button class="player-btn" onclick="event.stopPropagation(); toggleFullScreen()" id="fullscreen-btn"><span class="material-symbols-rounded">fullscreen</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
        
                    <div class="video-details-container">
                        <div class="vid-info">
                            <h1 id="w-title">Video Title</h1>
                            <div class="actions-bar">
                                <div class="chn-actions">
                                    <img id="w-chn-img" src="" class="chn-avatar">
                                    <div>
                                        <h4 id="w-chn-name" style="font-size:16px;">Channel</h4>
                                        <span id="w-sub-count" style="font-size:13px; color:var(--text-light);">0 subscribers</span>
                                    </div>
                                    <button class="sub-btn" id="sub-btn" onclick="toggleSubscribe()">Subscribe</button>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button class="btn-pill btn-like" id="like-btn" onclick="toggleLike()">
                                        <span class="material-symbols-rounded" id="like-icon">thumb_up</span>
                                        <span id="w-likes">0</span>
                                    </button>
                                    <button class="btn-pill btn-dislike" onclick="alert('Dislike registered')">
                                        <span class="material-symbols-rounded">thumb_down</span>
                                    </button>
                                    <!-- Download Button with Progress Circle -->
                                    <button class="btn-pill btn-share" id="download-btn-watch" onclick="startDownloadProcess()">
                                        <div id="download-icon-container" style="position:relative; width:22px; height:22px;">
                                            <span class="material-symbols-rounded" id="download-icon-span">download</span>
                                            <canvas id="download-canvas" width="22" height="22" style="position:absolute; top:0; left:0;"></canvas>
                                        </div>
                                        <span id="download-text-span">Download</span>
                                    </button>
                                </div>
                            </div>
                            <div class="desc-box">
                                <p id="w-meta" style="font-weight:700; margin-bottom:8px; color:var(--black);">0 views  Today</p>
                                <p id="w-desc" style="color:var(--text-light);">Description...</p>
                            </div>
                        </div>
            
                        <!-- COMMENTS SECTION -->
                        <div class="comments-section">
                            <h3 style="margin-bottom: 20px;" id="comment-count">Comments</h3>
                            <div class="comment-input-area">
                                <img id="my-avatar-comment" src="https://via.placeholder.com/40" class="chn-avatar">
                                <div>
                                    <input type="text" id="comment-text" placeholder="Add a comment...">
                                    <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                                        <button class="btn-primary" style="width:auto; padding:8px 24px; border-radius:20px;" onclick="postComment()">Comment</button>
                                    </div>
                                </div>
                            </div>
                            <div id="comment-list">
                                <!-- Dynamic Comments -->
                            </div>
                        </div>
                    </div> <!-- Closes .video-details-container -->
                </div> <!-- Closes .watch-main-col -->
    
                <!-- NEW Column 2: Up Next Sidebar -->
                <div class="watch-sidebar-col" id="up-next-container">
                    <!-- Recommended videos will be injected here by JavaScript -->
                </div>
    
            </div> <!-- Closes .watch-layout-grid -->
        </div>
    </div>

    <!-- STUDIO OVERLAY -->
    <div class="overlay-screen" id="studio-view" style="background:var(--bg-studio);">
        <div class="studio-layout">
            <div class="studio-nav">
                <div class="menu-item active" onclick="switchStudioTab('dashboard')" id="std-dash-btn">
                    <span class="material-symbols-rounded">dashboard</span> <span>Dashboard</span>
                </div>
                <div class="menu-item" onclick="switchStudioTab('shorts_analytics')" id="std-shorts-btn">
                    <span class="material-symbols-rounded">slow_motion_video</span> <span>Shorts Analytics</span>
                </div>
                <div class="menu-item" onclick="switchStudioTab('settings')" id="std-set-btn">
                    <span class="material-symbols-rounded">settings</span> <span>Settings</span>
                </div>
                <div class="menu-item" onclick="closeStudio()">
                    <span class="material-symbols-rounded">arrow_back</span> <span>Exit Studio</span>
                </div>
            </div>
            <div class="studio-main" id="studio-content-area"></div>
        </div>
    </div>
<!-- NEW: MOBILE SETTINGS BOTTOM SHEET -->
    <div id="mobile-settings-sheet-container">
        <div class="ms-overlay" onclick="toggleSettings()"></div>
        <div class="ms-sheet" onclick="event.stopPropagation()">
            <!-- The content here is a copy of the desktop settings-menu, but with unique IDs (ms- prefix) -->
            <!-- 1. Main Menu -->
            <div class="sm-view active" id="ms-main">
                <div class="sm-item" onclick="toggleSwitch('ambient-toggle')">
                    <div class="sm-left"><span class="material-symbols-rounded">blur_on</span> Ambient mode</div>
                    <div class="toggle-switch" id="ms-ambient-toggle"></div>
                </div>
                <div class="sm-item" onclick="toggleSwitch('annot-toggle')">
                    <div class="sm-left"><span class="material-symbols-rounded">subtitles_off</span> Annotations</div>
                    <div class="toggle-switch" id="ms-annot-toggle"></div>
                </div>
                <div class="sm-item" onclick="openSubMenu('subs')">
                    <div class="sm-left"><span class="material-symbols-rounded">closed_caption</span> Subtitles/CC</div>
                    <div class="sm-right">Off <span class="material-symbols-rounded">chevron_right</span></div>
                </div>
                <div class="sm-item" onclick="openSubMenu('sleep')">
                    <div class="sm-left"><span class="material-symbols-rounded">bedtime</span> Sleep timer</div>
                    <div class="sm-right">Off <span class="material-symbols-rounded">chevron_right</span></div>
                </div>
                <div class="sm-item" onclick="openSubMenu('speed')">
                    <div class="sm-left"><span class="material-symbols-rounded">slow_motion_video</span> Playback speed</div>
                    <div class="sm-right"><span id="ms-set-speed-val">Normal</span> <span class="material-symbols-rounded">chevron_right</span></div>
                </div>
                <div class="sm-item" onclick="openSubMenu('quality')">
                    <div class="sm-left"><span class="material-symbols-rounded">tune</span> Quality</div>
                    <div class="sm-right"><span id="ms-set-quality-val">Auto (1080p)</span> <span class="material-symbols-rounded">chevron_right</span></div>
                </div>
            </div>
            <!-- 2. Playback Speed Submenu -->
            <div class="sm-view" id="ms-speed">
                <div class="sm-header" onclick="backToMainSettings()"><span class="material-symbols-rounded">arrow_back</span> Playback speed</div>
                <div class="sm-item" onclick="changeSpeed(0.25)"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 0.25</div></div>
                <div class="sm-item" onclick="changeSpeed(0.5)"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 0.5</div></div>
                <div class="sm-item" onclick="changeSpeed(0.75)"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 0.75</div></div>
                <div class="sm-item selected" onclick="changeSpeed(1.0)"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> Normal</div></div>
                <div class="sm-item" onclick="changeSpeed(1.25)"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 1.25</div></div>
                <div class="sm-item" onclick="changeSpeed(1.5)"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 1.5</div></div>
                <div class="sm-item" onclick="changeSpeed(2.0)"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 2.0</div></div>
            </div>
            <!-- 3. Quality Submenu -->
            <div class="sm-view" id="ms-quality">
                <div class="sm-header" onclick="backToMainSettings()"><span class="material-symbols-rounded">arrow_back</span> Quality</div>
                <div class="sm-item selected" onclick="changeQuality('Auto (1080p)')"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> Auto (1080p)</div></div>
                <div class="sm-item" onclick="changeQuality('1080p')"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 1080p</div></div>
                <div class="sm-item" onclick="changeQuality('720p')"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 720p</div></div>
                <div class="sm-item" onclick="changeQuality('480p')"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 480p</div></div>
            </div>
            <!-- 4. Sleep Timer Submenu (Visual Only) -->
            <div class="sm-view" id="ms-sleep">
                <div class="sm-header" onclick="backToMainSettings()"><span class="material-symbols-rounded">arrow_back</span> Sleep Timer</div>
                <div class="sm-item selected"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> Off</div></div>
                <div class="sm-item"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 10 minutes</div></div>
                <div class="sm-item"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 15 minutes</div></div>
                <div class="sm-item"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> 30 minutes</div></div>
            </div>
            <!-- 5. Subtitles Submenu (Visual Only) -->
            <div class="sm-view" id="ms-subs">
                <div class="sm-header" onclick="backToMainSettings()"><span class="material-symbols-rounded">arrow_back</span> Subtitles</div>
                <div class="sm-item selected"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> Off</div></div>
                <div class="sm-item"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> English</div></div>
                <div class="sm-item"><div class="sm-left"><span class="material-symbols-rounded sm-check">check</span> Hindi</div></div>
            </div>
        </div>
    </div>
    <!-- ANALYTICS MODAL -->
    <div class="modal-wrap" id="analytics-modal">
        <div class="modal-box" style="max-width:800px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 id="modal-heading">Video Analytics</h2>
                <button class="icon-btn" onclick="closeModals()"><span class="material-symbols-rounded">close</span></button>
            </div>
            <h4 id="an-title" style="color:var(--text-light); margin-bottom:24px;">Video Title</h4>
            
            <div class="chart-wrapper green-bar-chart">
                <h5 style="margin-bottom:15px; color:#444;">Realtime (Last 24 Hours)</h5>
                <canvas id="realtimeChart"></canvas>
            </div>

            <div class="chart-wrapper">
                <h5 style="margin-bottom:15px; color:#444;">Performance (Total Views)</h5>
                <canvas id="perfChart"></canvas>
            </div>
        </div>
    </div>

    <!-- UPLOAD/EDIT MODAL -->
    <div class="modal-wrap" id="generic-modal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:24px;">
                <h2 id="modal-title" style="color:var(--primary-dark);">Upload Video</h2>
                <button class="icon-btn" onclick="closeModals()"><span class="material-symbols-rounded">close</span></button>
            </div>
            <input type="hidden" id="inp-id">
            <div class="inp-group">
                <label>Title</label>
                <input type="text" id="inp-title" placeholder="Video Title">
            </div>
            <div class="inp-group">
                <label>Thumbnail Image (Upload New)</label>
                <input type="file" id="inp-thumb-file" accept="image/*" style="padding: 10px; background: var(--secondary);">
                <!-- Hidden input to hold existing URL during edit mode -->
                <input type="hidden" id="inp-thumb">
            </div>
            <div class="inp-group">
                <label>Video File (Upload New)</label>
                <input type="file" id="inp-video-file" accept="video/*" style="padding: 10px; background: var(--secondary);">
                 <!-- Hidden input to hold existing URL during edit mode -->
                <input type="hidden" id="inp-url">
            </div>
           <div class="inp-group">
                <label>Duration (Auto-detected)</label>
                <input type="text" id="inp-dur" placeholder="Auto-filled after upload" readonly style="background: #e0e0e0; color: #666; cursor: not-allowed;">
            </div>
            <div class="inp-group">
                <label>Description</label>
                <textarea id="inp-desc" rows="3"></textarea>
            </div>

            <!-- NEW: Category Selector -->
            <div class="inp-group">
                <label>Category</label>
                <select id="inp-category">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <!-- NEW: Progress Bar Elements -->
            <div id="progress-wrapper" style="margin-bottom: 15px; display: none;">
                <div id="progress-text" style="font-size: 13px; color: var(--text-light); margin-bottom: 5px; text-align: center;">Uploading... 0%</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>
            
            <button class="btn-primary" onclick="submitVideoForm()" id="modal-btn">Save Video</button>
        </div>
    </div>

    <!-- SHORTS VIEWER -->
    <div class="overlay-screen" id="shorts-view" style="top:0; height:100vh; background:#0f0f0f; z-index:4000;">
        <!-- STATIC HEADER (Moved here from JS) -->
        <div class="shorts-header" style="position:fixed; z-index: 4005; background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);">
            <div class="shorts-header-left">
                <button class="icon-btn" style="color:white; background:transparent;" onclick="closeShortsViewer()">
                    <span class="material-symbols-rounded">arrow_back</span>
                </button>
                <h2>Shorts</h2>
            </div>
            <div class="shorts-header-right">
                <button class="icon-btn" style="color:white; background:transparent;"><span class="material-symbols-rounded">search</span></button>
                <button class="icon-btn" style="color:white; background:transparent;"><span class="material-symbols-rounded">more_vert</span></button>
            </div>
        </div>
        <!-- STATIC FILTER BAR (Moved here from JS) -->
         <div class="shorts-filter-bar" style="position:fixed; top: 56px; z-index: 4005;">
            <button class="sf-pill">Good vibes</button>
            <button class="sf-pill"><span class="material-symbols-rounded">subscriptions</span> Subscriptions</button>
            <button class="sf-pill"><span class="material-symbols-rounded">podcasts</span> Live</button>
        </div>

        <div id="shorts-container">
            <!-- Shorts slides will be injected here by JS -->
        </div>
    </div>

    <!-- PERSONAL CONTENT HUB (YOU TAB) -->
    <div class="overlay-screen" id="profile-hub-view" style="background: var(--bg-body); z-index: 2000;">
        <!-- The old header is GONE -->
        
        <!-- The content now contains the new profile block -->
        <div class="ph-content" style="height: 100vh;">
            
            <!-- NEW PROFILE BLOCK (Like Screenshot) -->
            <div class="ph-profile-block">
                <img id="ph-large-avatar" src="" class="ph-large-avatar">
                <h2 class="ph-main-name" id="ph-main-name">Username</h2>
                <div class="ph-handle-row">
                    <span id="ph-main-handle">@handle</span>
                    <span></span>
                    <span class="ph-view-channel-link" onclick="openStudio()">View channel</span>
                </div>
            </div>

            <!-- NEW ACTIONS ROW (Like Screenshot) -->
            <div class="ph-actions-row">
                 <!-- Sign Out button -->
                 <button class="ph-action-pill" onclick="handleLogout()">
                    <span class="material-symbols-rounded">logout</span>
                    <span>Sign Out</span>
                </button>
                 <!-- Incognito button -->
                 <button class="ph-action-pill" onclick="alert('Incognito mode coming soon')">
                    <img 
                        class="ph-action-icon-img" 
                        src="./incognito-icon.png"
                    >
                    <span>Turn on Incognito</span>
                </button>
            </div>


            <!-- History Section (Existing) -->
            <div class="ph-section">
                <div class="ph-section-header">
                    <span class="ph-title">History</span>
                    <button class="ph-view-all" onclick="openHistory()">View all</button>
                </div>
                <div class="ph-scroll-box" id="ph-history-list">
                    <!-- JS will populate -->
                </div>
            </div>

            <!-- Playlists Section (Existing) -->
            <div class="ph-section">
                <div class="ph-section-header">
                    <span class="ph-title">Playlists</span>
                    <button class="ph-view-all" onclick="openLikedVideos()">View all</button>
                </div>
                <div class="ph-scroll-box" id="ph-playlist-list">
                   <div class="ph-vid-card" onclick="openLikedVideos()">
                       <div class="ph-vid-thumb-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                           <span class="material-symbols-rounded" style="font-size:32px; color:white;">thumb_up</span>
                       </div>
                       <div class="ph-vid-title">Liked Videos</div>
                       <div class="ph-vid-meta" id="ph-liked-count">...</div>
                   </div>
                   <div class="ph-vid-card" onclick="alert('Watch Later feature coming soon!')">
                       <div class="ph-vid-thumb-box" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">
                           <span class="material-symbols-rounded" style="font-size:32px; color:white;">schedule</span>
                       </div>
                       <div class="ph-vid-title">Watch Later</div>
                       <div class="ph-vid-meta">0 videos</div>
                   </div>
                </div>
            </div>

            <!-- Menu Links (Existing) -->
            <div class="ph-menu-list">
                <div class="ph-menu-item" onclick="openStudio()">
                    <span class="material-symbols-rounded ph-menu-icon" style="color:var(--accent-red);">play_circle</span>
                    <div style="flex:1;">Your Videos</div>
                    <span class="material-symbols-rounded" style="color:var(--text-light);">chevron_right</span>
                </div>
                <div class="ph-menu-item" onclick="openProfileHub('downloads')">
                    <span class="material-symbols-rounded ph-menu-icon">download</span>
                    <div style="flex:1;">Downloads</div>
                    <span class="material-symbols-rounded" style="color:var(--text-light);">chevron_right</span>
                </div>
                <div class="ph-menu-item" onclick="openHelpCenter()">
                    <span class="material-symbols-rounded ph-menu-icon">help</span>
                    <div style="flex:1;">Help & Feedback</div>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div class="modal-wrap" id="auth-modal">
        <div class="modal-box" style="max-width:400px; text-align:center;">
            <span class="material-symbols-rounded" style="font-size:54px; color:var(--primary); margin-bottom:10px;">account_circle</span>
            <h2 id="auth-heading" style="margin:10px 0; color:var(--black);">Sign In</h2>
            <div class="inp-group" style="text-align:left;">
                <label>Email</label>
                <input type="email" id="auth-email">
            </div>
            <div class="inp-group" style="text-align:left;">
                <label>Password</label>
                <input type="password" id="auth-pass">
            </div>
            
            <!-- Forgot Password Button -->
            <div style="text-align: right; margin-bottom: 12px;">
                <span onclick="handleForgotPassword()" style="font-size:13px; color:var(--primary); cursor:pointer; font-weight:500;">Forgot Password?</span>
            </div>

            <button class="btn-primary" onclick="performAuth()" id="auth-submit">Sign In</button>
            
            <button class="google-btn" onclick="handleGoogleLogin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon">
                Sign in with Google
            </button>

            <p style="margin-top:20px; font-size:14px; cursor:pointer; color:var(--primary); font-weight:500;" onclick="toggleAuthMode()" id="auth-toggle">Create an account</p>
            <button class="icon-btn" onclick="closeModals()" style="position:absolute; top:15px; right:15px;"><span class="material-symbols-rounded">close</span></button>
        </div>
    </div>
<!-- MOBILE SEARCH OVERLAY (Full Screen) -->
<div id="mobile-search-overlay" class="mobile-search-overlay">
    <!-- Header with Pill UI (Matches Result Screen) -->
    <div class="sr-header" style="position: relative; border-bottom: 1px solid var(--border);">
        <button class="icon-btn" onclick="closeMobileSearch()">
            <span class="material-symbols-rounded">arrow_back</span>
        </button>
        
        <!-- Input Inside Pill -->
        <div class="sr-search-pill" style="cursor: text;">
            <input type="text" id="ms-input" placeholder="Search Yourtube" autocomplete="off" 
                   style="flex: 1; background: transparent; border: none; outline: none; font-size: 16px; color: var(--text-main); min-width: 0;"
                   oninput="handleMobileInput(this.value)" 
                   onkeydown="if(event.key === 'Enter') performMobileSearch(this.value)"
                   enterkeyhint="search">
            
            <!-- X Button clears text and keeps focus -->
            <button class="icon-btn-small" onclick="document.getElementById('ms-input').value = ''; document.getElementById('ms-input').focus(); renderSearchHistory();">
                <span class="material-symbols-rounded" style="font-size: 20px;">close</span>
            </button>
        </div>

        <button class="icon-btn mic-btn">
            <span class="material-symbols-rounded">mic</span>
        </button>
        
        <!-- No 3 Dots here -->
    </div>
    
    <!-- Suggestions / History List -->
    <div class="ms-content" id="ms-list">
        <!-- Javascript will populate this -->
    </div>
</div>

<!-- NEW MOBILE NOTIFICATIONS OVERLAY -->
<!-- FIX: Set Z-index lower (1999) than bottom nav (4001). Set height to calc(100vh - 58px) to expose the fixed bottom navigation bar -->
<div class="overlay-screen" id="mobile-notif-view" style="background: var(--bg-body); z-index: 1999; top: 0 !important; height: calc(100vh - 58px); display: none; flex-direction: column;">
    <!-- Header -->
    <div class="sr-header" style="justify-content: space-between; padding: 0 16px; border-bottom: none; flex-shrink: 0;">
        <div style="display:flex; align-items:center; gap: 16px;">
            <button class="icon-btn" onclick="document.getElementById('mobile-notif-view').style.display='none'">
                <span class="material-symbols-rounded">arrow_back</span>
            </button>
            <h2 style="font-size: 18px; font-weight: 500; color: var(--text-main);">Notifications</h2>
        </div>
        <div style="display:flex; gap: 8px;">
            <button class="icon-btn" onclick="document.getElementById('mobile-notif-view').style.display='none'; openMobileSearch();">
                <span class="material-symbols-rounded">search</span>
            </button>
            <button class="icon-btn"><span class="material-symbols-rounded">more_vert</span></button>
        </div>
    </div>

    <!-- Filter Chips (Added Margin Top) -->
    <div style="display:flex; gap:12px; padding: 0 16px 12px 16px; border-bottom: 1px solid var(--border); margin-top: 10px; flex-shrink: 0;">
        <button class="cat-pill active" id="btn-notif-all" onclick="switchNotifTab('all')" style="background: var(--text-main); color: var(--bg-body); border:none;">All</button>
        <button class="cat-pill" id="btn-notif-mentions" onclick="switchNotifTab('mentions')" style="background: var(--secondary); color: var(--text-main); border: 1px solid var(--border);">Mentions</button>
    </div>

    <!-- Notification List (Flex Grow takes remaining height, padding ensures scrolling looks good) -->
    <div id="mn-list" style="flex-grow: 1; overflow-y: auto; padding-bottom: 20px;"></div>
</div>

    <!-- JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, update, runTransaction, get, child } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
// --- MOBILE SEARCH LOGIC --- //

// 1. Open the Overlay
window.openMobileSearch = () => {
    document.getElementById('mobile-search-overlay').classList.add('active');
    document.getElementById('ms-input').focus();
    renderSearchHistory(); // Show history by default
    
    // Set initial UI state: Mic shown, X hidden
    const micBtn = document.querySelector('#mobile-search-overlay .mic-btn');
    const clearBtn = document.querySelector('#mobile-search-overlay .icon-btn-small');
    if (micBtn) micBtn.style.display = 'flex';
    if (clearBtn) clearBtn.style.display = 'none';
}

// 2. Close the Overlay
window.closeMobileSearch = () => {
    document.getElementById('mobile-search-overlay').classList.remove('active');
    // Clear input when closing
    document.getElementById('ms-input').value = "";
}

// 3. Handle Typing (Modified for Mic/X visibility)
window.handleMobileInput = (val) => {
    const micBtn = document.querySelector('#mobile-search-overlay .mic-btn');
    const clearBtn = document.querySelector('#mobile-search-overlay .icon-btn-small');
    
    if (!val.trim()) {
        // Empty Input State
        if (micBtn) micBtn.style.display = 'flex'; // Show mic
        if (clearBtn) clearBtn.style.display = 'none'; // Hide X
        renderSearchHistory();
    } else {
        // Typing State (even one letter)
        if (micBtn) micBtn.style.display = 'none'; // Hide mic
        if (clearBtn) clearBtn.style.display = 'flex'; // Show X
        renderSuggestions(val);
    }
}

// 4. Render History (from LocalStorage)
function renderSearchHistory() {
// ... (rest of renderSearchHistory function - NO CHANGE NEEDED)
    const list = document.getElementById('ms-list');
    list.innerHTML = "";
    
    let history = JSON.parse(localStorage.getItem('yt_search_history')) || [];
    
    if (history.length === 0) {
        list.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-light); font-size:14px;">No recent searches</div>`;
        return;
    }

    history.forEach((term, index) => {
        const div = document.createElement('div');
        div.className = 'ms-item';
        div.innerHTML = `
            <div class="ms-item-left" onclick="performMobileSearch('${term}')">
                <span class="material-symbols-rounded ms-icon">history</span>
                <span class="ms-text">${term}</span>
            </div>
            <div class="ms-delete" onclick="deleteHistoryItem(${index})">Remove</div>
        `;
        list.appendChild(div);
    });
}

// 5. Render Suggestions (from Video Titles)
function renderSuggestions(query) {
    const list = document.getElementById('ms-list');
    list.innerHTML = "";
    const q = query.toLowerCase();

    // Get unique titles that match
    const suggestions = [];
    Object.values(allVideos).forEach(v => {
        if (v.title.toLowerCase().includes(q)) {
            if (!suggestions.includes(v.title)) suggestions.push(v.title);
        }
    });

    suggestions.slice(0, 10).forEach(term => {
        const div = document.createElement('div');
        div.className = 'ms-item';
        div.innerHTML = `
            <div class="ms-item-left" onclick="performMobileSearch('${term}')">
                <span class="material-symbols-rounded ms-icon">search</span>
                <span class="ms-text">${term.replace(new RegExp(q, "gi"), (match) => `<b>${match}</b>`)}</span>
            </div>
            <span class="material-symbols-rounded ms-arrow">arrow_outward</span>
        `;
        list.appendChild(div);
    });
}

// --- ADVANCED SEARCH LOGIC (Results Screen + Filters) ---

    // Global variable to hold current search results for sorting
    let currentSearchResults = []; 

    window.performMobileSearch = (term) => {
        if (!term) return;
        
        // 1. Save History to LocalStorage
        let history = JSON.parse(localStorage.getItem('yt_search_history')) || [];
        history = history.filter(h => h !== term); // Remove duplicate if exists
        history.unshift(term); // Add to top
        if(history.length > 10) history.pop(); // Keep max 10
        localStorage.setItem('yt_search_history', JSON.stringify(history));

        // 2. Close Input Overlay & Clear Inputs
        if(document.getElementById('mobile-search-overlay')) {
            closeMobileSearch();
            document.getElementById('ms-input').value = ""; // Clear mobile input
        }
        document.getElementById('search-input').value = ""; // Clear desktop input

        // 3. Open the NEW Search Results Screen
        const resultsView = document.getElementById('search-results-view');
        resultsView.style.display = 'block';
        
        // Update Header Text
        document.getElementById('sr-query-display').innerText = term;
        
        // Ensure filter menu is closed initially
        document.getElementById('filter-dropdown').style.display = 'none'; 
        
        // 4. Perform the Search Logic
        const query = term.toLowerCase();
        currentSearchResults = []; // Reset global results
        
        // Search in Title AND Description
        Object.entries(allVideos).forEach(([id, v]) => {
            const titleMatch = v.title.toLowerCase().includes(query);
            const descMatch = v.description && v.description.toLowerCase().includes(query);
            
            if(titleMatch || descMatch) {
                currentSearchResults.push({...v, id: id});
            }
        });

        // Render the results
        renderSearchResults(currentSearchResults);
    }

    // --- RENDER FUNCTION SPECIFIC TO SEARCH SCREEN ---
    window.renderSearchResults = (videos) => {
        const grid = document.getElementById('search-results-grid');
        grid.innerHTML = "";

        if(videos.length === 0) {
            grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:var(--text-light);">No results found.</div>`;
            return;
        }

        const shorts = videos.filter(v => isShort(v));
        const regularVideos = videos.filter(v => !isShort(v));
        let finalHTML = '';

        // RENDER SHORTS SHELF
        if (shorts.length > 0) {
            finalHTML += `
            <div class="shorts-shelf">
                <div class="shorts-shelf-title">
                    <span class="material-symbols-rounded">slow_motion_video</span>
                    <span>Shorts</span>
                </div>
                <div class="shorts-scroll-container">
            `;
            shorts.forEach(s => {
                finalHTML += `
                    <div class="short-card" onclick="handleVideoClick('${s.id}')">
                        <img src="${s.thumbnail}" onerror="this.src='https://via.placeholder.com/360x640'">
                        <div class="short-card-overlay">
                            <div class="short-card-title">${s.title}</div>
                            <div class="short-card-views">${formatViews(s.views)} views</div>
                        </div>
                    </div>
                `;
            });
            finalHTML += `</div></div><hr style="border:0; border-top:1px solid var(--border); margin:24px 0; grid-column: 1 / -1;">`;
        }
        
        // RENDER REGULAR VIDEOS
        regularVideos.forEach(v => {
            finalHTML += `
                <div class="card" onclick="handleVideoClick('${v.id}')">
                    <div class="thumb-box">
                        <img src="${v.thumbnail}" onerror="this.src='https://via.placeholder.com/640x360'">
                        <div class="dur-badge">${v.duration || '00:00'}</div>
                    </div>
                    <div class="meta-flex">
                        <img src="https://ui-avatars.com/api/?name=${v.uploader}&background=random" class="chn-avatar" style="width:32px; height:32px;">
                        <div class="meta-text">
                            <h3>${v.title}</h3>
                            <p style="font-size:13px; color:var(--text-light); margin-top:2px;">${v.uploader}</p>
                            <p style="font-size:12px; color:var(--text-light);">${formatViews(v.views)} views  ${timeAgo(v.timestamp)}</p>
                        </div>
                    </div>
                </div>
            `;
        });
        
        grid.innerHTML = finalHTML;
    }

    // --- CLOSE RESULTS SCREEN ---
    window.closeSearchResults = () => {
        document.getElementById('search-results-view').style.display = 'none';
    }

    // --- 3 DOTS MENU LOGIC ---
    window.toggleFilterMenu = () => {
        const menu = document.getElementById('filter-dropdown');
        // Toggle Flex/None
        menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
    }

    // --- SORTING LOGIC ---
    window.sortResults = (type) => {
        // Create a shallow copy of the array so we don't mutate the original order permanently
        let sorted = [...currentSearchResults]; 
        
        if(type === 'newest') {
            sorted.sort((a,b) => b.timestamp - a.timestamp);
        } else if(type === 'oldest') {
            sorted.sort((a,b) => a.timestamp - b.timestamp);
        } else if(type === 'views') {
            sorted.sort((a,b) => (b.views || 0) - (a.views || 0));
        }
        
        // Re-render the grid with sorted data
        renderSearchResults(sorted);
        
        // Close the menu
        document.getElementById('filter-dropdown').style.display = 'none'; 
    }

// 7. Delete History Item
window.deleteHistoryItem = (index) => {
    let history = JSON.parse(localStorage.getItem('yt_search_history')) || [];
    history.splice(index, 1);
    localStorage.setItem('yt_search_history', JSON.stringify(history));
    renderSearchHistory(); // Re-render list
}
      const firebaseConfig = {


 apiKey: "AIzaSyDSCl7Zln2M-GokSuKpH5qulqOGnjh2hGQ",


 authDomain: "fir-edf2c.firebaseapp.com",


 projectId: "fir-edf2c",


 storageBucket: "fir-edf2c.firebasestorage.app",


 messagingSenderId: "48734777718",


 appId: "1:48734777718:web:78518d9d408766c76d0a57"


};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // --- STATE ---
        let user = null;
        let allVideos = {};
        let currentVidId = null;
        let currentUploader = null;
        let isLogin = true;
        let charts = {}; 
        let studioTab = 'dashboard';
        let currentCategory = 'All';
        let allShorts = [];
        let currentShortIndex = -1;

        // --- DOM ELEMENTS ---
        const grid = document.getElementById('video-grid');
        const authSec = document.getElementById('auth-section');

        // Check Local Storage for Theme
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
// --- CUSTOM PLAYER LOGIC (V3 - With Double Tap) ---
        const playerContainer = document.getElementById('player-container');
        const video = document.getElementById('main-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const muteBtn = document.getElementById('mute-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const progressContainer = document.getElementById('progress-container');
        const progressBarFilled = document.getElementById('progress-bar-filled');
        const timeDisplay = document.getElementById('time-display');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const controlsOverlay = document.getElementById('controls-overlay');
        const indicator = document.getElementById('play-pause-indicator');
        
        // --- NEW Elements for Seek (Removed) ---
        
        // --- State ---
        let isScrubbing = false;

        // --- Helper Functions ---
        const formatTime = (time) => {
            if (isNaN(time)) return '00:00';
            const minutes = Math.floor(time / 60);
            const seconds = Math.floor(time % 60);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        const showIndicator = (icon) => {
            indicator.querySelector('span').textContent = icon;
            indicator.classList.add('visible');
            setTimeout(() => indicator.classList.remove('visible'), 500);
        }
        
        

        // --- Core Player Functions ---
        window.togglePlay = () => {
            if (video.paused) {
                video.play();
                showIndicator('play_arrow');
            } else {
                video.pause();
                showIndicator('pause');
            }
        }

        window.toggleMute = () => { video.muted = !video.muted; }

        window.toggleFullScreen = () => {
            const playerContainer = document.getElementById('player-container');
            const videoElement = document.getElementById('main-player'); // Fallback for iOS
            const isMobile = window.innerWidth <= 768;

            // Check if currently in fullscreen (Standard + Vendor Prefixes)
            const isFullscreen = document.fullscreenElement || 
                                 document.webkitFullscreenElement || 
                                 document.mozFullScreenElement || 
                                 document.msFullscreenElement ||
                                 (videoElement && videoElement.webkitDisplayingFullscreen); // Specific iOS check

            if (!isFullscreen) {
                // --- ENTER FULLSCREEN ---
                // Try standard first
                if (playerContainer.requestFullscreen) {
                    playerContainer.requestFullscreen().catch(err => console.log("Standard FS failed, trying fallback", err));
                } 
                // Safari / Chrome (older) / Edge
                else if (playerContainer.webkitRequestFullscreen) {
                    playerContainer.webkitRequestFullscreen();
                } 
                // Firefox
                else if (playerContainer.mozRequestFullScreen) {
                    playerContainer.mozRequestFullScreen();
                } 
                // IE/Edge
                else if (playerContainer.msRequestFullscreen) {
                    playerContainer.msRequestFullscreen();
                } 
                // iOS SAFARI FALLBACK (iOS only allows fullscreen on the VIDEO element, not the div)
                else if (videoElement && videoElement.webkitEnterFullscreen) {
                    videoElement.webkitEnterFullscreen();
                }

                // Mobile: Attempt to lock orientation
                if (isMobile && screen.orientation && screen.orientation.lock) {
                    try { 
                        screen.orientation.lock('landscape').catch(() => {}); 
                    } catch(e) {}
                }

            } else {
                // --- EXIT FULLSCREEN ---
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else if (videoElement && videoElement.webkitExitFullscreen) {
                    videoElement.webkitExitFullscreen();
                }

                // Mobile: Unlock orientation
                if (isMobile && screen.orientation && screen.orientation.unlock) {
                    try { 
                        screen.orientation.unlock(); 
                    } catch(e) {}
                }
            }
        }

        // --- UI Update Functions ---
        const updatePlayIcon = () => {
            playPauseBtn.innerHTML = `<span class="material-symbols-rounded">${video.paused ? 'play_arrow' : 'pause'}</span>`;
        }

        const updateProgress = () => {
            if (!isScrubbing && video.duration) {
                const progress = (video.currentTime / video.duration) * 100;
                progressBarFilled.style.width = `${progress}%`;
            }
            timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
        }

        const updateVolumeIcon = () => {
             const icon = video.muted || video.volume === 0 ? 'volume_off' : video.volume > 0.5 ? 'volume_up' : 'volume_down';
             muteBtn.innerHTML = `<span class="material-symbols-rounded">${icon}</span>`;
             if (video.muted) volumeSlider.value = 0;
             else volumeSlider.value = video.volume;
        }

        const updateFullscreenIcon = () => {
            const isFullscreen = document.fullscreenElement || 
                                 document.webkitFullscreenElement || 
                                 document.mozFullScreenElement || 
                                 document.msFullscreenElement;
            const icon = isFullscreen ? 'fullscreen_exit' : 'fullscreen';
            fullscreenBtn.innerHTML = `<span class="material-symbols-rounded">${icon}</span>`;
        }

        // --- NEW: SETTINGS, PRESS-HOLD & SEEK LOGIC (V2 with Mobile Sheet) ---
        let currentSpeed = 1.0;
        let isLooping = false;
        let pressTimer;
        let isLongPressing = false;
        let lastTapTime = 0;
        let tapTimeout;
        
        // 1. Settings Functions (Now handle both Desktop and Mobile)
        window.toggleSwitch = (desktopId) => {
            const mobileId = 'ms-' + desktopId; // e.g., 'ambient-toggle' -> 'ms-ambient-toggle'
            const desktopEl = document.getElementById(desktopId);
            const mobileEl = document.getElementById(mobileId);
            
            const isOn = desktopEl.classList.contains('on');
            
            if (isOn) {
                desktopEl.classList.remove('on');
                mobileEl.classList.remove('on');
            } else {
                desktopEl.classList.add('on');
                mobileEl.classList.add('on');
            }
        }
        
        window.toggleSettings = () => {
            // Check screen size to decide which menu to open
            if (window.innerWidth <= 768) {
                // Mobile: Toggle the bottom sheet
                const sheetContainer = document.getElementById('mobile-settings-sheet-container');
                sheetContainer.classList.toggle('active');
                // Always reset to the main view when opening/closing
                if (sheetContainer.classList.contains('active')) {
                     backToMainSettings();
                }
            } else {
                // Desktop: Toggle the in-player menu
                const menu = document.getElementById('settings-menu');
                menu.classList.toggle('active');
                if (!menu.classList.contains('active')) {
                    setTimeout(() => backToMainSettings(), 200);
                }
            }
        }

        window.openSubMenu = (id) => {
            // Hide main menus in both desktop and mobile
            document.querySelectorAll('#sm-main, #ms-main').forEach(el => el.classList.remove('active'));
            // Show the correct submenu in both
            document.querySelectorAll(`#sm-${id}, #ms-${id}`).forEach(el => el.classList.add('active'));
        }

        window.backToMainSettings = () => {
            // Hide all submenus in both desktop and mobile
            document.querySelectorAll('.settings-menu .sm-view, .ms-sheet .sm-view').forEach(el => el.classList.remove('active'));
            // Show only the main menus in both
            document.querySelectorAll('#sm-main, #ms-main').forEach(el => el.classList.add('active'));
        }

        window.changeSpeed = (speed) => {
            currentSpeed = speed;
            video.playbackRate = speed;
            const speedText = speed === 1.0 ? 'Normal' : speed + 'x';

            // Update text value in both menus
            document.getElementById('set-speed-val').innerText = speedText;
            document.getElementById('ms-set-speed-val').innerText = speedText;

            // Update checkmarks in both menus
            document.querySelectorAll('#sm-speed .sm-item, #ms-speed .sm-item').forEach(el => el.classList.remove('selected'));
            if(event && event.currentTarget) {
                // Find the corresponding item in the other menu to also update it
                const clickedText = event.currentTarget.innerText.trim();
                document.querySelectorAll('#sm-speed .sm-item, #ms-speed .sm-item').forEach(item => {
                    if (item.innerText.trim() === clickedText) {
                        item.classList.add('selected');
                    }
                });
            }

            backToMainSettings();
        }

        // Global variable to store the selected quality (e.g., 'Auto (1080p)')
        let currentQuality = 'Auto (1080p)';

        window.changeQuality = (q) => {
            // 1. Update Global State
            currentQuality = q;
            
            // 2. Update UI text value in both menus
            document.getElementById('set-quality-val').innerText = q;
            document.getElementById('ms-set-quality-val').innerText = q;

            // 3. Update checkmarks in both menus
            document.querySelectorAll('#sm-quality .sm-item, #ms-quality .sm-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('#ms-quality .sm-item, #sm-quality .sm-item').forEach(item => {
                if (item.innerText.trim().includes(q)) {
                    item.classList.add('selected');
                }
            });

            // 4. --- REAL, FUNCTIONAL QUALITY CHANGE IMPLEMENTATION ---
            const videoElement = document.getElementById('main-player');
            if (!videoElement || !currentVidId || !allVideos[currentVidId]) {
                backToMainSettings(); // Still close menu even if something is wrong
                return;
            }

            // A. Store the player's current state
            const currentTime = videoElement.currentTime;
            const wasPaused = videoElement.paused;

            // B. Get the original, untransformed URL from our data source
            const originalUrl = allVideos[currentVidId].videoUrl;
            const baseUrlParts = originalUrl.split('/upload/');
            
            // Safety check for URL format
            if (baseUrlParts.length !== 2) {
                console.error("Cannot change quality: Unexpected Cloudinary URL format.", originalUrl);
                backToMainSettings();
                return;
            }

            let newUrl = '';
            let transformation = '';

            // C. Determine the correct Cloudinary transformation string
            if (q.includes('1080p')) {
                transformation = 'h_1080,c_scale';
            } else if (q.includes('720p')) {
                transformation = 'h_720,c_scale';
            } else if (q.includes('480p')) {
                transformation = 'h_480,c_scale';
            } else {
                // For "Auto", we use the original URL without any height transformations.
                // This assumes the original upload is the highest quality.
                newUrl = originalUrl;
            }

            // D. Construct the new URL if a transformation is needed
            if (transformation) {
                // This inserts the transformation string into the URL.
                // e.g., .../upload/h_720,c_scale/v12345/video.mp4
                newUrl = `${baseUrlParts[0]}/upload/${transformation}/${baseUrlParts[1]}`;
            }

            // E. Apply the new source and restore playback state
            videoElement.src = newUrl;
            
            // F. Wait for the new video metadata to load, then seek and play
            videoElement.onloadedmetadata = () => {
                videoElement.currentTime = currentTime;
                if (!wasPaused) {
                    videoElement.play().catch(e => console.error("Play after quality change failed:", e));
                }
                // Important: Remove the event listener after it runs once to avoid issues.
                videoElement.onloadedmetadata = null; 
            };
            
            // 5. Close the settings menu
            backToMainSettings();
        }

        // Close settings if clicking outside
        document.addEventListener('click', (e) => {
            const desktopMenu = document.getElementById('settings-menu');
            const mobileSheetContainer = document.getElementById('mobile-settings-sheet-container');
            
            // Close desktop menu if open and click is outside
            if (desktopMenu.classList.contains('active') && !desktopMenu.contains(e.target) && !e.target.closest('button[onclick*="toggleSettings"]')) {
                toggleSettings();
            }

            // Close mobile sheet if click is on the overlay
            if (mobileSheetContainer.classList.contains('active') && e.target.classList.contains('ms-overlay')) {
                toggleSettings();
            }
        });

        // 2. Press & Hold Logic
        const startPress = (e) => {
            if(document.getElementById('settings-menu').classList.contains('active')) return;
            if(e.target.closest('button, .settings-menu, .progress-container')) return;

            pressTimer = setTimeout(() => {
                isLongPressing = true;
                video.playbackRate = 2.0;
                document.getElementById('speed-overlay').classList.add('visible');
                playerContainer.classList.add('scrubbing'); // reusing class to hide controls
            }, 500); 
        }

        const endPress = () => {
            clearTimeout(pressTimer);
            if (isLongPressing) {
                isLongPressing = false;
                video.playbackRate = currentSpeed;
                document.getElementById('speed-overlay').classList.remove('visible');
                playerContainer.classList.remove('scrubbing');
            }
        }

        // 3. Double Tap Seek
        const triggerDoubleTapSeek = (direction) => {
            const overlay = document.getElementById(direction === 'forward' ? 'seek-overlay-right' : 'seek-overlay-left');
            if (direction === 'forward') video.currentTime = Math.min(video.duration, video.currentTime + 10);
            else video.currentTime = Math.max(0, video.currentTime - 10);
            
            overlay.classList.add('active');
            setTimeout(() => overlay.classList.remove('active'), 600);
        }

        // --- UPDATED: Master Click Handler ---
        playerContainer.addEventListener('mousedown', startPress);
        playerContainer.addEventListener('touchstart', startPress, {passive: true});
        playerContainer.addEventListener('mouseup', endPress);
        playerContainer.addEventListener('touchend', endPress);
        playerContainer.addEventListener('mouseleave', endPress);

        const handlePlayerClick = (e) => {
            if (isLongPressing) return;
            if (e.target.closest('button, input, .progress-container, .float-back-btn, .settings-menu')) return;

            const rect = playerContainer.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0)) - rect.left;
            const width = rect.width;
            
            const isLeft = x < (width * 0.3);
            const isRight = x > (width * 0.7);
            
            if (!isLeft && !isRight) {
                togglePlay();
                if(video.paused) showControls();
                return;
            }

            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;
            
            if (tapLength < 300 && tapLength > 0) {
                clearTimeout(tapTimeout);
                if (isLeft) triggerDoubleTapSeek('rewind');
                if (isRight) triggerDoubleTapSeek('forward');
            } else {
                tapTimeout = setTimeout(() => {
                    if(document.getElementById('settings-menu').classList.contains('active')) {
                        toggleSettings();
                    } else if (controlsOverlay.classList.contains('hidden')) {
                        showControls();
                    } else {
                        hideControls();
                    }
                }, 300);
            }
            lastTapTime = currentTime;
        };

        // --- Event Handlers ---
        const handleVolumeChange = () => {
            video.volume = volumeSlider.value;
            video.muted = volumeSlider.value == 0;
        }
        
        const scrub = (e) => {
            const rect = progressContainer.getBoundingClientRect();
            const positionX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            let progress = positionX / rect.width;
            progress = Math.max(0, Math.min(1, progress));
            
            progressBarFilled.style.width = `${progress * 100}%`;
            video.currentTime = progress * video.duration;
        }

        const handleKeydown = (e) => {
            if (document.getElementById('watch-view').style.display !== 'block') return;
            // Prevent default behavior for space/arrows only if the player is active
            if ([' ', 'ArrowUp', 'ArrowDown', 'f', 'm'].includes(e.key)) e.preventDefault();
            switch (e.key.toLowerCase()) {
                case ' ': case 'k': togglePlay(); break;
                case 'm': toggleMute(); break;
                case 'f': toggleFullScreen(); break;
                // Removed seeking controls
                case 'arrowup': video.volume = Math.min(1, video.volume + 0.1); volumeSlider.value = video.volume; break;
                case 'arrowdown': video.volume = Math.max(0, video.volume - 0.1); volumeSlider.value = video.volume; break;
            }
        }

        let controlsTimeout;
        
        const hideControls = () => {
            // Hide Bottom Controls
            controlsOverlay.classList.add('hidden');
            
            // Hide Top Mobile Settings Button
            const mobileBtn = document.getElementById('mobile-settings-btn');
            if(mobileBtn) mobileBtn.classList.add('hidden');
            
            // NEW: Hide Top Left Back Button
            const backBtn = document.querySelector('.float-back-btn');
            if(backBtn) backBtn.style.opacity = 0;
        };

        const showControls = () => {
            // Show Bottom Controls
            controlsOverlay.classList.remove('hidden');
            
            // Show Top Mobile Settings Button
            const mobileBtn = document.getElementById('mobile-settings-btn');
            if(mobileBtn) mobileBtn.classList.remove('hidden');

            // NEW: Show Top Left Back Button
            const backBtn = document.querySelector('.float-back-btn');
            if(backBtn) backBtn.style.opacity = 1;

            clearTimeout(controlsTimeout);
            if (!video.paused) {
                controlsTimeout = setTimeout(hideControls, 3000);
            }
        }

        const handleScrubStart = (e) => {
            e.preventDefault();
            isScrubbing = true;
            playerContainer.classList.add('scrubbing');
            scrub(e);
            
            document.addEventListener('mousemove', scrub);
            document.addEventListener('touchmove', scrub);
            document.addEventListener('mouseup', handleScrubEnd);
            document.addEventListener('touchend', handleScrubEnd);
        };

        const handleScrubEnd = () => {
            isScrubbing = false;
            playerContainer.classList.remove('scrubbing');
            showControls();
            
            document.removeEventListener('mousemove', scrub);
            document.removeEventListener('touchmove', scrub);
            document.removeEventListener('mouseup', handleScrubEnd);
            document.removeEventListener('touchend', handleScrubEnd);
        };

        // --- Event Listeners ---
        video.addEventListener('play', updatePlayIcon);
        video.addEventListener('pause', updatePlayIcon);
        video.addEventListener('timeupdate', updateProgress);
        video.addEventListener('volumechange', updateVolumeIcon);
        video.addEventListener('loadedmetadata', updateProgress);
        
        // --- FIX: Prevent default context menu (right-click / long-press) ---
        video.addEventListener('contextmenu', (e) => e.preventDefault());
        
        volumeSlider.addEventListener('input', handleVolumeChange);
        document.addEventListener('fullscreenchange', updateFullscreenIcon);
        document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
        document.addEventListener('keydown', handleKeydown);
        playerContainer.addEventListener('mousemove', showControls);
        playerContainer.addEventListener('mouseleave', () => clearTimeout(controlsTimeout));
        video.addEventListener('play', showControls);
        video.addEventListener('pause', showControls);

        progressContainer.addEventListener('mousedown', handleScrubStart);
        progressContainer.addEventListener('touchstart', handleScrubStart, { passive: true });
        
        // NEW: This single event listener now handles single and double taps on the video area.
        playerContainer.addEventListener('click', handlePlayerClick);
        // --- CATEGORIES ---
        const categories = ["All", "Music", "Gaming", "Code", "News", "Sports", "Live", "Learning", "Java", "Python", "Vlogs", "Comedy"];
        
        // --- NEW FUNCTION: Populate Category Select ---
        function populateCategorySelect(selectedCategory = 'Learning') {
            const select = document.getElementById('inp-category');
            if (!select) return;

            // Filter out "All" category for content upload/edit
            const uploadCategories = categories.filter(cat => cat !== 'All');
            
            select.innerHTML = uploadCategories.map(cat => 
                // Note: The value and the text displayed are the same
                `<option value="${cat}" ${cat === selectedCategory ? 'selected' : ''}>${cat}</option>`
            ).join('');
        }
        // --- END NEW FUNCTION ---
        
        // NEW: Keyword dictionary for smarter filtering. Add any related words here.
        // All keywords should be lowercase.
        const categoryKeywords = {
            'Music': [
                // Generic Terms
                'music', 'song', 'official video', 'lyrics', 'album', 'concert', 'live performance', 'cover', 'remix', 'playlist', 'bhajan', 'qawwali',
                // Specific Song/Artist Names (add more as needed!)
                'saiyara', 'nagin', 'shiv', 'kesariya', 'adele', 'arijit singh'
            ],
            'Gaming': ['gaming', 'gameplay', 'let\'s play', 'walkthrough', 'speedrun', 'esports', 'fortnite', 'minecraft', 'valorant', 'roblox', 'ps5', 'xbox'],
            'Code': ['code', 'programming', 'tutorial', 'javascript', 'python', 'java', 'react', 'angular', 'vue', 'nodejs', 'html', 'css', 'coding', 'software development'],
            'News': ['news', 'breaking', 'headlines', 'politics', 'world news', 'interview', 'report'],
            'Sports': ['sports', 'highlights', 'nba', 'nfl', 'football', 'basketball', 'soccer', 'match'],
            'Live': ['live', 'livestream', 'live now', 'stream'],
            'Learning': ['learning', 'educational', 'documentary', 'how to', 'science', 'history', 'learn'],
            'Java': ['java', 'spring boot', 'java tutorial', 'jsp', 'servlet'],
            'Python': ['python', 'django', 'flask', 'data science', 'machine learning', 'python tutorial'],
            'Vlogs': ['vlog', 'daily vlog', 'travel vlog', 'a day in the life'],
            'Comedy': ['comedy', 'funny', 'stand up', 'sketch', 'parody', 'satire']
        };

        const catContainer = document.getElementById('category-bar');
        
        // Render Colorful Bubbles
        categories.forEach((cat, index) => {
            const btn = document.createElement('button');
            btn.innerText = cat;
            btn.className = 'cat-pill';
            if(index === 0) btn.classList.add('active');
            
            // Assign random colorful gradients for bubbles
            const colors = [
                'linear-gradient(135deg, #FF9A9E, #FECFEF)',
                'linear-gradient(135deg, #a18cd1, #fbc2eb)',
                'linear-gradient(135deg, #84fab0, #8fd3f4)',
                'linear-gradient(135deg, #cfd9df, #e2ebf0)', // Grayish
                'linear-gradient(135deg, #a6c0fe, #f68084)',
                'linear-gradient(135deg, #fccb90, #d57eeb)',
                'linear-gradient(135deg, #e0c3fc, #8ec5fc)',
                'linear-gradient(135deg, #f093fb, #f5576c)',
                'linear-gradient(135deg, #4facfe, #00f2fe)',
                'linear-gradient(135deg, #43e97b, #38f9d7)'
            ];
            
            // "All" is black/white, others are colorful
            if(cat !== "All") {
                 btn.style.background = colors[index % colors.length];
                 btn.style.color = "#0f0f0f"; // Dark text for light pastels
            } else {
                 btn.style.background = "var(--black)";
            }

            btn.onclick = () => {
                document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCategory = cat;
                renderGrid(allVideos);
            };
            catContainer.appendChild(btn);
        });

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, (u) => {
            user = u;
            const youBtn = document.getElementById('btn-nav-you');
            
            if(u) {
                const displayName = u.displayName ? u.displayName : u.email.split('@')[0];
                const letter = displayName[0].toUpperCase();
                // Desktop Nav Update
                authSec.innerHTML = `<div class="avatar" onclick="openStudio()" title="${displayName}">${letter}</div>`;
                document.getElementById('logout-btn').style.display = 'block';
                const photo = u.photoURL ? u.photoURL : `https://ui-avatars.com/api/?name=${displayName}&background=random`;
                document.getElementById('my-avatar-comment').src = photo;
                
                // Bottom Nav Update (Mobile)
                youBtn.innerHTML = `<img src="${photo}" class="b-avatar"><span>You</span>`;
                
                loadSidebarSubscriptions(u.uid);
            } else {
                // Desktop Nav Reset
                authSec.innerHTML = `<button class="auth-btn" onclick="openAuth()"><span class="material-symbols-rounded">account_circle</span> Sign in</button>`;
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('sub-list-container').innerHTML = `<div style="padding: 0 12px; font-size: 13px; color: var(--text-light);">Sign in to see subscriptions</div>`;
                
                // Bottom Nav Reset (Mobile)
                youBtn.innerHTML = `<span class="material-symbols-rounded" id="b-nav-icon">account_circle</span><span>You</span>`;
                
                if(document.getElementById('studio-view').style.display === 'block') closeStudio();
            }
        });

        // --- LOAD VIDEOS & NOTIFICATIONS ---
        onValue(ref(db, 'videos'), async (snap) => {
            allVideos = snap.val() || {};
            
            // Re-render the main grid if on the home page
            if(document.getElementById('page-heading').innerText === 'Home') {
                renderGrid(allVideos);
            }
            
            // --- NEW & STRICTER SUBSCRIPTION-BASED NOTIFICATION LOGIC ---
            const notifList = document.getElementById('notif-list');
            notifList.innerHTML = "";
            
            let videosForNotifs = [];

            // STEP 1: ONLY proceed if the user is logged in.
            if (user) {
                // For logged-in users, get their subscriptions
                const subsSnap = await get(ref(db, `users/${user.uid}/subscriptions`));
                const subs = subsSnap.val();

                // STEP 2: ONLY proceed if the user has at least one subscription.
                if (subs) {
                    const subNames = Object.keys(subs);
                    // Filter all videos to only include those from subscribed channels
                    videosForNotifs = Object.entries(allVideos)
                        .map(([id, v]) => ({ ...v, id })) // Add the video ID to the object
                        .filter(v => subNames.includes(v.uploader));
                }
                // If user has no subscriptions, videosForNotifs will remain empty.
            }
            // The `else` block for logged-out users has been removed intentionally.

            // Sort all potential notification videos by timestamp (newest first) and take the top 5
            const finalNotifs = videosForNotifs
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 5);
                
            // --- RENDER THE FINAL NOTIFICATIONS ---
            if (finalNotifs.length > 0) {
                finalNotifs.forEach(v => {
                    const isS = isShort(v);
                    const imgStyle = isS 
                        ? "width: 64px; height: 36px; object-fit: contain; background: #000;" 
                        : "width: 64px; height: 36px; object-fit: cover;";
                    
                    notifList.innerHTML += `
                        <div class="notif-item" onclick="handleVideoClick('${v.id}')">
                            <img src="${v.thumbnail}" style="${imgStyle} border-radius: 4px;">
                            <div>
                                <div style="font-size:14px; font-weight:600; color:var(--text-main); line-height: 1.2;">${v.title}</div>
                                <div style="font-size:12px; color:var(--text-light); margin-top: 2px;">${v.uploader}</div>
                            </div>
                        </div>
                    `;
                });
            } else {
                // Display a helpful, context-aware message if there are no notifications
                let message = "";
                if (!user) {
                    message = "Sign in to see notifications from your favorite channels.";
                } else {
                    message = "No new videos from your subscriptions. Subscribe to channels to get notified!";
                }
                notifList.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--text-light); font-size: 13px;">${message}</div>`;
            }

            // --- UPDATE NOTIFICATION BADGE VISIBILITY ---
            // This will now correctly hide the badge for logged-out users or users without new subscription content.
            const showBadge = finalNotifs.length > 0 ? 'block' : 'none';
            
            const mainBadge = document.getElementById('notif-badge');
            if(mainBadge) mainBadge.style.display = showBadge;

            const phBadge = document.getElementById('ph-notif-badge');
            if(phBadge) phBadge.style.display = showBadge;
            
            // Refresh studio dashboard if it's open
            if(document.getElementById('studio-view').style.display === 'block') {
                if(studioTab === 'dashboard') renderStudioTable();
            }
        });

        window.renderGrid = (videos, isHistory = false) => {
            grid.innerHTML = "";
            let items = [];

            if (isHistory) {
                items = videos;
            } else {
                Object.entries(videos).forEach(([id, data]) => {
                    items.push({ ...data, id: id });
                });
                items.reverse();
            }

            // Filter by Bubble Category if not in a special view
            if (currentCategory !== "All" && !isHistory) {
                const keywords = categoryKeywords[currentCategory] || [];

                items = items.filter(video => {
                    // --- LAYER 1: THE BEST METHOD (EXPLICIT CATEGORY) ---
                    // If the video has a category set and it's a perfect match, include it instantly.
                    if (video.category && video.category === currentCategory) {
                        return true;
                    }

                    // --- LAYER 2: THE SMART FALLBACK (KEYWORD & PATTERN MATCHING) ---
                    // If Layer 1 failed, we now check the title and description for keywords.
                    const titleLower = video.title.toLowerCase();
                    const descLower = video.description ? video.description.toLowerCase() : '';

                    // .some() checks if the title/desc includes AT LEAST ONE keyword.
                    const keywordMatch = keywords.some(keyword => 
                        titleLower.includes(keyword) || 
                        descLower.includes(keyword)
                    );

                    // If we found a keyword, we're done. Include the video.
                    if (keywordMatch) {
                        return true;
                    }

                    // --- BONUS PATTERN MATCHING for MUSIC ---
                    // If it's the music category and we still have no match, check for common patterns.
                    if (currentCategory === 'Music') {
                        // Regex to find patterns like "(Official Video)", "(Lyrics)", or "Artist - Title"
                        const musicPatterns = [
                            /\(official (music )?video\)/i, 
                            /\(lyrics\)/i, 
                            /\s-\s/ // a hyphen with spaces, e.g., "Artist - Title"
                        ];
                        if (musicPatterns.some(pattern => pattern.test(titleLower))) {
                            return true;
                        }
                    }

                    // If none of the above worked, exclude the video.
                    return false;
                });
            }

            // If it's a special page like History or Liked, render a simple grid.
            if (isHistory) {
                if (items.length === 0) {
                    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:var(--text-light);">No videos here.</div>`;
                    return;
                }
                
                // --- PERFORMANCE FIX IS HERE ---
                let historyHTML = ""; // Build the HTML in a string variable first
                items.forEach(v => {
                    historyHTML += `
                        <div class="card" onclick="handleVideoClick('${v.id || v.videoId}')">
                            <div class="thumb-box"><img src="${v.thumbnail}" onerror="this.src='https://via.placeholder.com/640x360'"><div class="dur-badge">${v.duration || '00:00'}</div></div>
                            <div class="meta-flex"><img src="https://ui-avatars.com/api/?name=${v.uploader}&background=random" class="chn-avatar"><div class="meta-text"><h3>${v.title}</h3><p>${v.uploader}</p><p>${formatViews(v.views)} views  ${timeAgo(v.timestamp)}</p></div></div>
                        </div>`;
                });
                grid.innerHTML = historyHTML; // Set innerHTML only ONCE
                return;
            }

            // --- SEQUENTIAL LAYOUT LOGIC FOR HOME/CATEGORY PAGES (Correct) ---

            const shorts = items.filter(v => isShort(v));
            const regularVideos = items.filter(v => !isShort(v));
            let finalHTML = '';

            if (regularVideos.length === 0 && shorts.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:var(--text-light);">No videos found for "${currentCategory}".</div>`;
                return;
            }

            // Configuration for the top shelf
            const shortsOnTopCount = 6;
            const topShorts = shorts.slice(0, shortsOnTopCount);
            const remainingShorts = shorts.slice(shortsOnTopCount);

            // --- BLOCK 1: RENDER TOP SHORTS SHELF ---
            if (topShorts.length > 0) {
                let shortsHTML = `
                <div class="shorts-shelf">
                    <div class="shorts-shelf-title">
                        <span class="material-symbols-rounded">slow_motion_video</span>
                        <span>Shorts</span>
                    </div>
                    <div class="shorts-scroll-container">
                `;
                topShorts.forEach(s => {
                    shortsHTML += `
                        <div class="short-card" onclick="handleVideoClick('${s.id}')">
                            <img src="${s.thumbnail}" onerror="this.src='https://via.placeholder.com/360x640'">
                            <div class="short-card-overlay">
                                <div class="short-card-title">${s.title}</div>
                                <div class="short-card-views">${formatViews(s.views)} views</div>
                            </div>
                        </div>
                    `;
                });
                shortsHTML += `</div></div>`;
                finalHTML += shortsHTML;
            }

            // --- BLOCK 2: RENDER REGULAR VIDEO GRID ---
            regularVideos.forEach(v => {
                finalHTML += `
                    <div class="card" onclick="handleVideoClick('${v.id || v.videoId}')">
                        <div class="thumb-box">
                            <img src="${v.thumbnail}" onerror="this.src='https://via.placeholder.com/640x360'">
                            <div class="dur-badge">${v.duration || '00:00'}</div>
                        </div>
                        <div class="meta-flex">
                            <img src="https://ui-avatars.com/api/?name=${v.uploader}&background=random" class="chn-avatar">
                            <div class="meta-text">
                                <h3>${v.title}</h3>
                                <p>${v.uploader}</p>
                                <p>${formatViews(v.views)} views  ${timeAgo(v.timestamp)}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            // --- BLOCK 3: RENDER REMAINING SHORTS SHELF AT THE BOTTOM ---
            if (remainingShorts.length > 0) {
                let shortsHTML = `
                <div class="shorts-shelf">
                    <div class="shorts-shelf-title">
                        <span class="material-symbols-rounded">slow_motion_video</span>
                        <span>Shorts</span>
                    </div>
                    <div class="shorts-scroll-container">
                `;
                remainingShorts.forEach(s => {
                    shortsHTML += `
                        <div class="short-card" onclick="handleVideoClick('${s.id}')">
                            <img src="${s.thumbnail}" onerror="this.src='https://via.placeholder.com/360x640'">
                            <div class="short-card-overlay">
                                <div class="short-card-title">${s.title}</div>
                                <div class="short-card-views">${formatViews(s.views)} views</div>
                            </div>
                        </div>
                    `;
                });
                shortsHTML += `</div></div>`;
                finalHTML += shortsHTML;
            }

            grid.innerHTML = finalHTML;
        }

window.handleSearch = (event) => {
            const inputElement = document.getElementById('search-input');
            const query = inputElement.value.trim();

            if (event && event.key === 'Enter') {
                // Perform Final Search Action (Desktop or Mobile Search Bar Enter)
                if (!query) return;
                
                // Hide suggestions after searching
                document.getElementById('desktop-suggestions').style.display = 'none';

                const filtered = {};
                const qLower = query.toLowerCase();
                
                // Search in Title AND Description
                Object.entries(allVideos).forEach(([id, v]) => {
                    if (v.title.toLowerCase().includes(qLower) || (v.description && v.description.toLowerCase().includes(qLower))) {
                        filtered[id] = v;
                    }
                });

                // 1. Switch to Home View
                goHome(); 
                document.getElementById('page-heading').innerText = `Search results for "${query}"`;
                document.getElementById('page-heading').style.display = "block";
                
                // 2. Override category and render results in the main grid
                document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active'));
                renderGrid(filtered);
                
                // IMPORTANT: Ensure the full search results overlay is hidden
                document.getElementById('search-results-view').style.display = 'none';

                // Save to history
                let history = JSON.parse(localStorage.getItem('yt_search_history')) || [];
                history = history.filter(h => h !== query); 
                history.unshift(query); 
                if(history.length > 10) history.pop(); 
                localStorage.setItem('yt_search_history', JSON.stringify(history));
            }
        }

        // --- NEW DESKTOP SUGGESTION LOGIC ---
        
        window.handleDesktopSearchInput = (query) => {
            if (window.innerWidth <= 768) return; // Only run on desktop
            
            const suggestionsEl = document.getElementById('desktop-suggestions');
            const listEl = document.createElement('div');
            listEl.innerHTML = '';
            
            if (!query.trim()) {
                suggestionsEl.style.display = 'none';
                return;
            }

            const q = query.toLowerCase();
            const suggestions = [];
            const history = JSON.parse(localStorage.getItem('yt_search_history')) || [];
            
            // 1. Add History (filtered by query)
            history.filter(h => h.toLowerCase().includes(q)).slice(0, 5).forEach(term => {
                const div = document.createElement('div');
                div.className = 'ds-item';
                div.innerHTML = `
                    <span class="material-symbols-rounded ds-icon">history</span>
                    <span class="ds-text">${term}</span>
                `;
                div.onclick = () => {
                    document.getElementById('search-input').value = term;
                    window.handleSearch({key:'Enter'});
                };
                listEl.appendChild(div);
            });

            // 2. Add Video Title Suggestions (unique, max 5)
            const uniqueTitles = new Set();
            Object.values(allVideos).forEach(v => {
                if (v.title.toLowerCase().includes(q)) {
                    if (!uniqueTitles.has(v.title) && suggestions.length < 5) {
                        uniqueTitles.add(v.title);
                        suggestions.push(v.title);
                        const div = document.createElement('div');
                        div.className = 'ds-item';
                        div.innerHTML = `
                            <span class="material-symbols-rounded ds-icon">search</span>
                            <span class="ds-text">${v.title}</span>
                        `;
                        div.onclick = () => {
                            document.getElementById('search-input').value = v.title;
                            window.handleSearch({key:'Enter'});
                        };
                        listEl.appendChild(div);
                    }
                }
            });
            
            suggestionsEl.innerHTML = '';
            if (listEl.children.length > 0) {
                suggestionsEl.appendChild(listEl);
                suggestionsEl.style.display = 'block';
            } else {
                 suggestionsEl.style.display = 'none';
            }
        }
        
        // --- EVENT LISTENERS FOR DESKTOP SEARCH BAR ---
        document.addEventListener('DOMContentLoaded', () => {
            const desktopInput = document.getElementById('search-input');
            const suggestionsEl = document.getElementById('desktop-suggestions');

            if (desktopInput) {
                // Monitor input changes for suggestions
                desktopInput.addEventListener('input', (e) => {
                    handleDesktopSearchInput(e.target.value);
                });

                // Capture Enter key press for final search
                desktopInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        // Prevent form submission if we were in one
                        e.preventDefault(); 
                        handleSearch(e);
                    }
                });
            }
            
            // Close suggestions when clicking elsewhere on the page
            document.addEventListener('click', (e) => {
                const searchBar = document.getElementById('nav-search-bar');
                if (suggestionsEl && searchBar && !searchBar.contains(e.target) && !suggestionsEl.contains(e.target)) {
                    suggestionsEl.style.display = 'none';
                }
            });
        });

        function parseDurationToSeconds(durationStr) {
            if (!durationStr || typeof durationStr !== 'string') return 0;
            const parts = durationStr.split(':').map(Number);
            if (parts.length === 2) {
                return parts[0] * 60 + parts[1];
            } else if (parts.length === 1) {
                return parts[0];
            }
            return 0;
        }

        function isShort(video) {
            if (!video || !video.duration) return false;
            return parseDurationToSeconds(video.duration) <= 60;
        }

        window.handleVideoClick = async (id) => {
            // 1. Check if offline version exists first
            const offlineVideo = await getVideoFromDB(id);
            if (offlineVideo) {
                playOfflineVideo(id); // Play from Blob
                return;
            }

            // 2. Otherwise play normally
            const video = allVideos[id];
            if (!video) return;

            if (isShort(video)) {
                openShortsViewer(id);
            } else {
                openWatch(id);
            }
        }

        window.openWatch = async (id, offlineSrc = null) => {
            currentVidId = id;
            document.getElementById('watch-view').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.getElementById('category-bar').style.display = 'none';

            const videoElement = document.getElementById('main-player');
            const titleEl = document.getElementById('w-title');
            const chnNameEl = document.getElementById('w-chn-name');
            const chnImgEl = document.getElementById('w-chn-img');
            const descEl = document.getElementById('w-desc');
            const metaEl = document.getElementById('w-meta');

            // --- SCENARIO A: PLAYING DOWNLOADED VIDEO (OFFLINE MODE) ---
            if (offlineSrc) {
                console.log("Entering Offline Mode for:", id);
                
                // 1. Fetch metadata strictly from Local DB (ignore online cache)
                const v = await getVideoFromDB(id);
                
                // 2. Set Player Source to Blob
                videoElement.src = offlineSrc;
                
                // 3. Update UI with Local Data
                if (v) {
                    titleEl.innerText = v.title || "Downloaded Video";
                    chnNameEl.innerText = v.uploader || "Offline Channel";
                    chnImgEl.src = `https://ui-avatars.com/api/?name=${v.uploader || 'U'}&background=random`;
                    descEl.innerText = "Description not available offline.";
                    metaEl.innerText = `Saved on ${new Date(v.savedAt || Date.now()).toLocaleDateString()}`;
                    currentUploader = v.uploader;
                } else {
                    titleEl.innerText = "Video Loaded";
                    metaEl.innerText = "Offline Mode";
                }

                // 4. Disable Online-Only Features
                document.getElementById('comment-list').innerHTML = `<div style="padding:20px; text-align:center; color:#888;">Comments disabled offline.</div>`;
                document.getElementById('set-quality-val').innerText = "Offline";
                
                // 5. Play
                try { await videoElement.play(); } catch(e) { console.error(e); }
                
                // 6. Update Button State
                window.updateDownloadButtonState();
                return; // STOP HERE. Do not run online logic.
            }

            // --- SCENARIO B: PLAYING ONLINE VIDEO ---
            
            // 1. Get Metadata (Try Cache, then DB fallback)
            let v = allVideos[id];
            if (!v) v = await getVideoFromDB(id);
            
            if (!v) {
                console.error("No metadata found for video:", id);
                return; // Cannot play without data
            }

            currentUploader = v.uploader;

            // 2. Update Analytics (Online Only)
            if (user) {
                const uniqueViewRef = ref(db, `users/${user.uid}/viewed/${id}`);
                get(uniqueViewRef).then(snap => {
                    if (!snap.exists()) {
                        set(uniqueViewRef, true);
                        runTransaction(ref(db, `videos/${id}/views`), (c) => (c || 0) + 1);
                    }
                    push(ref(db, `analytics/${id}/views`), { t: Date.now() });
                });
                push(ref(db, `users/${user.uid}/history`), { videoId: id, timestamp: Date.now() });
            } else {
                runTransaction(ref(db, `videos/${id}/views`), (c) => (c || 0) + 1);
            }

            // 3. Set Player Source
            // Only verify quality if we are NOT using a blob
            if (currentQuality !== 'Auto (1080p)') {
                 changeQuality(currentQuality);
            } else {
                 videoElement.src = v.videoUrl;
                 document.getElementById('set-quality-val').innerText = currentQuality;
            }
            
            // 4. Update UI
            titleEl.innerText = v.title;
            chnNameEl.innerText = v.uploader;
            chnImgEl.src = `https://ui-avatars.com/api/?name=${v.uploader}&background=random`;
            descEl.innerText = v.description || "";
            metaEl.innerText = `${formatViews(v.views||0)} views  ${new Date(v.timestamp).toLocaleDateString()}`;

            // 5. Load Extras
            updateLikeButton(id);
            checkSubscriptionStatus(v.uploader);
            loadComments(id);
            window.updateDownloadButtonState();

            try { await videoElement.play(); } catch(e) { console.error(e); }
        }

        window.closeWatch = () => {
            document.getElementById('watch-view').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('category-bar').style.display = 'flex'; 
            // --- PLAYER UPDATE ---
            const videoElement = document.getElementById('main-player');
            videoElement.pause();
            videoElement.src = "";
            // --- END PLAYER UPDATE ---
            currentVidId = null;
        }

        // --- SHORTS VIEWER LOGIC ---
        window.openShortsFeed = () => {
            // --- FIX: Close Overlays ---
            document.getElementById('profile-hub-view').style.display = 'none';
            document.getElementById('mobile-notif-view').style.display = 'none'; // Added this
            
            // Note: Shorts viewer handles its own nav visibility, so we don't force 'flex' here.

            const allVideoEntries = Object.entries(allVideos);
            const shorts = allVideoEntries.filter(([id, v]) => isShort(v)).map(([id, v]) => ({...v, id}));
            if(shorts.length === 0) {
                alert("No Shorts available to watch.");
                return;
            }
            // Start with a random short
            const randomIndex = Math.floor(Math.random() * shorts.length);
            openShortsViewer(shorts[randomIndex].id);
        }

        window.openShortsViewer = (startId) => {
            document.getElementById('shorts-view').style.display = 'block';
            document.body.style.overflow = 'hidden';

            const allVideoEntries = Object.entries(allVideos);
            allShorts = allVideoEntries.filter(([id, v]) => isShort(v)).map(([id, v]) => ({...v, id}));
            
            currentShortIndex = allShorts.findIndex(s => s.id === startId);
            if (currentShortIndex === -1) currentShortIndex = 0;

            renderShortSlides();
        }

        function renderShortSlides() {
            const container = document.getElementById('shorts-container');
            container.innerHTML = '';
            
            const totalShorts = allShorts.length;
            const prevIndex = (currentShortIndex - 1 + totalShorts) % totalShorts;
            const nextIndex = (currentShortIndex + 1) % totalShorts;
            const indicesToRender = [prevIndex, currentShortIndex, nextIndex];
            const uniqueIndices = [...new Set(indicesToRender)];

            uniqueIndices.forEach(index => {
                const short = allShorts[index];
                const slide = document.createElement('div');
                slide.className = 'short-slide';
                slide.id = `short-slide-${short.id}`;
                slide.dataset.index = index;
                
                // ADDED: poster attribute, loader div, and playsinline attributes
                slide.innerHTML = `
                    <video 
                        src="${short.videoUrl}" 
                        poster="${short.thumbnail}"
                        loop 
                        playsinline 
                        webkit-playsinline 
                        preload="auto"
                    ></video>

                    <div class="short-loader"></div>

                    <div class="short-play-pause-indicator">
                        <span class="material-symbols-rounded">play_arrow</span>
                    </div>

                    <div class="short-ui-overlay">
                        <div class="short-ui-right">
                            <button class="short-action-pill" id="short-like-btn-${short.id}" onclick="toggleLike()">
                                <span class="material-symbols-rounded">thumb_up</span>
                                <span id="short-like-count-${short.id}">${formatViews(short.views)}</span>
                            </button>
                            <button class="short-action-pill">
                                <span class="material-symbols-rounded">thumb_down</span>
                                <span>Dislike</span>
                            </button>
                            <button class="short-action-pill">
                                <span class="material-symbols-rounded">comment</span>
                                <span>...</span>
                            </button>
                            <button class="short-action-pill">
                                <span class="material-symbols-rounded">share</span>
                                <span>Share</span>
                            </button>
                            <img src="${short.thumbnail}" class="short-sound-thumb">
                        </div>

                        <div class="short-ui-bottom">
                            <div class="short-comment-bubble" id="short-comment-bubble-${short.id}" style="display: none;">
                                <img id="short-comment-avatar-${short.id}" src="">
                                <span id="short-comment-text-${short.id}"></span>
                            </div>

                            <div class="short-chn-info">
                                <img src="https://ui-avatars.com/api/?name=${short.uploader}&background=random">
                                <span class="short-chn-name">@${short.uploader}</span>
                                <button class="sub-btn" id="short-sub-btn-${short.id}" onclick="toggleSubscribe()">Subscribe</button>
                            </div>
                            <div class="short-title">${short.title}</div>
                        </div>
                    </div>
                `;

                // --- NEW LOADING LOGIC ---
                const video = slide.querySelector('video');
                const loader = slide.querySelector('.short-loader');

                video.onwaiting = () => { loader.style.display = 'block'; };
                video.onloadstart = () => { loader.style.display = 'block'; };
                video.onplaying = () => { loader.style.display = 'none'; };
                video.oncanplay = () => { loader.style.display = 'none'; };

                slide.onclick = (event) => {
                    if (event.target.closest('button, a')) return;
                    const indicator = slide.querySelector('.short-play-pause-indicator');
                    const icon = indicator.querySelector('.material-symbols-rounded');
                    
                    if (video.paused) { 
                        video.play(); 
                        icon.textContent = 'play_arrow'; 
                    } else { 
                        video.pause(); 
                        icon.textContent = 'pause'; 
                    }
                    indicator.classList.add('visible');
                    setTimeout(() => indicator.classList.remove('visible'), 500);
                };

                container.appendChild(slide);
            });

            const currentSlide = document.querySelector(`[data-index='${currentShortIndex}']`);
            if (currentSlide) {
                currentSlide.scrollIntoView({ behavior: 'instant' });
                setTimeout(() => playCurrentShort(), 100);
            }

            container.onscroll = handleShortsScroll;
        }

        // --- NEW: Helper function to update the UI of the active Short's like button ---
        function updateShortLikeButtonUI(videoId) {
            const btn = document.getElementById(`short-like-btn-${videoId}`);
            if (!btn) return;

            const icon = btn.querySelector('.material-symbols-rounded');
            const counter = document.getElementById(`short-like-count-${videoId}`);
            
            get(ref(db, `likes/${videoId}`)).then(snap => { counter.innerText = formatViews(snap.size); });
            
            if (user) {
                get(ref(db, `likes/${videoId}/${user.uid}`)).then(snap => {
                    if (snap.exists()) {
                        icon.style.color = 'var(--primary)';
                        icon.style.fontVariationSettings = "'FILL' 1";
                    } else {
                        icon.style.color = 'white';
                        icon.style.fontVariationSettings = "'FILL' 0";
                    }
                });
            } else {
                icon.style.color = 'white';
                icon.style.fontVariationSettings = "'FILL' 0";
            }
        }

        // --- NEW: Helper function to update the UI of the active Short's subscribe button ---
        function updateShortSubscriptionUI(uploader, videoId) {
            const btn = document.getElementById(`short-sub-btn-${videoId}`);
            if (!btn) return;
            const myName = user ? (user.displayName || user.email.split('@')[0]) : '';
            
            if (!user || myName === uploader) {
                btn.innerText = "Subscribe";
                btn.classList.remove('subscribed');
                btn.disabled = true;
                return;
            }
            
            btn.disabled = false;
            get(ref(db, `users/${user.uid}/subscriptions/${uploader}`)).then(snap => {
                if (snap.exists()) {
                    btn.innerText = "Subscribed";
                    btn.classList.add('subscribed');
                } else {
                    btn.innerText = "Subscribe";
                    btn.classList.remove('subscribed');
                }
            });
        }

        let scrollTimeout;
        function handleShortsScroll() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const container = document.getElementById('shorts-container');
                const slides = container.querySelectorAll('.short-slide');
                let closestSlide = null;
                let minDistance = Infinity;

                slides.forEach(slide => {
                    const rect = slide.getBoundingClientRect();
                    const distance = Math.abs(rect.top);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestSlide = slide;
                    }
                });

                if (closestSlide) {
                    const newIndex = parseInt(closestSlide.dataset.index);
                    if (newIndex !== currentShortIndex) {
                        currentShortIndex = newIndex;
                        renderShortSlides(); // Re-render to load next/prev slides
                    }
                }
            }, 150);
        }

        async function loadShortExtras(short) {
            if (!short || !short.id) return;

            const bubble = document.getElementById(`short-comment-bubble-${short.id}`);
            const avatar = document.getElementById(`short-comment-avatar-${short.id}`);
            const text = document.getElementById(`short-comment-text-${short.id}`);

            if (!bubble || !avatar || !text) return;

            // Fetch comments for the given short ID
            const commentsSnap = await get(ref(db, 'comments/' + short.id));
            const commentsData = commentsSnap.val();

            if (commentsData) {
                // Get the very first comment available
                const firstCommentKey = Object.keys(commentsData)[0];
                const firstComment = commentsData[firstCommentKey];

                if (firstComment) {
                    // Update the comment bubble's content
                    avatar.src = `https://ui-avatars.com/api/?name=${firstComment.user}&background=random`;
                    text.innerText = firstComment.text;
                    // Make the bubble visible
                    bubble.style.display = 'flex';
                }
            } else {
                // If there are no comments, ensure the bubble is hidden
                bubble.style.display = 'none';
            }
        }

        function playCurrentShort() {
            document.querySelectorAll('#shorts-container video').forEach(v => v.pause());
            const currentSlide = document.querySelector(`[data-index='${currentShortIndex}']`);
            if (currentSlide) {
                const videoElement = currentSlide.querySelector('video');
                if (videoElement) {
                    videoElement.play().catch(e => console.log("Autoplay blocked"));
                }

                // --- THE CONTEXT SWITCH ---
                const short = allShorts[currentShortIndex];
                if (short) {
                    // 1. Set global context for action functions
                    currentVidId = short.id;
                    currentUploader = short.uploader;

                    // 2. Update the UI for this specific short
                    updateShortLikeButtonUI(short.id);
                    updateShortSubscriptionUI(short.uploader, short.id);
                    
                    // 3. NEW: Load the first comment dynamically
                    loadShortExtras(short);

                    // 4. Handle view counting and history
                    if (user) {
                        const uniqueViewRef = ref(db, `users/${user.uid}/viewed/${short.id}`);
                        get(uniqueViewRef).then(snap => {
                            if (!snap.exists()) {
                                set(uniqueViewRef, true);
                                runTransaction(ref(db, `videos/${short.id}/views`), (c) => (c || 0) + 1);
                            }
                        });
                        push(ref(db, `users/${user.uid}/history`), { videoId: short.id, timestamp: Date.now() });
                    } else {
                        runTransaction(ref(db, `videos/${short.id}/views`), (c) => (c || 0) + 1);
                    }
                }
            }
        }
        
        window.closeShortsViewer = () => {
            document.getElementById('shorts-view').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.querySelectorAll('#shorts-container video').forEach(v => v.pause());
            document.getElementById('shorts-container').innerHTML = '';
            currentShortIndex = -1;
            allShorts = [];
        }

        // --- YOUTUBE-STYLE FULLSCREEN/LANDSCAPE LOGIC ---
        window.toggleFullscreen = () => {
            const container = document.querySelector('.player-container');
            const icon = document.getElementById('fullscreen-icon');
            
            // Toggle the special CSS class that forces landscape on mobile
            container.classList.toggle('force-landscape');

            // Update the icon based on the new state
            if (container.classList.contains('force-landscape')) {
                // We are now IN landscape, so show the EXIT icon
                icon.innerText = 'fullscreen_exit';
            } else {
                // We are back in portrait, so show the ENTER icon
                icon.innerText = 'fullscreen';
            }
        }
        function convertToEmbed(url) {
            // No longer need to convert for embedding, just return the direct URL
            return url || '';
        }

        function updateLikeButton(vidId) {
            const btn = document.getElementById('like-btn');
            const counter = document.getElementById('w-likes');
            const icon = document.getElementById('like-icon');
            get(ref(db, `likes/${vidId}`)).then(snap => { counter.innerText = formatViews(snap.size); });
            if(user) {
                get(ref(db, `likes/${vidId}/${user.uid}`)).then(snap => {
                    if(snap.exists()) { btn.classList.add('active'); icon.innerText = "thumb_up_alt"; } 
                    else { btn.classList.remove('active'); icon.innerText = "thumb_up"; }
                });
            } else { btn.classList.remove('active'); icon.innerText = "thumb_up"; }
        }

        window.toggleLike = () => {
            if (!user) return window.openAuth();
            if (!currentVidId) return;

            const likeRef = ref(db, `likes/${currentVidId}/${user.uid}`);
            runTransaction(likeRef, (currentData) => {
                return currentData ? null : true;
            }).then(() => {
                // After transaction, update whichever UI is visible
                if (document.getElementById('watch-view').style.display === 'block') {
                    updateLikeButton(currentVidId);
                }
                if (document.getElementById('shorts-view').style.display === 'block') {
                    updateShortLikeButtonUI(currentVidId);
                }
            });
        }

        function checkSubscriptionStatus(uploader) {
            const btn = document.getElementById('sub-btn');
            const nameToCheck = uploader;
            // Consistency Check: Ensure we use the same default naming logic
            const myName = user ? (user.displayName || user.email.split('@')[0]) : '';
            
            // 1. If not logged in or subscribing to self, disable/reset button
            if(!user || myName === nameToCheck) { 
                btn.innerText = "Subscribe"; 
                btn.classList.remove('subscribed'); 
                // Ensure the button is enabled only for logged-in users attempting to subscribe to others
                btn.disabled = (!user || myName === nameToCheck);
                return; 
            }
            
            // 2. If user is logged in and subscribing to someone else
            btn.disabled = false; // Enable subscription button
            get(ref(db, `users/${user.uid}/subscriptions/${uploader}`)).then(snap => {
                if(snap.exists()) { btn.innerText = "Subscribed"; btn.classList.add('subscribed'); } 
                else { btn.innerText = "Subscribe"; btn.classList.remove('subscribed'); }
            });
        }

        window.toggleSubscribe = () => {
            if (!user) return window.openAuth();
            if (!currentUploader) return;
            const myName = user.displayName || user.email.split('@')[0];
            if (myName === currentUploader) return alert("Cannot subscribe to yourself");
            
            const subRef = ref(db, `users/${user.uid}/subscriptions/${currentUploader}`);
            runTransaction(subRef, (currentData) => {
                return currentData ? null : true;
            }).then(() => {
                // After transaction, update whichever UI is visible
                if (document.getElementById('watch-view').style.display === 'block') {
                    checkSubscriptionStatus(currentUploader);
                }
                if (document.getElementById('shorts-view').style.display === 'block') {
                    updateShortSubscriptionUI(currentUploader, currentVidId);
                }
            });
        }

        function loadSidebarSubscriptions(uid) {
            const list = document.getElementById('sub-list-container');
            onValue(ref(db, `users/${uid}/subscriptions`), (snap) => {
                const subs = snap.val();
                list.innerHTML = "";
                if(subs) {
                    Object.keys(subs).forEach(name => {
                        list.innerHTML += `<div class="sub-list-item"><img src="https://ui-avatars.com/api/?name=${name}&background=random"><span>${name}</span></div>`;
                    });
                } else { list.innerHTML = `<div style="padding: 0 12px; font-size: 13px; color: var(--text-light);">No subscriptions yet.</div>`; }
            });
        }

        function loadComments(vidId) {
            onValue(ref(db, 'comments/' + vidId), (snap) => {
                const list = document.getElementById('comment-list');
                list.innerHTML = "";
                const data = snap.val();
                if(data) {
                    document.getElementById('comment-count').innerText = `${Object.keys(data).length} Comments`;
                    Object.values(data).reverse().forEach(c => {
                        list.innerHTML += `
                            <div class="comment-item">
                                <img src="https://ui-avatars.com/api/?name=${c.user}&background=random" class="chn-avatar">
                                <div>
                                    <div class="comment-meta"><span class="comment-author">@${c.user}</span><span style="color:var(--text-light);">${timeAgo(c.time)}</span></div>
                                    <div class="comment-text">${c.text}</div>
                                </div>
                            </div>`;
                    });
                } else {
                    document.getElementById('comment-count').innerText = "Comments";
                    list.innerHTML = "<div style='color:var(--text-light); font-size:14px; font-style:italic;'>No comments yet.</div>";
                }
            });
        }

        window.postComment = () => {
            if(!user) return window.openAuth();
            const txt = document.getElementById('comment-text').value;
            if(!txt.trim()) return;
            
            const name = user.displayName || user.email.split('@')[0];
            
            // 1. Save the Comment normally
            push(ref(db, 'comments/' + currentVidId), { 
                text: txt, 
                user: name, 
                uid: user.uid, 
                time: Date.now() 
            });

            // 2. MENTION DETECTION SYSTEM
            // This regex finds words starting with @ (e.g. @usman)
            const mentionMatches = txt.match(/@(\w+)/g);
            
            if (mentionMatches) {
                const videoTitle = document.getElementById('w-title').innerText;
                
                mentionMatches.forEach(match => {
                    // Remove the '@' symbol to get just the username
                    const targetUser = match.substring(1); 
                    
                    // Save to a specific 'mentions' node in Firebase for that user
                    push(ref(db, 'mentions/' + targetUser), {
                        fromUser: name,
                        fromAvatar: user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=random`,
                        videoId: currentVidId,
                        videoTitle: videoTitle,
                        commentText: txt,
                        timestamp: Date.now()
                    });
                });
            }

            document.getElementById('comment-text').value = "";
        }

        function setActiveMenu(id) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            closeWatch(); closeStudio();
            
            // Close mobile sidebar if open when navigating
            if (window.innerWidth <= 768) {
                const sb = document.getElementById('sidebar');
                if (sb.classList.contains('mobile-open')) {
                    sb.classList.remove('mobile-open');
                    document.body.classList.remove('sidebar-open');
                    document.getElementById('mobile-overlay').classList.remove('show');
                }
            }
        }

window.goHome = () => {
            // 1. DEACTIVATE HISTORY MODE (Brings the header back)
            document.body.classList.remove('history-mode');

            // 2. Close Other Overlays
            const hub = document.getElementById('profile-hub-view');
            if(hub) hub.style.display = 'none';
            
            // FIX: Close Mobile Notification Screen
            document.getElementById('mobile-notif-view').style.display = 'none';

            // 3. Reset Nav Style (Just in case)
            const nav = document.querySelector('nav');
            if(nav) nav.style.display = ''; 

            setActiveMenu('btn-home');
            
            const pageHeading = document.getElementById('page-heading');
            if(pageHeading) {
                pageHeading.innerText = "Home";
                pageHeading.style.display = "none";
            }
            
            // Ensure Search results overlay is closed
            const searchResults = document.getElementById('search-results-view');
            if (searchResults) searchResults.style.display = 'none';

            document.getElementById('category-bar').style.display = 'flex';
            renderGrid(allVideos);
        }

        // Global variable to store history data for filtering
        let cachedHistoryItems = [];

        window.openHistory = () => {
            if(!user) return window.openAuth();
            
            // 1. Close Profile Hub
            const hub = document.getElementById('profile-hub-view');
            if(hub) hub.style.display = 'none';
            
            // 2. ACTIVATE HISTORY MODE (This triggers the CSS we just added)
            document.body.classList.add('history-mode');

            setActiveMenu('btn-history');
            
            // Hide Page Headings
            const pageHeading = document.getElementById('page-heading');
            if(pageHeading) pageHeading.style.display = "none";
            
            // Show Skeleton
            grid.innerHTML = '<div class="skeleton sk-card" style="grid-column:1/-1;"></div>';

            get(ref(db, `users/${user.uid}/history`)).then(snap => {
                const data = snap.val();
                
                // Handle Empty State
                if(!data) { 
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; padding: 20px;">
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom: 20px;">
                                <button class="icon-btn" onclick="goHome()"><span class="material-symbols-rounded">arrow_back</span></button>
                                <div style="font-size: 24px; font-weight: 700; color: var(--text-main);">History</div>
                            </div>
                            <div style="text-align:center; color:var(--text-light); padding: 40px;">No watch history found.</div>
                        </div>`;
                    return; 
                }

                // Store sorted items globally for the filter function
                cachedHistoryItems = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
                
                // Initialize view with 'All' filter
                updateHistoryView('All');
            });
        }

        // --- NEW: Function to Filter and Render History (Grouped by Date with Horizontal Shorts) ---
        window.updateHistoryView = (filterType) => {
            // 1. FORCE GRID TO DISPLAY BLOCK
            const gridContainer = document.getElementById('video-grid');
            if (gridContainer) {
                gridContainer.style.display = 'block'; 
            }

            // Filter Data logic
            let filteredItems = cachedHistoryItems;
            if (filterType === 'Videos') {
                filteredItems = cachedHistoryItems.filter(h => { const v = allVideos[h.videoId]; return v && !isShort(v); });
            } else if (filterType === 'Shorts') {
                 filteredItems = cachedHistoryItems.filter(h => { const v = allVideos[h.videoId]; return v && isShort(v); });
            } else if (filterType === 'Music') {
                 filteredItems = cachedHistoryItems.filter(h => {
                    const v = allVideos[h.videoId];
                    const isCat = v && v.category === 'Music';
                    const isKey = v && (v.title.toLowerCase().includes('music') || v.title.toLowerCase().includes('song'));
                    return isCat || isKey;
                });
            }

            // --- PADDING INCREASED HERE ---
            const commonStyle = "padding: 10px 24px; border-radius: 24px; font-size: 14px; font-weight: 500; cursor: pointer; transition: 0.2s; white-space: nowrap; flex-shrink: 0;";
            const activeStyle = `background: var(--text-main); color: var(--bg-body); border: none; ${commonStyle}`;
            const inactiveStyle = `background: var(--secondary); color: var(--text-main); border: 1px solid var(--border); ${commonStyle}`;

            // HTML Builder
            let html = `
                <div style="max-width: 800px; margin: 0 auto; width: 100%;">
                    <!-- Header -->
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom: 20px; padding-top: 8px;">
                        <button class="icon-btn" onclick="goHome()"><span class="material-symbols-rounded">arrow_back</span></button>
                        <div style="font-size: 24px; font-weight: 700; color: var(--text-main);">History</div>
                    </div>
                    
                    <!-- Search Bar -->
                    <div style="background: var(--secondary); border: 1px solid var(--border); border-radius: 24px; padding: 0 16px; height: 44px; display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <span class="material-symbols-rounded" style="color: var(--text-light);">search</span>
                        <input type="text" placeholder="Search watch history" style="border: none; background: transparent; outline: none; font-size: 15px; color: var(--text-main); width: 100%;">
                    </div>

                    <!-- Filters -->
                    <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 0px; margin-bottom: 12px; scrollbar-width: none;">
                        <button onclick="updateHistoryView('All')" style="${filterType === 'All' ? activeStyle : inactiveStyle}">All</button>
                        <button onclick="updateHistoryView('Videos')" style="${filterType === 'Videos' ? activeStyle : inactiveStyle}">Videos</button>
                        <button onclick="updateHistoryView('Shorts')" style="${filterType === 'Shorts' ? activeStyle : inactiveStyle}">Shorts</button>
                        <button onclick="updateHistoryView('Music')" style="${filterType === 'Music' ? activeStyle : inactiveStyle}">Music</button>
                    </div>

                    <!-- Main Content Wrapper -->
                    <div style="display: flex; flex-direction: column; gap: 10px; width: 100%;">
            `;

            if(filteredItems.length === 0) {
                html += `<div style="text-align:center; padding: 40px; color: var(--text-light); width: 100%;">No items found in "${filterType}".</div></div></div>`;
                grid.innerHTML = html;
                return;
            }

            // --- GROUP ITEMS BY DATE ---
            const getDateLabel = (ts) => {
                const d = new Date(ts);
                const now = new Date();
                if(d.toDateString() === now.toDateString()) return "Today";
                const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
                if(d.toDateString() === yesterday.toDateString()) return "Yesterday";
                return d.toLocaleDateString();
            };

            const groupedHistory = new Map();
            filteredItems.forEach(h => {
                const dateLabel = getDateLabel(h.timestamp);
                if (!groupedHistory.has(dateLabel)) groupedHistory.set(dateLabel, []);
                groupedHistory.get(dateLabel).push(h);
            });

            // Iterate over each Day Group
            for (const [dateLabel, items] of groupedHistory) {
                // 1. Print Date Header
                html += `<div style="width: 100%; font-size: 18px; font-weight: 700; color: var(--text-main); margin: 20px 0 10px 0;">${dateLabel}</div>`;

                // 2. Separate Shorts and Videos
                const shortsForDay = items.filter(h => isShort(allVideos[h.videoId]));
                const videosForDay = items.filter(h => !isShort(allVideos[h.videoId]));

                // 3. RENDER SHORTS (Constraint Added)
                // Use calc(100vw - 32px) to ensure it stays within mobile screen width
                if (shortsForDay.length > 0) {
                    html += `
                        <div style="
                            display: flex; 
                            gap: 12px; 
                            overflow-x: auto; 
                            padding-bottom: 12px; 
                            scrollbar-width: none;
                            margin-bottom: 8px;
                            width: 100%; 
                            max-width: calc(100vw - 32px); /* CRITICAL */
                        ">
                    `;
                    
                    shortsForDay.forEach(h => {
                        const s = allVideos[h.videoId];
                        if(s) {
                            html += `
                                <div style="min-width: 120px; width: 120px; cursor: pointer;" onclick="handleVideoClick('${h.videoId}')">
                                    <div style="width: 100%; aspect-ratio: 9/16; border-radius: 8px; overflow: hidden; margin-bottom: 6px; position: relative;">
                                        <img src="${s.thumbnail}" style="width: 100%; height: 100%; object-fit: cover;">
                                        <div style="position:absolute; bottom:4px; right:4px; color:white; font-size:10px; font-weight:600; text-shadow:0 1px 2px rgba(0,0,0,0.5);">${s.views || 0} views</div>
                                    </div>
                                    <div style="font-size: 13px; font-weight: 500; color: var(--text-main); line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${s.title}</div>
                                </div>
                            `;
                        }
                    });
                    
                    html += `</div>`; // Close Shorts Container
                }

                // 4. RENDER REGULAR VIDEOS
                if (videosForDay.length > 0) {
                    videosForDay.forEach(h => {
                        const v = allVideos[h.videoId];
                        if(v) {
                            html += `
                                <div class="card" onclick="handleVideoClick('${h.videoId}')" style="margin-bottom: 24px;">
                                    <div class="thumb-box">
                                        <img src="${v.thumbnail}" onerror="this.src='https://via.placeholder.com/640x360'">
                                        <div class="dur-badge">${v.duration || '00:00'}</div>
                                    </div>
                                    <div class="meta-flex">
                                        <img src="https://ui-avatars.com/api/?name=${v.uploader}&background=random" class="chn-avatar">
                                        <div class="meta-text">
                                            <h3>${v.title}</h3>
                                            <p>${v.uploader}</p>
                                            <p>${formatViews(v.views)} views</p>
                                        </div>
                                    </div>
                                </div>`;
                        }
                    });
                }
            } // End of For Loop (Grouped History)

            html += `</div></div>`; // Close Main Wrappers
            grid.innerHTML = html;
        }
        
        window.openLikedVideos = () => {
             if(!user) return window.openAuth();

             // 1. ENSURE HEADER IS VISIBLE
             document.body.classList.remove('history-mode');
             const nav = document.querySelector('nav');
             if(nav) nav.style.display = ''; 

             // 2. Close Hub
             const hub = document.getElementById('profile-hub-view');
             if(hub) hub.style.display = 'none';

             setActiveMenu('btn-liked');
             
             const pageHeading = document.getElementById('page-heading');
             if(pageHeading) {
                 pageHeading.innerText = "Liked Videos";
                 pageHeading.style.display = "block";
             }
             
             document.getElementById('category-bar').style.display = 'none';
             grid.innerHTML = "Loading liked videos...";
             
             get(ref(db, 'likes')).then(snap => {
                 const likesMap = snap.val() || {};
                 const myLikedIds = [];
                 if (likesMap) {
                     Object.entries(likesMap).forEach(([vidId, usersWhoLiked]) => { 
                         // SAFER CHECK: Ensure usersWhoLiked object exists before checking inside it
                         if(usersWhoLiked && usersWhoLiked[user.uid]) {
                            myLikedIds.push(vidId); 
                         }
                     });
                 }

                 // Filter out IDs for videos that no longer exist
                 const likedVids = myLikedIds
                    .filter(id => allVideos[id]) // This check is crucial
                    .map(id => ({...allVideos[id], id: id}));

                 renderGrid(likedVids, true);
             }).catch(error => {
                console.error("Error fetching liked videos:", error);
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:var(--text-light);">Could not load liked videos.</div>`;
             });
        }

        window.openStudio = () => {
            if(!user) return window.openAuth();
            
            // --- FIX: Close Profile Hub before opening Studio ---
            document.getElementById('profile-hub-view').style.display = 'none';

            // Show Studio Overlay
            const studioView = document.getElementById('studio-view');
            studioView.style.display = 'block';
            
            // Make Studio Overlay Full Screen (Remove top gap)
            studioView.style.top = '0';
            studioView.style.height = '100vh';
            
            // Ensure Nav is hidden (Studio covers everything)
            document.querySelector('nav').style.display = 'none';
            
            document.getElementById('sidebar').classList.remove('mobile-open');
            switchStudioTab('dashboard');
        }

        // --- PERSONAL CONTENT HUB LOGIC ---
        // Accepts a parameter to switch to a specific sub-view immediately
        window.openProfileHub = (subView = 'main') => {
            if (!user) return window.openAuth();

            // Close other views
            closeWatch();
            document.getElementById('studio-view').style.display = 'none';
            document.getElementById('mobile-search-overlay').classList.remove('active');
            document.getElementById('mobile-notif-view').style.display = 'none';
            
            // Show Hub
            const hub = document.getElementById('profile-hub-view');
            hub.style.display = 'block';
            
            // Make it Full Screen & Hide main nav
            hub.style.top = '0';
            hub.style.height = '100vh';
            document.body.classList.remove('history-mode');
            const nav = document.querySelector('nav');
            if (nav) nav.style.display = 'none';

            const phContent = document.querySelector('#profile-hub-view .ph-content');

            // --- MAIN HUB VIEW ---
            if (subView === 'main') {
                // Restore the default HTML structure (if it was overwritten by another sub-view)
                phContent.innerHTML = `
                    <!-- NEW PROFILE BLOCK (Like Screenshot) -->
                    <div class="ph-profile-block">
                        <img id="ph-large-avatar" src="" class="ph-large-avatar">
                        <h2 class="ph-main-name" id="ph-main-name">Username</h2>
                        <div class="ph-handle-row">
                            <span id="ph-main-handle">@handle</span>
                            <span></span>
                            <span class="ph-view-channel-link" onclick="openStudio()">View channel</span>
                        </div>
                    </div>

                    <!-- NEW ACTIONS ROW (Like Screenshot) -->
                    <div class="ph-actions-row">
                         <!-- Sign Out button -->
                         <button class="ph-action-pill" onclick="handleLogout()">
                            <span class="material-symbols-rounded">logout</span>
                            <span>Sign Out</span>
                        </button>
                         <!-- Incognito button -->
                         <button class="ph-action-pill" onclick="alert('Incognito mode coming soon')">
                            <img 
                                class="ph-action-icon-img" 
                                src="./incognito-icon.png"
                            >
                            <span>Turn on Incognito</span>
                        </button>
                    </div>


                    <!-- History Section (Existing) -->
                    <div class="ph-section">
                        <div class="ph-section-header">
                            <span class="ph-title">History</span>
                            <button class="ph-view-all" onclick="openHistory()">View all</button>
                        </div>
                        <div class="ph-scroll-box" id="ph-history-list">
                            <!-- JS will populate -->
                        </div>
                    </div>

                    <!-- Playlists Section (Existing) -->
                    <div class="ph-section">
                        <div class="ph-section-header">
                            <span class="ph-title">Playlists</span>
                            <button class="ph-view-all" onclick="openLikedVideos()">View all</button>
                        </div>
                        <div class="ph-scroll-box" id="ph-playlist-list">
                           <div class="ph-vid-card" onclick="openLikedVideos()">
                               <div class="ph-vid-thumb-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                   <span class="material-symbols-rounded" style="font-size:32px; color:white;">thumb_up</span>
                               </div>
                               <div class="ph-vid-title">Liked Videos</div>
                               <div class="ph-vid-meta" id="ph-liked-count">...</div>
                           </div>
                           <div class="ph-vid-card" onclick="alert('Watch Later feature coming soon!')">
                               <div class="ph-vid-thumb-box" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">
                                   <span class="material-symbols-rounded" style="font-size:32px; color:white;">schedule</span>
                               </div>
                               <div class="ph-vid-title">Watch Later</div>
                               <div class="ph-vid-meta">0 videos</div>
                           </div>
                        </div>
                    </div>

                    <!-- Menu Links (Existing) -->
                    <div class="ph-menu-list">
                        <div class="ph-menu-item" onclick="openStudio()">
                            <span class="material-symbols-rounded ph-menu-icon" style="color:var(--accent-red);">play_circle</span>
                            <div style="flex:1;">Your Videos</div>
                            <span class="material-symbols-rounded" style="color:var(--text-light);">chevron_right</span>
                        </div>
                        <div class="ph-menu-item" onclick="openProfileHub('downloads')">
                            <span class="material-symbols-rounded ph-menu-icon">download</span>
                            <div style="flex:1;">Downloads</div>
                            <span class="material-symbols-rounded" style="color:var(--text-light);">chevron_right</span>
                        </div>
                        <div class="ph-menu-item" onclick="alert('Help center coming soon')">
                            <span class="material-symbols-rounded ph-menu-icon">help</span>
                            <div style="flex:1;">Help & Feedback</div>
                        </div>
                    </div>
                `;
                
                // 1. --- Populate NEW Profile Block ---
                const name = user.displayName || user.email.split('@')[0];
                const handle = "@" + name.replace(/\s/g, '').toLowerCase();
                const avatar = user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=random`;
                
                document.getElementById('ph-main-name').innerText = name;
                document.getElementById('ph-main-handle').innerText = handle;
                document.getElementById('ph-large-avatar').src = avatar;

                // 2. Fetch & Render History (Horizontal)
                const histList = document.getElementById('ph-history-list');
                histList.innerHTML = '<div class="skeleton" style="width:160px; height:90px; border-radius:8px;"></div>';
                
                get(ref(db, `users/${user.uid}/history`)).then(snap => {
                    const data = snap.val();
                    histList.innerHTML = "";
                    
                    if (!data) {
                        histList.innerHTML = `<div style="font-size:13px; color:var(--text-light); padding:10px;">No watch history yet.</div>`;
                        return;
                    }

                    const historyItems = Object.values(data)
                        .sort((a, b) => b.timestamp - a.timestamp)
                        .slice(0, 10);

                    historyItems.forEach(h => {
                        const v = allVideos[h.videoId];
                        if (v) {
                            const isS = isShort(v);
                            const imgStyle = isS 
                                ? "width: auto; height: 100%; aspect-ratio:9/16;" 
                                : "width: 100%; height: 100%; object-fit: cover;"; 

                            histList.innerHTML += `
                                <div class="ph-vid-card" onclick="handleVideoClick('${h.videoId}')">
                                    <div class="ph-vid-thumb-box">
                                        <img src="${v.thumbnail}" style="${imgStyle}">
                                        ${!isS ? `<div style="position:absolute; bottom:4px; right:4px; background:rgba(0,0,0,0.8); color:white; font-size:10px; padding:2px 4px; border-radius:4px;">${v.duration}</div>` : ''}
                                    </div>
                                    <div class="ph-vid-title">${v.title}</div>
                                    <div class="ph-vid-meta">${v.uploader}</div>
                                </div>
                            `;
                        }
                    });
                });

                // 3. Fetch and Display Liked Videos Count
                const likedCountEl = document.getElementById('ph-liked-count');
                if (likedCountEl) {
                    likedCountEl.innerText = '...'; // Set loading state
                    get(ref(db, 'likes')).then(snap => {
                        const likesMap = snap.val() || {};
                        const myLikedIds = [];
                        Object.entries(likesMap).forEach(([vidId, usersWhoLiked]) => {
                            if (usersWhoLiked && usersWhoLiked[user.uid]) {
                                myLikedIds.push(vidId);
                            }
                        });

                        // Filter out likes for deleted videos
                        const validLikedCount = myLikedIds.filter(id => allVideos[id]).length;
                        
                        likedCountEl.innerText = `${validLikedCount} videos`;
                    });
                }
            }

            // --- DOWNLOADS SUB-VIEW ---
            if (subView === 'downloads') {
                handleDownloadClick(); // This function will now be responsible for setting the HTML
            }
        }

        // --- OLD handleDownloadClick is now responsible ONLY for rendering the list content ---
        window.handleDownloadClick = () => {
            const downloads = JSON.parse(localStorage.getItem('yt_downloads')) || [];
            
            // 1. Create a simple overlay or list view
            let html = `
                <div style="padding: 16px; min-height: 100vh;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom: 20px;">
                        <button class="icon-btn" onclick="openProfileHub('main')"><span class="material-symbols-rounded">arrow_back</span></button>
                        <div style="font-size: 24px; font-weight: 700; color: var(--text-main);">Downloads</div>
                        ${downloads.length > 0 ? `<button class="ph-action-pill" style="margin-left:auto;" onclick="clearDownloads()">
                            <span class="material-symbols-rounded">delete</span> Clear All
                        </button>` : ''}
                    </div>
            `;

            if (downloads.length === 0) {
                html += `<div style="text-align:center; color:var(--text-light); padding: 40px;">No videos marked for download.</div>`;
            } else {
                downloads.forEach(id => {
                    const v = allVideos[id];
                    if (v) {
                        html += `
                            <div class="mn-item" style="padding-left:0; padding-right:0; margin-bottom:10px;">
                                <img src="${v.thumbnail}" class="mn-thumb" style="width:100px; height:56px; object-fit:cover;">
                                <div class="mn-content" style="gap:4px;">
                                    <div class="mn-text" style="-webkit-line-clamp: 2; font-weight:600;">${v.title}</div>
                                    <div class="mn-time">${v.uploader}  ${v.duration}</div>
                                </div>
                                <div style="display:flex; gap:10px; flex-shrink:0;">
                                    <button class="icon-btn" onclick="startVideoDownload('${v.videoUrl}', '${v.title.replace(/[^a-z0-9]/gi, '_')}.mp4')"><span class="material-symbols-rounded" style="color:var(--primary);">download</span></button>
                                    <button class="icon-btn" onclick="removeDownloadItem('${id}')"><span class="material-symbols-rounded" style="color:var(--accent-red);">close</span></button>
                                </div>
                            </div>
                        `;
                    }
                });
            }

            html += `</div>`;
            
            // 2. Overwrite the hub content with the Downloads list
            const phContent = document.querySelector('#profile-hub-view .ph-content');
            if (phContent) phContent.innerHTML = html;
        }
// --- TRUE OFFLINE DOWNLOAD SYSTEM (IndexedDB) ---

let localDB; // Renamed to 'localDB' to avoid conflict with Firebase 'db'

// 1. INITIALIZE THE DATABASE (Call this on page load)
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('YourtubeDB', 1);

        request.onupgradeneeded = (event) => {
            const dbInstance = event.target.result;
            if (!dbInstance.objectStoreNames.contains('videos')) {
                dbInstance.createObjectStore('videos', { keyPath: 'id' });
            }
        };

        request.onsuccess = (event) => {
            localDB = event.target.result; // Store in localDB
            resolve(localDB);
        };

        request.onerror = (event) => {
            console.error("IndexedDB error:", event.target.errorCode);
            reject(event.target.error);
        };
    });
}
// Initialize DB immediately
initDB();

// --- DATABASE HELPER FUNCTIONS ---
function saveVideoToDB(videoData) {
    return new Promise((resolve, reject) => {
        if (!localDB) return reject("Database not initialized.");
        const transaction = localDB.transaction(['videos'], 'readwrite');
        const store = transaction.objectStore('videos');
        const request = store.put(videoData);
        request.onsuccess = () => resolve();
        request.onerror = (e) => reject(e.target.error);
    });
}

function getVideoFromDB(videoId) {
    return new Promise((resolve, reject) => {
        if (!localDB) return reject("Database not initialized.");
        const transaction = localDB.transaction(['videos'], 'readonly');
        const store = transaction.objectStore('videos');
        const request = store.get(videoId);
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject(e.target.error);
    });
}

function getAllVideosFromDB() {
    return new Promise((resolve, reject) => {
        if (!localDB) return reject("Database not initialized.");
        const transaction = localDB.transaction(['videos'], 'readonly');
        const store = transaction.objectStore('videos');
        const request = store.getAll();
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject(e.target.error);
    });
}

function deleteVideoFromDB(videoId) {
    return new Promise((resolve, reject) => {
        if (!localDB) return reject("Database not initialized.");
        const transaction = localDB.transaction(['videos'], 'readwrite');
        const store = transaction.objectStore('videos');
        const request = store.delete(videoId);
        request.onsuccess = () => resolve();
        request.onerror = (e) => reject(e.target.error);
    });
}

async function isVideoDownloaded(videoId) {
    const video = await getVideoFromDB(videoId);
    return !!video; // Returns true if video exists in DB
}

// --- UI & CORE LOGIC ---

let isDownloading = false;

// Helper function for progress circle drawing
function drawProgress(canvas, percentage) {
    const ctx = canvas.getContext('2d');
    const x = canvas.width / 2;
    const y = canvas.height / 2;
    const radius = 10;
    const endAngle = (percentage / 100) * 2 * Math.PI;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, 2 * Math.PI);
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.lineWidth = 2.5;
    ctx.stroke();
    
    if (percentage > 0) {
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, endAngle);
        ctx.strokeStyle = 'var(--primary)';
        ctx.lineWidth = 2.5;
        ctx.stroke();
    }
}

// 2. MAIN ENTRY POINT: Handles toggle logic (Download vs Delete)
window.startDownloadProcess = async () => {
    if (!user) return window.openAuth();
    if (!currentVidId) return alert("No video selected.");

    if (await isVideoDownloaded(currentVidId)) {
        if (confirm("Remove this video from downloads?")) {
            await window.removeDownloadItem(currentVidId);
        }
        return;
    }

    if (isDownloading) return alert("A download is already in progress.");
    if (!allVideos[currentVidId]) return alert("Video data not loaded.");

    const v = allVideos[currentVidId];
    const url = v.videoUrl;

    const btn = document.getElementById('download-btn-watch');
    const iconSpan = document.getElementById('download-icon-span');
    const textSpan = document.getElementById('download-text-span');
    const canvas = document.getElementById('download-canvas');

    try {
        isDownloading = true;
        btn.disabled = true;
        canvas.style.display = 'block';
        iconSpan.style.display = 'none';
        textSpan.innerText = 'Starting...';

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        if (!response.body) throw new Error("ReadableStream not supported!");

        const totalSize = +response.headers.get('Content-Length');
        let loadedSize = 0;
        const chunks = [];
        const reader = response.body.getReader();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            chunks.push(value);
            loadedSize += value.length;

            if (totalSize > 0) {
                const percent = Math.round((loadedSize / totalSize) * 100);
                textSpan.innerText = `${percent}%`;
                drawProgress(canvas, percent);
            }
        }

        const videoBlob = new Blob(chunks, { type: 'video/mp4' });
        
        await saveVideoToDB({
            id: currentVidId,
            title: v.title,
            thumbnail: v.thumbnail,
            uploader: v.uploader,
            duration: v.duration,
            savedAt: Date.now(),
            blob: videoBlob // Store the actual video file
        });

    } catch (error) {
        console.error("Download failed:", error);
        alert(`Download failed: ${error.message}`);
    } finally {
        isDownloading = false;
        btn.disabled = false;
        await updateDownloadButtonState();
    }
};

// 3. STATE MANAGER: Updates the button UI based on IndexedDB
window.updateDownloadButtonState = async () => {
    const btn = document.getElementById('download-btn-watch');
    const iconSpan = document.getElementById('download-icon-span');
    const textSpan = document.getElementById('download-text-span');
    const canvas = document.getElementById('download-canvas');
    if (!btn) return;

    // Reset basics
    isDownloading = false;
    btn.disabled = false;
    canvas.style.display = 'none';
    iconSpan.style.display = 'block';

    if (currentVidId && await isVideoDownloaded(currentVidId)) {
        iconSpan.textContent = 'check_circle';
        iconSpan.style.color = 'var(--accent-green)';
        textSpan.innerText = 'Downloaded';
        btn.classList.add('active');
    } else {
        iconSpan.textContent = 'download';
        iconSpan.style.color = 'var(--text-main)';
        textSpan.innerText = 'Download';
        btn.classList.remove('active');
    }
};

// 4. DELETION LOGIC
window.removeDownloadItem = async (videoId) => {
    await deleteVideoFromDB(videoId);
    if (currentVidId === videoId) {
        await updateDownloadButtonState();
    }
    // Refresh the list if currently viewing the downloads page
    if (document.querySelector('#profile-hub-view .ph-content h2')?.innerText.includes('Downloads')) {
        await handleDownloadClick();
    }
};

window.clearDownloads = async () => {
    if (confirm("Are you sure you want to clear all downloaded videos?")) {
        const allDownloads = await getAllVideosFromDB();
        for (const video of allDownloads) {
            await deleteVideoFromDB(video.id);
        }
        await handleDownloadClick();
        if (currentVidId) await updateDownloadButtonState();
    }
};

// 5. RENDER THE DOWNLOADS LIST PAGE
window.handleDownloadClick = async () => {
    const videos = (await getAllVideosFromDB()).sort((a, b) => b.savedAt - a.savedAt);
    let contentHTML = "";

    if (videos.length === 0) {
        contentHTML = `
            <div style="text-align: center; color: var(--text-light); padding: 40px 20px; margin-top: 15vh;">
                <span class="material-symbols-rounded" style="font-size: 64px; opacity: 0.5;">download_for_offline</span>
                <p style="font-size: 14px; margin-top: 16px;">Videos you download will appear here and be playable offline.</p>
            </div>`;
    } else {
        let listItemsHTML = "";
        videos.forEach(v => {
            listItemsHTML += `
                <div class="mn-item" style="padding:12px 0; border-bottom:1px solid var(--border);" 
                     onclick="playOfflineVideo('${v.id}')">
                    <img src="${v.thumbnail}" class="mn-thumb" style="width:110px; height:62px; object-fit:cover; border-radius:8px;">
                    <div class="mn-content" style="margin-left:12px;">
                        <div class="mn-text" style="-webkit-line-clamp: 2; font-weight:600;">${v.title}</div>
                        <div class="mn-time">${v.uploader}  ${v.duration}</div>
                    </div>
                    <button class="icon-btn" style="margin-left:auto;" onclick="event.stopPropagation(); if(confirm('Remove this video?')) window.removeDownloadItem('${v.id}')">
                        <span class="material-symbols-rounded" style="color:var(--accent-red); font-size:20px;">delete_forever</span>
                    </button>
                </div>
            `;
        });
        contentHTML = `<div style="padding: 0 16px;">${listItemsHTML}</div>`;
    }

    const finalHTML = `
        <div style="background: var(--bg-body); min-height:100vh;">
            <div class="sr-header" style="position: sticky; top: 0; z-index: 10;">
                <button class="icon-btn" onclick="openProfileHub('main')"><span class="material-symbols-rounded">arrow_back</span></button>
                <h2 style="font-size: 20px; font-weight: 500; color: var(--text-main); margin-left: 16px;">Downloads</h2>
                ${videos.length > 0 ? `<button class="ph-action-pill" style="margin-left:auto;" onclick="clearDownloads()">
                    <span class="material-symbols-rounded">delete</span> Clear All
                </button>` : ''}
            </div>
            ${contentHTML}
        </div>
    `;

    const phContent = document.querySelector('#profile-hub-view .ph-content');
    if (phContent) phContent.innerHTML = finalHTML;
};

// 6. PLAY OFFLINE VIDEO
async function playOfflineVideo(videoId) {
    const videoData = await getVideoFromDB(videoId);
    if (!videoData) {
        alert("Could not find downloaded video.");
        return;
    }
    
    const blobUrl = URL.createObjectURL(videoData.blob);
    
    document.getElementById('profile-hub-view').style.display = 'none';
    openWatch(videoId, blobUrl);
}
        window.closeStudio = () => { 
            const studioView = document.getElementById('studio-view');
            studioView.style.display = 'none'; 
            
            // RESTORE HEADER (NAVBAR) when leaving "You" Screen
            document.querySelector('nav').style.display = 'flex';
            
            // Reset Overlay Styles
            studioView.style.top = '';
            studioView.style.height = '';
        }
        
        window.switchStudioTab = (tab) => {
            studioTab = tab;
            document.getElementById('std-dash-btn').classList.remove('active');
            document.getElementById('std-shorts-btn').classList.remove('active');
            document.getElementById('std-set-btn').classList.remove('active');
            
            if(tab === 'dashboard') {
                document.getElementById('std-dash-btn').classList.add('active');
                renderStudioTable();
            } else if (tab === 'shorts_analytics') {
                document.getElementById('std-shorts-btn').classList.add('active');
                renderShortsAnalyticsDashboard();
            } else {
                document.getElementById('std-set-btn').classList.add('active');
                renderStudioSettings();
            }
        }


        function renderStudioTable() {
            const container = document.getElementById('studio-content-area');
            const allMyContent = Object.entries(allVideos).filter(([_, v]) => v.uid === user.uid);
            const myVideos = allMyContent.filter(([_, v]) => !isShort(v)).reverse();
            
            let totalViews = 0;
            myVideos.forEach(([_, v]) => totalViews += (v.views || 0));

            let html = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="color:var(--black);">Channel Dashboard (Videos)</h2>
                    <button class="btn-primary" style="width:auto;" onclick="openChannelAnalytics()">View Channel Analytics</button>
                </div>
                <div class="st-stat-grid">
                    <div class="stat-box"><h2>${myVideos.length}</h2><p>Videos Uploaded</p></div>
                    <div class="stat-box"><h2>${formatViews(totalViews)}</h2><p>Total Video Views</p></div>
                </div>
                <div class="st-card">
                    <h3 style="margin-bottom:15px; color:var(--black);">Long-form Content</h3>
                    <table class="video-table">
                        <thead><tr><th width="50%">Video</th><th>Date</th><th>Views</th><th>Actions</th></tr></thead>
                        <tbody>
            `;
            if(myVideos.length === 0) html += `<tr><td colspan="4" style="text-align:center; color:var(--text-light);">No long-form videos uploaded yet.</td></tr>`;
            myVideos.forEach(([id, v]) => {
                html += `
                    <tr>
                        <td>
                            <div style="display:flex; gap:12px; align-items:center;">
                                <img src="${v.thumbnail}" style="width:100px; height:56px; border-radius:8px; object-fit:cover;">
                                <div><div style="font-weight:600; color:var(--text-main);">${v.title}</div><div style="color:gray; font-size:12px;">${v.duration||'--'}</div></div>
                            </div>
                        </td>
                        <td>${new Date(v.timestamp).toLocaleDateString()}</td>
                        <td>${v.views || 0}</td>
                        <td>
                            <button class="action-icon view" onclick="openAnalytics('${id}')" title="Analytics"><span class="material-symbols-rounded">analytics</span></button>
                            <button class="action-icon edit" onclick="openEdit('${id}')" title="Edit"><span class="material-symbols-rounded">edit</span></button>
                            <button class="action-icon delete" onclick="deleteVideo('${id}')" title="Delete"><span class="material-symbols-rounded">delete</span></button>
                        </td>
                    </tr>`;
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        async function renderShortsAnalyticsDashboard() {
            const container = document.getElementById('studio-content-area');
            container.innerHTML = `<h2>Loading Shorts Data...</h2>`;
            
            const myShorts = Object.entries(allVideos).filter(([id, v]) => v.uid === user.uid && isShort(v)).map(([id, v]) => ({...v, id})).sort((a,b) => (b.views || 0) - (a.views || 0));

            let totalViews = 0, totalLikes = 0, totalComments = 0;
            myShorts.forEach(s => totalViews += (s.views || 0));

            // Fetch likes and comments in parallel
            const [likesSnap, commentsSnap] = await Promise.all([
                get(ref(db, 'likes')),
                get(ref(db, 'comments'))
            ]);
            const allLikes = likesSnap.val() || {};
            const allComments = commentsSnap.val() || {};

            myShorts.forEach(s => {
                totalLikes += Object.keys(allLikes[s.id] || {}).length;
                totalComments += Object.keys(allComments[s.id] || {}).length;
            });

            let html = `
                <h2 style="color:var(--black); margin-bottom:20px;">Shorts Analytics</h2>
                <div class="st-stat-grid">
                    <div class="stat-box"><h2>${formatViews(totalViews)}</h2><p>Total Shorts Views</p></div>
                    <div class="stat-box"><h2>${formatViews(totalLikes)}</h2><p>Total Likes</p></div>
                    <div class="stat-box"><h2>${formatViews(totalComments)}</h2><p>Total Comments</p></div>
                </div>
                <div class="st-card">
                    <h3 style="margin-bottom:15px; color:var(--black);">Top Shorts</h3>
                    <table class="video-table">
                        <thead><tr><th width="40%">Short</th><th>Views</th><th>Likes</th><th>Comments</th><th>Actions</th></tr></thead>
                        <tbody>
            `;

            if (myShorts.length === 0) {
                html += `<tr><td colspan="5" style="text-align:center; color:var(--text-light);">No Shorts uploaded yet.</td></tr>`;
            } else {
                myShorts.forEach(s => {
                    const likes = Object.keys(allLikes[s.id] || {}).length;
                    const comments = Object.keys(allComments[s.id] || {}).length;
                    html += `
                    <tr>
                        <td>
                            <div style="display:flex; gap:12px; align-items:center;">
                                <img src="${s.thumbnail}" style="width:45px; height:80px; border-radius:6px; object-fit:cover;">
                                <div style="font-weight:600; color:var(--text-main);">${s.title}</div>
                            </div>
                        </td>
                        <td>${formatViews(s.views || 0)}</td>
                        <td>${formatViews(likes)}</td>
                        <td>${formatViews(comments)}</td>
                        <td>
                           <button class="action-icon view" onclick="alert('Individual Short analytics coming soon!')" title="Analytics"><span class="material-symbols-rounded">analytics</span></button>
                           <button class="action-icon edit" onclick="openEdit('${s.id}')" title="Edit"><span class="material-symbols-rounded">edit</span></button>
                        </td>
                    </tr>
                    `;
                });
            }

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }
        
        function renderStudioSettings() {
            const container = document.getElementById('studio-content-area');
            const isDark = document.body.classList.contains('dark-mode');
            container.innerHTML = `
                <h2 style="color:var(--black); margin-bottom:20px;">Profile & Settings</h2>
                <div class="st-card" style="max-width:600px;">
                    <div class="inp-group">
                        <label>Display Name</label>
                        <input type="text" id="prof-name" value="${user.displayName || ''}" placeholder="Enter your name">
                    </div>
                    <div class="inp-group">
                        <label>Profile Picture URL</label>
                        <input type="text" id="prof-pic" value="${user.photoURL || ''}" placeholder="https://...">
                    </div>
                    <div style="margin-bottom:20px;">
                         <label style="display:block; font-size:13px; color:var(--text-light); margin-bottom:6px; font-weight:600;">Theme Preference</label>
                         <select id="theme-select" onchange="applyTheme(this.value)">
                            <option value="light" ${!isDark ? 'selected' : ''}>Light Mode</option>
                            <option value="dark" ${isDark ? 'selected' : ''}>Dark Mode</option>
                         </select>
                    </div>
                    <button class="btn-primary" onclick="handleProfileUpdate()">Save Changes</button>
                </div>
            `;
        }
        
        window.handleProfileUpdate = async () => {
            const newName = document.getElementById('prof-name').value;
            const pic = document.getElementById('prof-pic').value;
            const oldName = user.displayName || user.email.split('@')[0];
            
            try {
                // 1. Update Firebase Auth Profile
                await updateProfile(auth.currentUser, { displayName: newName, photoURL: pic });
                
                // 2. Update existing videos with the new uploader name
                const videosRef = ref(db, 'videos');
                const videoSnap = await get(videosRef);
                const updates = {};
                
                if (videoSnap.exists()) {
                    videoSnap.forEach(childSnap => {
                        const video = childSnap.val();
                        // Check if the video belongs to the current user ID
                        if (video.uid === user.uid) {
                            // And check if the uploader name needs updating (optional check, safer)
                            if (video.uploader === oldName || video.uploader === user.email.split('@')[0]) {
                                updates[`/videos/${childSnap.key}/uploader`] = newName;
                            }
                        }
                    });
                }
                
                // 3. Commit batch updates if any videos were found
                if (Object.keys(updates).length > 0) {
                    await update(ref(db), updates);
                }

                alert("Profile and video channel names updated successfully!");
                location.reload();
            } catch (error) { alert("Error: " + error.message); }
        }
        
        window.applyTheme = (val) => {
            if(val === 'dark') { document.body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); } 
            else { document.body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); }
        }

        // --- ANALYTICS ---
        window.openAnalytics = async (id) => {
            const v = allVideos[id];
            document.getElementById('modal-heading').innerText = "Video Analytics";
            document.getElementById('an-title').innerText = v.title;
            document.getElementById('analytics-modal').style.display = 'flex';
            const snap = await get(ref(db, `analytics/${id}/views`));
            const viewData = snap.val() || {};
            const timestamps = Object.values(viewData).map(x => x.t);
            renderRealtimeChart(timestamps);
            renderPerformanceChart(timestamps);
        }

        // NEW: OVERALL CHANNEL ANALYTICS
        window.openChannelAnalytics = async () => {
             document.getElementById('modal-heading').innerText = "Channel Analytics";
             document.getElementById('an-title').innerText = "Overall Performance (All Videos)";
             document.getElementById('analytics-modal').style.display = 'flex';
             
             // Gather all video IDs for this user
             const myVideoIds = Object.keys(allVideos).filter(id => allVideos[id].uid === user.uid);
             
             let allTimestamps = [];
             
             // Fetch analytics for each video
             const promises = myVideoIds.map(id => get(ref(db, `analytics/${id}/views`)));
             const results = await Promise.all(promises);
             
             results.forEach(snap => {
                 const viewData = snap.val();
                 if(viewData) {
                     Object.values(viewData).forEach(x => allTimestamps.push(x.t));
                 }
             });
             
             renderRealtimeChart(allTimestamps);
             renderPerformanceChart(allTimestamps);
        }

        function renderRealtimeChart(timestamps) {
            const ctx = document.getElementById('realtimeChart').getContext('2d');
            if(charts['realtime']) charts['realtime'].destroy();

            const labels = [];
            const data = new Array(24).fill(0);
            const now = new Date();

            for (let i = 23; i >= 0; i--) {
                const d = new Date(now.getTime() - i * 3600000);
                const h = d.getHours();
                const ampm = h >= 12 ? 'PM' : 'AM';
                labels.push((h % 12 || 12) + ' ' + ampm);
            }

            timestamps.forEach(t => {
                const diffMs = now.getTime() - t;
                if(diffMs < 0 || diffMs > 86400000) return; 
                const bucketIndex = 23 - Math.floor(diffMs / 3600000);
                if(bucketIndex >= 0 && bucketIndex < 24) data[bucketIndex]++;
            });

            charts['realtime'] = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Views', data: data, backgroundColor: '#00c851', borderRadius: 4, barPercentage: 0.6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid:{display:false} }, y: { display:false, grid:{display:false} } } }
            });
        }

        function renderPerformanceChart(timestamps) {
            const ctx = document.getElementById('perfChart').getContext('2d');
            if(charts['perf']) charts['perf'].destroy();
            const dayCounts = {};
            timestamps.forEach(t => {
                const day = new Date(t).toLocaleDateString();
                dayCounts[day] = (dayCounts[day] || 0) + 1;
            });
            const labels = Object.keys(dayCounts).sort((a,b) => new Date(a) - new Date(b));
            const data = [];
            let sum = 0;
            labels.forEach(l => { sum += dayCounts[l]; data.push(sum); });
            if(data.length === 0) { labels.push('Today'); data.push(0); }
            charts['perf'] = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Total Views', data: data, borderColor: '#065fd4', backgroundColor: 'rgba(6, 95, 212, 0.1)', fill: true, tension: 0.4, pointRadius:3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales:{ x:{grid:{display:false}}, y:{grid:{color:'#f0f0f0'}} } }
            });
        }
// --- NEW HELPER: Seconds ko MM:SS mein convert karne ke liye ---
        function formatDurationFromSeconds(seconds) {
            if (!seconds) return "00:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            // Example: 65 seconds -> 01:05
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
function uploadFileWithProgress(file, resourceType = 'auto') {
    // --- APNI DETAILS YAHAN LIKHEIN ---
    const CLOUD_NAME = "ddm8su6st";
    const UPLOAD_PRESET = "yourtube_videos";
    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${resourceType}/upload`;

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    // Get Progress Bar Elements
    const progressWrapper = document.getElementById('progress-wrapper');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    // Show the progress bar before starting
    progressWrapper.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.innerText = `Uploading ${resourceType}... 0%`;

    return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);

        // --- THE MAGIC: This function is called periodically during upload ---
        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressText.innerText = `Uploading ${resourceType}... ${percentComplete}%`;
            }
        };

        // When the upload is finished
        xhr.onload = function() {
            if (this.status >= 200 && this.status < 300) {
                const data = JSON.parse(this.responseText);
                // Resolve the promise with the data Cloudinary sent back
                resolve({
                    url: data.secure_url,
                    duration: data.duration
                });
            } else {
                // The upload failed
                const errorData = JSON.parse(this.responseText);
                const errorMessage = errorData.error ? errorData.error.message : "Unknown upload error";
                reject(new Error(errorMessage));
            }
        };

        // If a network error occurs
        xhr.onerror = function() {
            reject(new Error("Network error occurred during upload."));
        };

        xhr.send(formData);
    });
}
        window.handleUploadClick = () => {
            if(!user) return window.openAuth();
            document.getElementById('modal-title').innerText = "Upload Video";
            document.getElementById('inp-id').value = "";
            document.getElementById('inp-title').value = "";
            document.getElementById('inp-thumb').value = "";
            document.getElementById('inp-url').value = "";
            document.getElementById('inp-dur').value = "";
            document.getElementById('inp-desc').value = "";
            
            // NEW: Populate category select with a default value (e.g., 'Learning')
            populateCategorySelect('Learning'); 
            
            document.getElementById('generic-modal').style.display = 'flex';
        }
        window.openEdit = (id) => {
            const v = allVideos[id];
            document.getElementById('modal-title').innerText = "Edit Video";
            document.getElementById('inp-id').value = id;
            document.getElementById('inp-title').value = v.title;
            document.getElementById('inp-thumb').value = v.thumbnail;
            document.getElementById('inp-url').value = v.videoUrl;
            document.getElementById('inp-dur').value = v.duration;
            document.getElementById('inp-desc').value = v.description;
            
            // NEW: Populate category select with the video's current category
            populateCategorySelect(v.category || 'Learning'); 
            
            document.getElementById('generic-modal').style.display = 'flex';
        }

        window.submitVideoForm = async () => {
            const id = document.getElementById('inp-id').value;
            const thumbnailFile = document.getElementById('inp-thumb-file').files[0];
            const videoFile = document.getElementById('inp-video-file').files[0];

            // --- NEW: Client-Side Validation ---
            const MAX_THUMB_SIZE = 50 * 1024 * 1024; // Increased to 50 MB
            // Increased to 50 GB (Virtually unlimited for browser uploads)
            const MAX_VIDEO_SIZE = 50 * 1024 * 1024 * 1024; 

            if (thumbnailFile && thumbnailFile.size > MAX_THUMB_SIZE) {
                return alert(`Thumbnail is too large. Max size is ${MAX_THUMB_SIZE / 1024 / 1024} MB.`);
            }
            if (videoFile && videoFile.size > MAX_VIDEO_SIZE) {
                // Updated alert to show limit in GB
                return alert(`Video is too large. Max size is ${(MAX_VIDEO_SIZE / 1024 / 1024 / 1024).toFixed(0)} GB.`);
            }

            const modalBtn = document.getElementById('modal-btn');
            const progressWrapper = document.getElementById('progress-wrapper');
            modalBtn.disabled = true; // Disable button during the whole process

            try {
                let thumbnailUrl = document.getElementById('inp-thumb').value;
                let videoUrl = document.getElementById('inp-url').value;
                let duration = document.getElementById('inp-dur').value;

                // 1. Thumbnail Upload Logic (uses new progress function)
                if (thumbnailFile) {
                    const thumbData = await uploadFileWithProgress(thumbnailFile, 'image');
                    if (!thumbData) throw new Error("Thumbnail upload failed.");
                    thumbnailUrl = thumbData.url;
                }

                // 2. Video Upload Logic (uses new progress function)
                if (videoFile) {
                    const videoData = await uploadFileWithProgress(videoFile, 'video');
                    if (!videoData) throw new Error("Video upload failed.");
                    videoUrl = videoData.url;
                    duration = formatDurationFromSeconds(videoData.duration);
                    document.getElementById('inp-dur').value = duration;
                }
                
                // 3. Data Save Logic
                const channelName = user.displayName || user.email.split('@')[0];
                const data = {
                    title: document.getElementById('inp-title').value,
                    thumbnail: thumbnailUrl,
                    videoUrl: videoUrl,
                    duration: duration,
                    description: document.getElementById('inp-desc').value,
                    category: document.getElementById('inp-category').value, // <-- ADD THIS LINE
                    uploader: channelName,
                    uid: user.uid
                };

                if (!data.title || !data.videoUrl) {
                    return alert("Title and Video are required.");
                }

                if (id) {
                    await update(ref(db, `videos/${id}`), data);
                } else {
                    data.views = 0;
                    data.timestamp = Date.now();
                    await push(ref(db, 'videos'), data);
                }

                closeModals();

                // 4. Reset Inputs
                document.getElementById('inp-thumb-file').value = '';
                document.getElementById('inp-video-file').value = '';
                document.getElementById('inp-dur').value = '';

            } catch (error) {
                console.error("Submission failed:", error);
                alert(`An error occurred: ${error.message}`);
            } finally {
                // This block runs whether the upload succeeds or fails
                modalBtn.disabled = false;
                progressWrapper.style.display = 'none'; // Always hide progress bar at the end
            }
        }
        window.deleteVideo = (id) => {
            if (confirm("Are you sure you want to permanently delete this video? This action cannot be undone.")) {
                // 1. Remove the video itself
                remove(ref(db, `videos/${id}`));
                // 2. Remove associated likes
                remove(ref(db, `likes/${id}`));
                // 3. Remove associated analytics/views data
                remove(ref(db, `analytics/${id}`));
                // 4. Remove associated comments
                remove(ref(db, `comments/${id}`));

                // Optional: Notify user
                alert("Video and all associated data deleted.");
            }
        }
        window.openAuth = () => { document.getElementById('auth-modal').style.display = 'flex'; }
        window.closeModals = () => { document.querySelectorAll('.modal-wrap').forEach(el => el.style.display = 'none'); }
        
        // --- NEW: FORGOT PASSWORD LOGIC ---
        window.handleForgotPassword = async () => {
            const email = document.getElementById('auth-email').value;
            if (!email) {
                alert("Please enter your email address in the field above first.");
                return;
            }
            try {
    await sendPasswordResetEmail(auth, email);
    // Specifically warn them about the spam folder
    alert("Email sent! Please check your Inbox and SPAM folder."); 
} catch (error) {
                if (error.code === 'auth/user-not-found') {
                    alert("No account found with this email.");
                } else if (error.code === 'auth/invalid-email') {
                    alert("Please enter a valid email address.");
                } else {
                    alert("Error: " + error.message);
                }
            }
        }

        window.toggleAuthMode = () => {
            isLogin = !isLogin;
            document.getElementById('auth-heading').innerText = isLogin ? "Sign In" : "Register";
            document.getElementById('auth-submit').innerText = isLogin ? "Sign In" : "Register";
            document.getElementById('auth-toggle').innerText = isLogin ? "Create Account" : "Sign In";
        }
        window.performAuth = async () => {
    const email    = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-pass').value;

    if (!email || !password) {
        alert("Please enter both email and password");
        return;
    }

    try {
        if (isLogin) {
            // Attempt normal email/password sign-in
            await signInWithEmailAndPassword(auth, email, password);
        } else {
            // Attempt create new account
            await createUserWithEmailAndPassword(auth, email, password);
        }
        closeModals();
    } catch (error) {
        // 
        //           Handle account linking situation
        // 
        if (error.code === 'auth/account-exists-with-different-credential' ||
            error.code === 'auth/credential-already-in-use') {

            try {
                // Get the existing credential from Google popup
                const pendingCred = error.credential;           //  this is the key line
                const emailCred   = email;                      // the email user tried

                // Force sign in with Google again  this returns the existing user
                const result = await signInWithPopup(auth, googleProvider);

                // Now link the email/password credential to the existing Google account
                await linkWithCredential(result.user, pendingCred);

                alert("Account linked successfully! You can now sign in with email/password too.");
                closeModals();
            } catch (linkError) {
                console.error("Linking failed:", linkError);
                alert("Could not link accounts: " + linkError.message);
            }
        }
        else if (error.code === 'auth/wrong-password') {
            alert("Incorrect password. Please try again.");
        }
        else if (error.code === 'auth/user-not-found') {
            alert("No account found with this email.");
        }
        else {
            alert("Authentication error: " + error.message);
            console.error(error);
        }
    }
};
        window.handleGoogleLogin = async () => { try { await signInWithPopup(auth, googleProvider); closeModals(); } catch (error) { alert("Google Sign-In failed: " + error.message); } }
        window.handleLogout = () => { if(confirm("Logout?")) signOut(auth); }
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const mc = document.getElementById('main-content');
            
            // Only perform sidebar logic on desktop (over 768px)
            if (window.innerWidth > 768) { 
                sb.classList.toggle('closed'); 
                mc.classList.toggle('full'); 
            }
            // Mobile: No action is taken, as the menu button is now hidden via CSS.
        }
        window.toggleMobileSearch = () => {
            const nm = document.getElementById('nav-search-bar');
            if(window.innerWidth<=768) { nm.classList.toggle('show-search'); document.getElementById('back-search').style.display = nm.classList.contains('show-search')?'block':'none'; }
        }
        // --- NOTIFICATION & MENTION LOGIC ---
        window.toggleNotif = () => {
             if (window.innerWidth <= 768) {
                 openMobileNotifications();
             } else {
                 const d = document.getElementById('notif-dropdown');
                 d.style.display = d.style.display === 'flex' ? 'none' : 'flex';
                 document.getElementById('notif-badge').style.display = 'none';
             }
        }

        window.openMobileNotifications = () => {
            // Must use 'flex' to maintain the column layout
            document.getElementById('mobile-notif-view').style.display = 'flex';
            document.getElementById('notif-badge').style.display = 'none';
            // Default to 'All' tab when opening
            switchNotifTab('all');
        }

        // Switch between ALL and MENTIONS
        window.switchNotifTab = (tab) => {
            const list = document.getElementById('mn-list');
            list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-light);">Loading...</div>';

            const btnAll = document.getElementById('btn-notif-all');
            const btnMen = document.getElementById('btn-notif-mentions');

            if(tab === 'all') {
                // Style Active Button
                btnAll.classList.add('active');
                btnAll.style.background = 'var(--text-main)';
                btnAll.style.color = 'var(--bg-body)';
                btnAll.style.border = 'none';
                
                // Style Inactive Button
                btnMen.classList.remove('active');
                btnMen.style.background = 'var(--secondary)';
                btnMen.style.color = 'var(--text-main)';
                btnMen.style.border = '1px solid var(--border)';
                
                renderAllNotifs(); 
            } else {
                // Style Active Button
                btnMen.classList.add('active');
                btnMen.style.background = 'var(--text-main)';
                btnMen.style.color = 'var(--bg-body)';
                btnMen.style.border = 'none';
                
                // Style Inactive Button
                btnAll.classList.remove('active');
                btnAll.style.background = 'var(--secondary)';
                btnAll.style.color = 'var(--text-main)';
                btnAll.style.border = '1px solid var(--border)';
                
                renderMentionNotifs(); 
            }
        }

        function renderAllNotifs() {
            const list = document.getElementById('mn-list');
            list.innerHTML = "";
            
            // Get all videos
            const videos = Object.entries(allVideos).reverse();
            
            if (videos.length === 0) {
                list.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-light);">No notifications</div>`;
                return;
            }

            list.innerHTML += `<div class="mn-section-title">Recent Uploads</div>`;
            videos.forEach(([id, v], index) => {
                // Show dot for first 3 items
                renderNotificationItem(list, id, v, index < 3); 
            });
        }

        function renderMentionNotifs() {
            const list = document.getElementById('mn-list');
            
            if (!user) {
                list.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-light);">Sign in to see mentions</div>`;
                return;
            }

            const myName = user.displayName || user.email.split('@')[0];
            
            // Fetch mentions from Firebase node: mentions/MyName
            get(ref(db, 'mentions/' + myName)).then(snap => {
                const data = snap.val();
                list.innerHTML = "";
                
                if (!data) {
                    list.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-light);">No mentions yet</div>`;
                    return;
                }

                const mentions = Object.values(data).reverse();

                mentions.forEach(m => {
                    list.innerHTML += `
                        <div class="mn-item" onclick="handleNotificationClick('${m.videoId}')">
                            <div class="mn-dot"></div>
                            <img src="${m.fromAvatar}" class="mn-avatar">
                            <div class="mn-content">
                                <div class="mn-text">
                                    <span style="font-weight:600">@${m.fromUser}</span> mentioned you: "${m.commentText}"
                                </div>
                                <div class="mn-time" style="font-size:12px; color:var(--text-light); margin-top:2px;">
                                    on ${m.videoTitle}  ${timeAgo(m.timestamp)}
                                </div>
                            </div>
                            <div style="width:40px; height:40px; display:flex; align-items:center; justify-content:center;">
                                <span class="material-symbols-rounded" style="color:var(--text-light);">comment</span>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function renderNotificationItem(container, id, v, showDot) {
            const avatarUrl = `https://ui-avatars.com/api/?name=${v.uploader}&background=random`;
            const isS = isShort(v);
            
            // Set fixed dimensions for the thumbnail slot (86px wide, 48px high).
            // Use object-fit: contain for Shorts to display the vertical image fully within this slot.
            const thumbStyle = isS 
                ? "width: 86px; height: 48px; object-fit: contain; background: #000;" 
                : "width: 86px; height: 48px; object-fit: cover;";

            container.innerHTML += `
                <div class="mn-item" onclick="handleNotificationClick('${id}')">
                    ${showDot ? '<div class="mn-dot"></div>' : ''}
                    <img src="${avatarUrl}" class="mn-avatar">
                    <div class="mn-content">
                        <div class="mn-text">
                            <span style="font-weight:600">${v.uploader}</span> uploaded: ${v.title}
                        </div>
                        <div class="mn-time">${timeAgo(v.timestamp)}</div>
                    </div>
                    <!-- Applied fixed size and dynamic object-fit style here -->
                    <img src="${v.thumbnail}" class="mn-thumb" style="${thumbStyle} border-radius: 8px;" onerror="this.src='https://via.placeholder.com/86x48'">
                    <div class="mn-menu" onclick="event.stopPropagation(); alert('Options')">
                        <span class="material-symbols-rounded" style="font-size:20px;">more_vert</span>
                    </div>
                </div>
            `;
        }

        window.handleNotificationClick = (id) => {
            document.getElementById('mobile-notif-view').style.display = 'none';
            // handleVideoClick automatically decides whether to open Shorts Viewer or Normal Player
            handleVideoClick(id); 
        }
        function formatViews(n) { if(n>=1000000)return(n/1000000).toFixed(1)+'M'; if(n>=1000)return(n/1000).toFixed(1)+'K'; return n; }
        function timeAgo(ts) { const s=Math.floor((Date.now()-ts)/1000); if(s<60)return'Just now'; const m=Math.floor(s/60); if(m<60)return m+' mins ago'; const h=Math.floor(m/60); if(h<24)return h+' hours ago'; const d=Math.floor(h/24); return d+' days ago'; }
        window.onclick = (e) => { if(e.target.classList.contains('modal-wrap')) closeModals(); }

        // --- BOTTOM NAV LOGIC ---
        window.updateBottomNav = (element) => {
            // Check if the button being clicked is the one that opens the Shorts feed.
            const isOpeningShorts = element.getAttribute('onclick').includes('openShortsFeed');

            // CRITICAL FIX: If the shorts viewer is open AND the user is clicking a DIFFERENT button
            // (like Home or Subscriptions), then close the viewer.
            if (document.getElementById('shorts-view').style.display === 'block' && !isOpeningShorts) {
                closeShortsViewer();
            }

            document.querySelectorAll('.b-nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }

        // --- NEW: Global variable to hold subscription videos for filtering
        let cachedSubVideos = [];

        // --- NEW: Helper to check if a timestamp is from today
        const isToday = (timestamp) => {
            const today = new Date();
            const someDate = new Date(timestamp);
            return someDate.getDate() == today.getDate() &&
                someDate.getMonth() == today.getMonth() &&
                someDate.getFullYear() == today.getFullYear();
        }

        window.openSubscriptionsPage = () => {
            if(!user) return window.openAuth();
            
            // 1. Reset UI
            closeWatch(); 
            closeStudio();
            document.body.classList.remove('history-mode');
            document.querySelector('nav').style.display = 'flex';
            
            // FIX: Close Overlays
            document.getElementById('profile-hub-view').style.display = 'none';
            document.getElementById('mobile-notif-view').style.display = 'none';
            
            document.getElementById('page-heading').style.display = "none";
            document.getElementById('category-bar').style.display = 'none';
            
            if(window.innerWidth <= 768) {
                document.querySelectorAll('.b-nav-item').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.b-nav-item')[3].classList.add('active');
            }

            // 2. Loading State
            grid.innerHTML = '<div class="skeleton sk-card" style="grid-column:1/-1;"></div>';

            // 3. Fetch Data
            get(ref(db, `users/${user.uid}/subscriptions`)).then(snap => {
                const subs = snap.val();
                
                if(!subs) {
                    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px 20px;"><span class="material-symbols-rounded" style="font-size:48px; color:var(--text-light); margin-bottom:16px;">subscriptions</span><h3 style="margin-bottom:8px;">Don't miss new videos</h3><p style="color:var(--text-light); font-size:14px;">Channels you subscribe to will appear here.</p></div>`;
                    return;
                }

                const subNames = Object.keys(subs);
                
                // 4. Filter, Sort, and CACHE the videos
                cachedSubVideos = [];
                Object.entries(allVideos).forEach(([id, v]) => {
                    if(subNames.includes(v.uploader)) {
                        cachedSubVideos.push({...v, id: id});
                    }
                });
                cachedSubVideos.sort((a,b) => b.timestamp - a.timestamp);

                // 5. Build the static header parts
                let headerHTML = `<div class="sub-header-wrapper"> <div class="sub-scroll-container">`;
                subNames.forEach(name => {
                    headerHTML += `<div class="sub-avatar-item"><div class="sub-img-box"><img src="https://ui-avatars.com/api/?name=${name}&background=random&color=fff" class="sub-img-actual"><div class="sub-notif-dot"></div></div><span class="sub-name-label">${name}</span></div>`;
                });
                headerHTML += `<div class="sub-all-link" onclick="goHome()">All</div></div></div>`;
                
                headerHTML += `
                    <div class="sub-filter-bar" id="sub-filter-bar">
                        <button class="sub-filter-pill active" onclick="applySubscriptionFilter('All')">All</button>
                        <button class="sub-filter-pill" onclick="applySubscriptionFilter('Today')">Today</button>
                        <button class="sub-filter-pill" onclick="applySubscriptionFilter('Videos')">Videos</button>
                        <button class="sub-filter-pill" onclick="applySubscriptionFilter('Shorts')">Shorts</button>
                    </div>`;

                // 6. Inject Header and trigger the initial render
                grid.innerHTML = headerHTML;
                applySubscriptionFilter('All');
            });
        }

        // --- NEW: This function applies the filter and calls the display function ---
        window.applySubscriptionFilter = (filterType) => {
            // Update active button UI
            document.querySelectorAll('#sub-filter-bar .sub-filter-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.innerText === filterType) pill.classList.add('active');
            });

            let videosToRender = [...cachedSubVideos];

            // Apply main filter logic
            if (filterType === 'Today') {
                videosToRender = videosToRender.filter(v => isToday(v.timestamp));
            } else if (filterType === 'Videos') {
                videosToRender = videosToRender.filter(v => !isShort(v));
            } else if (filterType === 'Shorts') {
                videosToRender = videosToRender.filter(v => isShort(v));
            }
            
            // Separate into shorts and regular videos
            const shorts = videosToRender.filter(v => isShort(v));
            const regularVideos = videosToRender.filter(v => !isShort(v));
            
            // Call the function that actually builds the HTML
            displaySubscriptionContent(shorts, regularVideos, filterType);
        }

        // --- FINAL VERSION: This function renders ONE shorts shelf on top ---
        function displaySubscriptionContent(shorts, regularVideos, filterType) {
            let videoContainer = document.getElementById('sub-video-container');
            if (!videoContainer) {
                videoContainer = document.createElement('div');
                videoContainer.id = 'sub-video-container';
                grid.appendChild(videoContainer);
            }

            // Helper to generate the Home-style shorts shelf
            const createHomepageShortsShelf = (shortsList) => {
                if (!shortsList || shortsList.length === 0) return "";
                let shelfHTML = `
                <div class="shorts-shelf" style="grid-column: 1 / -1;">
                    <div class="shorts-shelf-title">
                        <span class="material-symbols-rounded">slow_motion_video</span>
                        <span>Shorts</span>
                    </div>
                    <div class="shorts-scroll-container">`;
                shortsList.forEach(s => {
                    shelfHTML += `
                        <div class="short-card" onclick="handleVideoClick('${s.id}')">
                            <img src="${s.thumbnail}" loading="lazy" onerror="this.src='https://via.placeholder.com/360x640'">
                            <div class="short-card-overlay">
                                <div class="short-card-title">${s.title}</div>
                                <div class="short-card-views">${formatViews(s.views || 0)} views</div>
                            </div>
                        </div>`;
                });
                shelfHTML += `</div></div>`;
                return shelfHTML;
            };

            let finalHTML = "";

            // --- REVISED LOGIC ---
            
            // 1. Build the single Shorts shelf first (for 'All' and 'Today' filters)
            if (filterType === 'All' || filterType === 'Today') {
                if (shorts.length > 0) {
                    finalHTML += createHomepageShortsShelf(shorts);
                }
            } 
            // If filter is 'Shorts' only, it's the same as the above case
            else if (filterType === 'Shorts') {
                 if (shorts.length > 0) {
                    finalHTML += createHomepageShortsShelf(shorts);
                }
            }

            // 2. Build the grid of regular videos (for 'All', 'Today', and 'Videos' filters)
            if (filterType === 'All' || filterType === 'Today' || filterType === 'Videos') {
                if (regularVideos.length > 0) {
                    regularVideos.forEach(v => {
                        finalHTML += `
                            <div class="card" onclick="handleVideoClick('${v.id}')">
                                <div class="thumb-box"><img src="${v.thumbnail}" loading="lazy" onerror="this.src='https://via.placeholder.com/640x360'"><div class="dur-badge">${v.duration || '00:00'}</div></div>
                                <div class="meta-flex"><img src="https://ui-avatars.com/api/?name=${v.uploader}&background=random" class="chn-avatar"><div class="meta-text"><h3>${v.title}</h3><p>${v.uploader}</p><p>${formatViews(v.views)} views  ${timeAgo(v.timestamp)}</p></div></div>
                            </div>`;
                    });
                }
            }

            // 3. Handle the empty state at the very end
            if (finalHTML === "") {
                finalHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-light);">No ${filterType.toLowerCase()} from your subscriptions.</div>`;
            }
            
            videoContainer.innerHTML = `<div class="grid">${finalHTML}</div>`;
        }
// --- INITIALIZATION: FORCE HOME ON START ---
        // This ensures Home is default and all overlays are hidden on load
        document.addEventListener('DOMContentLoaded', () => {
            // FIX: This removes the hiding class, making the body visible and preventing any flash
            document.body.classList.remove('body-loading');

            // Simulate a click on Home to reset all UI states
            goHome();
            
            // Ensure Bottom Nav reflects Home is active
            const homeBtn = document.querySelector('.bottom-nav .b-nav-item:first-child');
            if(homeBtn) {
                document.querySelectorAll('.b-nav-item').forEach(el => el.classList.remove('active'));
                homeBtn.classList.add('active');
            }
        });
    </script>
</body>
</html>